# Meridian Console CI/CD Pipeline
# Security scanning enabled with SAST, SCA, Container, IaC, Secrets, SBOM
trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

pool:
  name: "Sandbox Servers Agents"

parameters:
  - name: servicesCsv
    type: string
    default: all
    displayName: 'Services to build (comma-separated). Leave blank = all.'
  - name: buildConfiguration
    type: string
    default: Release
  - name: runTests
    type: boolean
    default: true
  - name: collectCoverage
    type: boolean
    default: true
  - name: testInSingleJob
    type: boolean
    default: true
  - name: deploy
    type: boolean
    default: true
    displayName: 'Deploy release targets (non-PR)'
  - name: publishContainers
    type: boolean
    default: false
    displayName: 'Publish container images to ACR (costs money, non-PR only)'
  # Infrastructure and deployment parameters
  - name: environments
    type: stringList
    default:
      - dev
    displayName: 'Target environments (multi-select)'
    values:
      - localdev
      - dev
      - staging
      - prod
  - name: provisionInfrastructure
    type: boolean
    default: false
    displayName: 'Provision Azure infrastructure (Key Vaults, App Registrations)'
  - name: provisionDns
    type: boolean
    default: false
    displayName: 'Configure Cloudflare DNS records'

variables:
  - group: security-scanning
  # Uses the new `trim()` pipeline expression function (Sprint 248) to be resilient to whitespace.
  - name: servicesCsvNormalized
    ${{ if or(eq(trim(parameters.servicesCsv), ''), eq(lower(trim(parameters.servicesCsv)), 'all'), eq(trim(parameters.servicesCsv), '*')) }}:
      value: ',,'
    ${{ else }}:
      value: ${{ format(',{0},', replace(replace(trim(parameters.servicesCsv), ' ', ''), ';', ',')) }}
  - name: environmentsCsvNormalized
    # Convert stringList to normalized CSV format: ,item1,item2,item3,
    value: ${{ format(',{0},', join(',', parameters.environments)) }}

resources:
  repositories:
    - repository: pipelinePatterns
      type: github
      endpoint: github.com_SandboxServers
      name: SandboxServers/Azure-Pipeline-YAML
      ref: refs/heads/main

extends:
  template: Templates/Dhadgar.CI/Pipeline/Pipeline.yml@pipelinePatterns
  parameters:
    servicesCsvNormalized: ${{ variables.servicesCsvNormalized }}
    buildConfiguration: ${{ parameters.buildConfiguration }}
    runTests: ${{ parameters.runTests }}
    collectCoverage: ${{ parameters.collectCoverage }}
    testInSingleJob: ${{ parameters.testInSingleJob }}
    testTargetPath: 'Dhadgar.sln'
    deploy: ${{ parameters.deploy }}
    publishContainers: ${{ parameters.publishContainers }}
    # Infrastructure and deployment settings
    environmentsCsvNormalized: ${{ variables.environmentsCsvNormalized }}
    provisionInfrastructure: ${{ parameters.provisionInfrastructure }}
    provisionDns: ${{ parameters.provisionDns }}
    azureServiceConnection: 'meridian-rg-sc-2'
    acrServiceConnection: 'meridianconsoleacr'
    acrLoginServer: 'meridianconsoleacr-etdvg4cthscffqdf.azurecr.io'
    tenantId: $(AZURE_TENANT_ID)
    cloudflareApiToken: $(CLOUDFLARE_API_TOKEN)
    runSecurityScans: true
    nvdApiKey: $(NVD_API_KEY)
    services:
      # Agent binaries - distributed to customer hardware
      - id: Dhadgar.Agent.Core
        projectPath: src/Agents/Dhadgar.Agent.Core/Dhadgar.Agent.Core.csproj
        testProjectPath: tests/Dhadgar.Agent.Core.Tests/Dhadgar.Agent.Core.Tests.csproj
        deploy:  # Shared library, no deployment
      - id: Dhadgar.Agent.Linux
        projectPath: src/Agents/Dhadgar.Agent.Linux/Dhadgar.Agent.Linux.csproj
        testProjectPath: tests/Dhadgar.Agent.Linux.Tests/Dhadgar.Agent.Linux.Tests.csproj
        deploy:  # Disabled: agent deployment not needed yet
        # agent:
        #   runtimes: 'linux-x64'
        #   storageAccount: meridianconsoleblob
        #   containerName: agent-releases
      - id: Dhadgar.Agent.Windows
        projectPath: src/Agents/Dhadgar.Agent.Windows/Dhadgar.Agent.Windows.csproj
        testProjectPath: tests/Dhadgar.Agent.Windows.Tests/Dhadgar.Agent.Windows.Tests.csproj
        deploy:  # Disabled: agent deployment not needed yet
        # agent:
        #   runtimes: 'win-x64'
        #   storageAccount: meridianconsoleblob
        #   containerName: agent-releases
      # Microservices - deployed via Docker Compose to dev environment
      - id: Dhadgar.Billing
        projectPath: src/Dhadgar.Billing/Dhadgar.Billing.csproj
        testProjectPath: tests/Dhadgar.Billing.Tests/Dhadgar.Billing.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Cli
        projectPath: src/Dhadgar.Cli/Dhadgar.Cli.csproj
        testProjectPath: tests/Dhadgar.Cli.Tests/Dhadgar.Cli.Tests.csproj
        deploy:  # Disabled: CLI deployment not needed yet
        # cli:
        #   runtimes: 'win-x64;linux-x64;osx-x64'
        #   publishToGitHub: true
        #   storageAccount: meridianconsoleblob
        #   containerName: cli-releases
      - id: Dhadgar.Console
        projectPath: src/Dhadgar.Console/Dhadgar.Console.csproj
        testProjectPath: tests/Dhadgar.Console.Tests/Dhadgar.Console.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Discord
        projectPath: src/Dhadgar.Discord/Dhadgar.Discord.csproj
        testProjectPath: tests/Dhadgar.Discord.Tests/Dhadgar.Discord.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Files
        projectPath: src/Dhadgar.Files/Dhadgar.Files.csproj
        testProjectPath: tests/Dhadgar.Files.Tests/Dhadgar.Files.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Firewall
        projectPath: src/Dhadgar.Firewall/Dhadgar.Firewall.csproj
        testProjectPath: tests/Dhadgar.Firewall.Tests/Dhadgar.Firewall.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Gateway
        projectPath: src/Dhadgar.Gateway/Dhadgar.Gateway.csproj
        testProjectPath: tests/Dhadgar.Gateway.Tests/Dhadgar.Gateway.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Identity
        projectPath: src/Dhadgar.Identity/Dhadgar.Identity.csproj
        testProjectPath: tests/Dhadgar.Identity.Tests/Dhadgar.Identity.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Mods
        projectPath: src/Dhadgar.Mods/Dhadgar.Mods.csproj
        testProjectPath: tests/Dhadgar.Mods.Tests/Dhadgar.Mods.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Nodes
        projectPath: src/Dhadgar.Nodes/Dhadgar.Nodes.csproj
        testProjectPath: tests/Dhadgar.Nodes.Tests/Dhadgar.Nodes.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Notifications
        projectPath: src/Dhadgar.Notifications/Dhadgar.Notifications.csproj
        testProjectPath: tests/Dhadgar.Notifications.Tests/Dhadgar.Notifications.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Scope
        projectPath: src/Dhadgar.Scope/Dhadgar.Scope.csproj
        testProjectPath: tests/Dhadgar.Scope.Tests/Dhadgar.Scope.Tests.csproj
        deploy: swa
        swa:
          apiTokenVar: Dhadgar_Swa_ApiToken
          appLocation: src/Dhadgar.Scope
          outputLocation: _swa_publish/wwwroot
          appBuildCommand: npm install && npm run build
      - id: Dhadgar.ShoppingCart
        projectPath: src/Dhadgar.ShoppingCart/Dhadgar.ShoppingCart.csproj
        testProjectPath: tests/Dhadgar.ShoppingCart.Tests/Dhadgar.ShoppingCart.Tests.csproj
        deploy: swa
        swa:
          apiTokenVar: Dhadgar_ShoppingCart_Swa_ApiToken
          appLocation: src/Dhadgar.ShoppingCart
          outputLocation: _swa_publish/wwwroot
          appBuildCommand: npm install && npm run build
      - id: Dhadgar.Secrets
        projectPath: src/Dhadgar.Secrets/Dhadgar.Secrets.csproj
        testProjectPath: tests/Dhadgar.Secrets.Tests/Dhadgar.Secrets.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Servers
        projectPath: src/Dhadgar.Servers/Dhadgar.Servers.csproj
        testProjectPath: tests/Dhadgar.Servers.Tests/Dhadgar.Servers.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Tasks
        projectPath: src/Dhadgar.Tasks/Dhadgar.Tasks.csproj
        testProjectPath: tests/Dhadgar.Tasks.Tests/Dhadgar.Tasks.Tests.csproj
        deploy:  # Disabled: runs locally on Docker Desktop
      - id: Dhadgar.Panel
        projectPath: src/Dhadgar.Panel/Dhadgar.Panel.csproj
        testProjectPath: tests/Dhadgar.Panel.Tests/Dhadgar.Panel.Tests.csproj
        deploy:  # TODO: Migrate to SWA when Panel is migrated to Astro
      # Shared libraries - no deployment
      - id: Dhadgar.Contracts
        projectPath: src/Shared/Dhadgar.Contracts/Dhadgar.Contracts.csproj
        testProjectPath: tests/Dhadgar.Contracts.Tests/Dhadgar.Contracts.Tests.csproj
        deploy:
      - id: Dhadgar.Messaging
        projectPath: src/Shared/Dhadgar.Messaging/Dhadgar.Messaging.csproj
        testProjectPath: tests/Dhadgar.Messaging.Tests/Dhadgar.Messaging.Tests.csproj
        deploy:
      - id: Dhadgar.ServiceDefaults
        projectPath: src/Shared/Dhadgar.ServiceDefaults/Dhadgar.ServiceDefaults.csproj
        testProjectPath: tests/Dhadgar.ServiceDefaults.Tests/Dhadgar.ServiceDefaults.Tests.csproj
        deploy:
      - id: Dhadgar.Shared
        projectPath: src/Shared/Dhadgar.Shared/Dhadgar.Shared.csproj
        testProjectPath: tests/Dhadgar.Shared.Tests/Dhadgar.Shared.Tests.csproj
        deploy:
      - id: Dhadgar.Agent.Core.Tests
        projectPath: tests/Dhadgar.Agent.Core.Tests/Dhadgar.Agent.Core.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Agent.Linux.Tests
        projectPath: tests/Dhadgar.Agent.Linux.Tests/Dhadgar.Agent.Linux.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Agent.Windows.Tests
        projectPath: tests/Dhadgar.Agent.Windows.Tests/Dhadgar.Agent.Windows.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Billing.Tests
        projectPath: tests/Dhadgar.Billing.Tests/Dhadgar.Billing.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Cli.Tests
        projectPath: tests/Dhadgar.Cli.Tests/Dhadgar.Cli.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Console.Tests
        projectPath: tests/Dhadgar.Console.Tests/Dhadgar.Console.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Contracts.Tests
        projectPath: tests/Dhadgar.Contracts.Tests/Dhadgar.Contracts.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Discord.Tests
        projectPath: tests/Dhadgar.Discord.Tests/Dhadgar.Discord.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Files.Tests
        projectPath: tests/Dhadgar.Files.Tests/Dhadgar.Files.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Firewall.Tests
        projectPath: tests/Dhadgar.Firewall.Tests/Dhadgar.Firewall.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Gateway.Tests
        projectPath: tests/Dhadgar.Gateway.Tests/Dhadgar.Gateway.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Identity.Tests
        projectPath: tests/Dhadgar.Identity.Tests/Dhadgar.Identity.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Messaging.Tests
        projectPath: tests/Dhadgar.Messaging.Tests/Dhadgar.Messaging.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Mods.Tests
        projectPath: tests/Dhadgar.Mods.Tests/Dhadgar.Mods.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Nodes.Tests
        projectPath: tests/Dhadgar.Nodes.Tests/Dhadgar.Nodes.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Notifications.Tests
        projectPath: tests/Dhadgar.Notifications.Tests/Dhadgar.Notifications.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Scope.Tests
        projectPath: tests/Dhadgar.Scope.Tests/Dhadgar.Scope.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.ShoppingCart.Tests
        projectPath: tests/Dhadgar.ShoppingCart.Tests/Dhadgar.ShoppingCart.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Secrets.Tests
        projectPath: tests/Dhadgar.Secrets.Tests/Dhadgar.Secrets.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Servers.Tests
        projectPath: tests/Dhadgar.Servers.Tests/Dhadgar.Servers.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.ServiceDefaults.Tests
        projectPath: tests/Dhadgar.ServiceDefaults.Tests/Dhadgar.ServiceDefaults.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Shared.Tests
        projectPath: tests/Dhadgar.Shared.Tests/Dhadgar.Shared.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Tasks.Tests
        projectPath: tests/Dhadgar.Tasks.Tests/Dhadgar.Tasks.Tests.csproj
        testProjectPath: ''
        deploy:
      - id: Dhadgar.Panel.Tests
        projectPath: tests/Dhadgar.Panel.Tests/Dhadgar.Panel.Tests.csproj
        testProjectPath: ''
        deploy:
