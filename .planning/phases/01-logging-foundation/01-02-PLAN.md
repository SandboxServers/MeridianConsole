---
phase: 01-logging-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/Shared/Dhadgar.ServiceDefaults/Middleware/RequestLoggingMiddleware.cs
  - src/Shared/Dhadgar.ServiceDefaults/Middleware/TenantEnrichmentMiddleware.cs
  - src/Shared/Dhadgar.ServiceDefaults/Logging/RequestLoggingMessages.cs
  - src/Shared/Dhadgar.ServiceDefaults/ServiceDefaultsExtensions.cs
autonomous: true

must_haves:
  truths:
    - "All HTTP request/response logs use source-generated [LoggerMessage] methods"
    - "Every log entry within an HTTP request includes TenantId in scope"
    - "Every log entry includes ServiceName, ServiceVersion, and Hostname in scope"
    - "CorrelationId appears in all log entries for a given request"
  artifacts:
    - path: "src/Shared/Dhadgar.ServiceDefaults/Middleware/TenantEnrichmentMiddleware.cs"
      provides: "Middleware that adds tenant and service context to logging scope"
      exports: ["TenantEnrichmentMiddleware"]
    - path: "src/Shared/Dhadgar.ServiceDefaults/Logging/RequestLoggingMessages.cs"
      provides: "Source-generated log messages for HTTP requests"
      exports: ["RequestLoggingMessages"]
    - path: "src/Shared/Dhadgar.ServiceDefaults/ServiceDefaultsExtensions.cs"
      provides: "Updated extension to wire middleware pipeline"
      exports: ["AddDhadgarServiceDefaults", "UseDhadgarMiddleware"]
  key_links:
    - from: "src/Shared/Dhadgar.ServiceDefaults/Middleware/TenantEnrichmentMiddleware.cs"
      to: "src/Shared/Dhadgar.ServiceDefaults/MultiTenancy/OrganizationContext.cs"
      via: "IOrganizationContext injection"
      pattern: "IOrganizationContext.*OrganizationId"
    - from: "src/Shared/Dhadgar.ServiceDefaults/Middleware/RequestLoggingMiddleware.cs"
      to: "src/Shared/Dhadgar.ServiceDefaults/Logging/RequestLoggingMessages.cs"
      via: "calls to source-generated methods"
      pattern: "RequestLoggingMessages.*HttpRequest"
---

<objective>
Convert middleware to use source-generated [LoggerMessage] and add tenant/service context enrichment to all log entries.

Purpose: Ensure every log entry automatically includes tenant ID (LOG-04), correlation ID (LOG-05), and service context (LOG-06). Convert existing string-interpolation logging to high-performance source-generated logging (LOG-02).

Output: Updated RequestLoggingMiddleware using [LoggerMessage], new TenantEnrichmentMiddleware that adds tenant/service context to logging scopes, and updated ServiceDefaultsExtensions for easy middleware registration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-logging-foundation/01-RESEARCH.md

# Prior plan output (logging infrastructure)
@.planning/phases/01-logging-foundation/01-01-SUMMARY.md

# Files to modify
@src/Shared/Dhadgar.ServiceDefaults/Middleware/RequestLoggingMiddleware.cs
@src/Shared/Dhadgar.ServiceDefaults/Middleware/CorrelationMiddleware.cs
@src/Shared/Dhadgar.ServiceDefaults/MultiTenancy/OrganizationContext.cs
@src/Shared/Dhadgar.ServiceDefaults/ServiceDefaultsExtensions.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create source-generated request logging messages</name>
  <files>
    - src/Shared/Dhadgar.ServiceDefaults/Logging/RequestLoggingMessages.cs
  </files>
  <action>
    Create src/Shared/Dhadgar.ServiceDefaults/Logging/RequestLoggingMessages.cs:

    1. Create sealed partial class RequestLoggingMessages with ILogger<RequestLoggingMessages> dependency

    2. Define [LoggerMessage] methods using EventId range 9100-9199 (Infrastructure/HTTP):
       - HttpRequestStarted (EventId=9101, Level=Debug):
         Message: "HTTP {Method} {Path} started"
       - HttpRequestCompleted (EventId=9102, Level=Information):
         Message: "HTTP {Method} {Path} responded {StatusCode} in {ElapsedMs}ms"
       - HttpRequestCompletedWithWarning (EventId=9103, Level=Warning):
         Message: "HTTP {Method} {Path} responded {StatusCode} in {ElapsedMs}ms"
       - HttpRequestFailed (EventId=9104, Level=Error):
         Message: "HTTP {Method} {Path} failed after {ElapsedMs}ms"
         Include Exception parameter

    3. Add public wrapper methods that select appropriate log level based on status code:
       - LogRequestCompleted(method, path, statusCode, elapsedMs) that routes to:
         - HttpRequestCompletedWithWarning if statusCode >= 400 and < 500
         - HttpRequestFailed if statusCode >= 500
         - HttpRequestCompleted otherwise

    Follow the SecurityEventLogger pattern (public wrappers calling private partial methods).
  </action>
  <verify>
    Run: `dotnet build src/Shared/Dhadgar.ServiceDefaults`
    Expected: Build succeeds, source generator creates partial implementations
  </verify>
  <done>
    - RequestLoggingMessages.cs uses [LoggerMessage] for all HTTP logging
    - EventIds are in 9100-9199 range
    - Public wrapper method handles log level selection based on status code
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tenant and service context enrichment middleware</name>
  <files>
    - src/Shared/Dhadgar.ServiceDefaults/Middleware/TenantEnrichmentMiddleware.cs
  </files>
  <action>
    Create src/Shared/Dhadgar.ServiceDefaults/Middleware/TenantEnrichmentMiddleware.cs:

    1. Accept dependencies: RequestDelegate, ILogger<TenantEnrichmentMiddleware>
    2. Inject IOrganizationContext via InvokeAsync (scoped service)

    3. In InvokeAsync, create logging scope with:
       - TenantId: from IOrganizationContext.OrganizationId?.ToString() ?? "system"
       - CorrelationId: from context.Items["CorrelationId"] (set by CorrelationMiddleware)
       - RequestId: from context.Items["RequestId"]
       - ServiceName: from Assembly entry point name or explicit configuration
       - ServiceVersion: from Assembly version
       - Hostname: from Environment.MachineName

    4. Use logger.BeginScope(new Dictionary<string, object> { ... }) pattern

    5. Call await _next(context) INSIDE the using scope block

    6. Add static method GetServiceInfo() that caches service name/version/hostname
       (avoid reflection on every request)

    Add XML documentation explaining:
    - This middleware MUST run after CorrelationMiddleware
    - All logs within the scope automatically include these fields
    - For background services, create scope manually with same fields
  </action>
  <verify>
    Run: `dotnet build src/Shared/Dhadgar.ServiceDefaults`
    Expected: Build succeeds
  </verify>
  <done>
    - TenantEnrichmentMiddleware adds TenantId, CorrelationId, ServiceName, ServiceVersion, Hostname to logging scope
    - Service info is cached (not computed per-request)
    - XML documentation explains middleware ordering requirements
  </done>
</task>

<task type="auto">
  <name>Task 3: Update RequestLoggingMiddleware and ServiceDefaultsExtensions</name>
  <files>
    - src/Shared/Dhadgar.ServiceDefaults/Middleware/RequestLoggingMiddleware.cs
    - src/Shared/Dhadgar.ServiceDefaults/ServiceDefaultsExtensions.cs
  </files>
  <action>
    1. Update RequestLoggingMiddleware.cs:
       - Inject RequestLoggingMessages instead of ILogger<RequestLoggingMiddleware>
       - Replace _logger.Log() call with _requestLogger.LogRequestCompleted()
       - Replace _logger.LogError() with _requestLogger.LogRequestFailed()
       - REMOVE the BeginScope block (TenantEnrichmentMiddleware handles this now)
       - Keep the Stopwatch timing logic
       - Keep the try/catch structure

    2. Update ServiceDefaultsExtensions.cs:
       - Add UseDhadgarMiddleware(this WebApplication app) extension method
       - Registers middleware in correct order:
         1. app.UseMiddleware<CorrelationMiddleware>() - first, sets IDs
         2. app.UseMiddleware<TenantEnrichmentMiddleware>() - second, adds context
         3. app.UseMiddleware<RequestLoggingMiddleware>() - third, logs with context
       - Document that this replaces manual middleware registration

    3. Update AddDhadgarServiceDefaults:
       - Register RequestLoggingMessages as singleton
       - Ensure IOrganizationContext registration (from LoggingExtensions)
  </action>
  <verify>
    Run: `dotnet build src/Shared/Dhadgar.ServiceDefaults`
    Expected: Build succeeds with no warnings about unused variables
  </verify>
  <done>
    - RequestLoggingMiddleware uses RequestLoggingMessages (source-generated)
    - RequestLoggingMiddleware no longer creates its own scope
    - UseDhadgarMiddleware extension registers middleware in correct order
    - ServiceDefaultsExtensions registers RequestLoggingMessages as singleton
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   ```bash
   dotnet build src/Shared/Dhadgar.ServiceDefaults
   ```
   Expected: Success with 0 errors

2. Source generation verification:
   ```bash
   grep -r "LoggerMessage" src/Shared/Dhadgar.ServiceDefaults/Logging/
   ```
   Expected: RequestLoggingMessages.cs contains [LoggerMessage] attributes

3. Middleware ordering verification:
   ```bash
   grep -A5 "UseDhadgarMiddleware" src/Shared/Dhadgar.ServiceDefaults/ServiceDefaultsExtensions.cs
   ```
   Expected: CorrelationMiddleware -> TenantEnrichmentMiddleware -> RequestLoggingMiddleware

4. Scope fields verification:
   ```bash
   grep -E "TenantId|ServiceName|ServiceVersion|Hostname" src/Shared/Dhadgar.ServiceDefaults/Middleware/TenantEnrichmentMiddleware.cs
   ```
   Expected: All four fields present in the scope dictionary
</verification>

<success_criteria>
1. RequestLoggingMiddleware uses source-generated [LoggerMessage] methods (no string interpolation)
2. TenantEnrichmentMiddleware exists and adds TenantId, ServiceName, ServiceVersion, Hostname to scope
3. UseDhadgarMiddleware registers middleware in correct order
4. CorrelationId propagates through entire request lifecycle
5. Solution builds successfully: `dotnet build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-logging-foundation/01-02-SUMMARY.md`
</output>
