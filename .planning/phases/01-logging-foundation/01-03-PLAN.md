---
phase: 01-logging-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/Dhadgar.Gateway/Program.cs
  - src/Dhadgar.Identity/Program.cs
  - src/Dhadgar.Servers/Program.cs
  - tests/Dhadgar.ServiceDefaults.Tests/Logging/RedactionTests.cs
  - tests/Dhadgar.ServiceDefaults.Tests/Logging/LoggingIntegrationTests.cs
autonomous: true

must_haves:
  truths:
    - "Gateway service logs include TenantId, CorrelationId, ServiceName, ServiceVersion, Hostname"
    - "Identity service logs include TenantId, CorrelationId, ServiceName, ServiceVersion, Hostname"
    - "Servers service logs include TenantId, CorrelationId, ServiceName, ServiceVersion, Hostname"
    - "Email addresses in logs are redacted to ***@***.***"
    - "Logs from a request to Gateway can be filtered by CorrelationId to find related logs"
  artifacts:
    - path: "tests/Dhadgar.ServiceDefaults.Tests/Logging/RedactionTests.cs"
      provides: "Unit tests for PII redaction"
      min_lines: 50
    - path: "tests/Dhadgar.ServiceDefaults.Tests/Logging/LoggingIntegrationTests.cs"
      provides: "Integration tests verifying context enrichment"
      min_lines: 80
  key_links:
    - from: "src/Dhadgar.Gateway/Program.cs"
      to: "src/Shared/Dhadgar.ServiceDefaults/ServiceDefaultsExtensions.cs"
      via: "AddDhadgarServiceDefaults and UseDhadgarMiddleware"
      pattern: "AddDhadgarServiceDefaults.*UseDhadgarMiddleware"
    - from: "src/Dhadgar.Identity/Program.cs"
      to: "src/Shared/Dhadgar.ServiceDefaults/Logging/LoggingExtensions.cs"
      via: "builder.Logging.AddDhadgarLogging"
      pattern: "AddDhadgarLogging"
---

<objective>
Wire services to use logging infrastructure and verify end-to-end logging with tests.

Purpose: Roll out the logging foundation to pilot services (Gateway, Identity, Servers) and create tests proving PII redaction works and context enrichment is present. This validates LOG-01 through LOG-06 are satisfied before rolling out to all services.

Output: Three services updated to use AddDhadgarLogging/UseDhadgarMiddleware, comprehensive tests for redaction and context enrichment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-logging-foundation/01-RESEARCH.md

# Prior plan outputs
@.planning/phases/01-logging-foundation/01-01-SUMMARY.md
@.planning/phases/01-logging-foundation/01-02-SUMMARY.md

# Services to update
@src/Dhadgar.Gateway/Program.cs
@src/Dhadgar.Identity/Program.cs
@src/Dhadgar.Servers/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire pilot services to logging infrastructure</name>
  <files>
    - src/Dhadgar.Gateway/Program.cs
    - src/Dhadgar.Identity/Program.cs
    - src/Dhadgar.Servers/Program.cs
  </files>
  <action>
    Update each service's Program.cs to use the new logging infrastructure:

    1. Gateway (src/Dhadgar.Gateway/Program.cs):
       - Add: builder.Services.AddDhadgarLogging() after AddDhadgarServiceDefaults()
       - Add: builder.Logging.AddDhadgarLogging("Dhadgar.Gateway", builder.Configuration)
       - Add: app.UseDhadgarMiddleware() BEFORE app.MapReverseProxy()
       - Keep existing endpoint mappings

    2. Identity (src/Dhadgar.Identity/Program.cs):
       - Add: builder.Services.AddDhadgarLogging() after AddDhadgarServiceDefaults()
       - Add: builder.Logging.AddDhadgarLogging("Dhadgar.Identity", builder.Configuration)
       - Add: app.UseDhadgarMiddleware() early in pipeline (after UseRouting if present)
       - Keep existing authentication/authorization middleware

    3. Servers (src/Dhadgar.Servers/Program.cs):
       - Add: builder.Services.AddDhadgarLogging() after AddDhadgarServiceDefaults()
       - Add: builder.Logging.AddDhadgarLogging("Dhadgar.Servers", builder.Configuration)
       - Add: app.UseDhadgarMiddleware() early in pipeline
       - Keep existing endpoint mappings

    For each service:
    - Ensure using Dhadgar.ServiceDefaults.Logging is added
    - Place middleware call early but after exception handling middleware
    - Do NOT remove existing functionality
  </action>
  <verify>
    Run: `dotnet build src/Dhadgar.Gateway && dotnet build src/Dhadgar.Identity && dotnet build src/Dhadgar.Servers`
    Expected: All three services build successfully
  </verify>
  <done>
    - Gateway, Identity, Servers call AddDhadgarLogging on services and logging builder
    - All three services call UseDhadgarMiddleware in the request pipeline
    - Services build without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create redaction unit tests</name>
  <files>
    - tests/Dhadgar.ServiceDefaults.Tests/Logging/RedactionTests.cs
  </files>
  <action>
    Create tests/Dhadgar.ServiceDefaults.Tests/Logging/RedactionTests.cs:

    1. Test EmailRedactor:
       - Test standard email "user@example.com" -> "***@***.***"
       - Test email with subdomain "user@mail.example.com" -> "***@***.***"
       - Test empty string handling
       - Test very long email handling

    2. Test TokenRedactor:
       - Test short token "abc123" -> "[REDACTED-TOKEN:len=6]"
       - Test JWT-like token (long string) -> "[REDACTED-TOKEN:len=N]"
       - Test empty string handling

    3. Test ConnectionStringRedactor:
       - Test PostgreSQL connection string:
         Input: "Host=localhost;Port=5432;Database=dhadgar;Username=admin;Password=secret123"
         Expected: Contains "Host=localhost" and "[CREDENTIALS-REDACTED]", NOT "secret123"
       - Test connection string without password (should pass through mostly unchanged)
       - Test malformed connection string (should not crash)

    Use xUnit [Fact] and [Theory] attributes.
    Use FluentAssertions for readable assertions.
    Each test should be focused on one behavior.
  </action>
  <verify>
    Run: `dotnet test tests/Dhadgar.ServiceDefaults.Tests --filter "FullyQualifiedName~RedactionTests"`
    Expected: All tests pass
  </verify>
  <done>
    - RedactionTests.cs contains tests for EmailRedactor, TokenRedactor, ConnectionStringRedactor
    - Tests verify PII is properly redacted
    - Tests verify edge cases (empty strings, malformed input)
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Create logging integration tests</name>
  <files>
    - tests/Dhadgar.ServiceDefaults.Tests/Logging/LoggingIntegrationTests.cs
  </files>
  <action>
    Create tests/Dhadgar.ServiceDefaults.Tests/Logging/LoggingIntegrationTests.cs:

    1. Create test helper: InMemoryLoggerProvider that captures log entries with scopes
       - Implement ILoggerProvider and ILogger
       - Store LogEntry records with: Level, Message, Scopes (Dictionary), Exception

    2. Test TenantEnrichmentMiddleware context inclusion:
       - Set up minimal WebApplication with middleware
       - Make request with X-Organization-Id header
       - Verify logged entries include TenantId matching header value
       - Verify ServiceName, ServiceVersion, Hostname are present

    3. Test CorrelationId propagation:
       - Make request with X-Correlation-Id header
       - Verify all logged entries include CorrelationId matching header value
       - Make request WITHOUT header
       - Verify CorrelationId is generated and present in logs

    4. Test RequestLoggingMessages output:
       - Make successful request (200 response)
       - Verify log contains method, path, status code, elapsed time
       - Verify log level is Information

       - Make failed request (500 response)
       - Verify log level is Error
       - Verify exception is included if thrown

    5. Test log level consistency (LOG-01):
       - Verify 2xx responses log at Information
       - Verify 4xx responses log at Warning
       - Verify 5xx responses log at Error

    Use WebApplicationFactory pattern for integration tests.
    Use InMemoryLoggerProvider to capture and assert on log output.
  </action>
  <verify>
    Run: `dotnet test tests/Dhadgar.ServiceDefaults.Tests --filter "FullyQualifiedName~LoggingIntegrationTests"`
    Expected: All tests pass
  </verify>
  <done>
    - LoggingIntegrationTests.cs verifies context enrichment works end-to-end
    - Tests prove TenantId, CorrelationId, ServiceName, ServiceVersion, Hostname appear in logs
    - Tests prove log levels match status codes (Info/Warning/Error)
    - All tests pass
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Full build verification:
   ```bash
   dotnet build
   ```
   Expected: Entire solution builds successfully

2. All tests pass:
   ```bash
   dotnet test tests/Dhadgar.ServiceDefaults.Tests
   ```
   Expected: All tests pass including new Logging/ tests

3. Manual smoke test (optional but recommended):
   ```bash
   # Start Gateway
   dotnet run --project src/Dhadgar.Gateway &

   # Make request with correlation header
   curl -H "X-Correlation-Id: test-123" http://localhost:5000/healthz

   # Check logs contain:
   # - CorrelationId: test-123
   # - ServiceName: Dhadgar.Gateway
   # - TenantId: system (no auth)
   ```
</verification>

<success_criteria>
1. Gateway, Identity, and Servers services updated to use logging infrastructure
2. All three pilot services build successfully
3. RedactionTests verify PII scrubbing works for email, token, and connection strings
4. LoggingIntegrationTests verify context enrichment (TenantId, CorrelationId, ServiceName, ServiceVersion, Hostname)
5. LoggingIntegrationTests verify log levels (Info for 2xx, Warning for 4xx, Error for 5xx)
6. All tests pass: `dotnet test` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-logging-foundation/01-03-SUMMARY.md`
</output>
