---
phase: 01-logging-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Directory.Packages.props
  - src/Shared/Dhadgar.ServiceDefaults/Dhadgar.ServiceDefaults.csproj
  - src/Shared/Dhadgar.ServiceDefaults/Logging/DhadgarDataClassifications.cs
  - src/Shared/Dhadgar.ServiceDefaults/Logging/Redactors/EmailRedactor.cs
  - src/Shared/Dhadgar.ServiceDefaults/Logging/Redactors/TokenRedactor.cs
  - src/Shared/Dhadgar.ServiceDefaults/Logging/Redactors/ConnectionStringRedactor.cs
  - src/Shared/Dhadgar.ServiceDefaults/Logging/LogCategories.cs
  - src/Shared/Dhadgar.ServiceDefaults/Logging/LoggingExtensions.cs
autonomous: true

must_haves:
  truths:
    - "Redaction services are registered and available via DI"
    - "Email addresses logged with classification attribute are redacted to ***@***.***"
    - "Tokens and passwords logged with classification attribute are fully redacted"
    - "LoggerMessage EventId conventions are documented and enforced"
  artifacts:
    - path: "src/Shared/Dhadgar.ServiceDefaults/Logging/DhadgarDataClassifications.cs"
      provides: "Data classification taxonomy for PII redaction"
      exports: ["DhadgarDataClassifications"]
    - path: "src/Shared/Dhadgar.ServiceDefaults/Logging/Redactors/EmailRedactor.cs"
      provides: "Email redaction implementation"
      exports: ["EmailRedactor"]
    - path: "src/Shared/Dhadgar.ServiceDefaults/Logging/LoggingExtensions.cs"
      provides: "AddDhadgarLogging extension method"
      exports: ["AddDhadgarLogging"]
  key_links:
    - from: "src/Shared/Dhadgar.ServiceDefaults/Logging/LoggingExtensions.cs"
      to: "Microsoft.Extensions.Compliance.Redaction"
      via: "services.AddRedaction()"
      pattern: "AddRedaction.*SetRedactor"
---

<objective>
Create core logging infrastructure in ServiceDefaults with PII redaction, data classification taxonomy, and logging extensions.

Purpose: Establish the foundational logging components (LOG-02, LOG-03) that all services will inherit. This centralizes redaction logic and logging configuration so services automatically get PII scrubbing without per-service setup.

Output: New Logging/ folder in ServiceDefaults with redaction services, data classifications, log category conventions, and AddDhadgarLogging() extension method.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-logging-foundation/01-RESEARCH.md

# Existing patterns to follow
@src/Shared/Dhadgar.ServiceDefaults/Security/SecurityEventLogger.cs
@src/Shared/Dhadgar.ServiceDefaults/ServiceDefaultsExtensions.cs
@Directory.Packages.props
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add redaction packages and create data classifications</name>
  <files>
    - Directory.Packages.props
    - src/Shared/Dhadgar.ServiceDefaults/Dhadgar.ServiceDefaults.csproj
    - src/Shared/Dhadgar.ServiceDefaults/Logging/DhadgarDataClassifications.cs
    - src/Shared/Dhadgar.ServiceDefaults/Logging/LogCategories.cs
  </files>
  <action>
    1. Add new packages to Directory.Packages.props:
       - Microsoft.Extensions.Compliance.Redaction Version="10.2.0"
       - Microsoft.Extensions.Telemetry Version="10.2.0"

    2. Add PackageReference to Dhadgar.ServiceDefaults.csproj:
       - Microsoft.Extensions.Compliance.Redaction
       - Microsoft.Extensions.Telemetry

    3. Create src/Shared/Dhadgar.ServiceDefaults/Logging/DhadgarDataClassifications.cs:
       - Define static class with DataClassification constants
       - TaxonomyName = "Dhadgar"
       - Classifications: Email, Token, Password, ConnectionString, ApiKey, IpAddress
       - Follow Microsoft.Extensions.Compliance.Redaction pattern from research

    4. Create src/Shared/Dhadgar.ServiceDefaults/Logging/LogCategories.cs:
       - Define EventId ranges per domain (as documented in research):
         - 1000-1999: Server lifecycle
         - 2000-2999: Authentication/Identity
         - 3000-3999: Node management
         - 4000-4999: Task orchestration
         - 5000-5999: Security events (already used by SecurityEventLogger)
         - 6000-6999: File operations
         - 7000-7999: Mod management
         - 8000-8999: Billing
         - 9000-9999: Infrastructure/system
       - Create static class LogCategories with nested classes per domain containing EventId constants
  </action>
  <verify>
    Run: `dotnet build src/Shared/Dhadgar.ServiceDefaults`
    Expected: Build succeeds with new packages resolved
  </verify>
  <done>
    - Directory.Packages.props contains Microsoft.Extensions.Compliance.Redaction and Microsoft.Extensions.Telemetry
    - DhadgarDataClassifications.cs defines Email, Token, Password, ConnectionString, ApiKey, IpAddress classifications
    - LogCategories.cs defines EventId ranges for all service domains
  </done>
</task>

<task type="auto">
  <name>Task 2: Create custom redactors for PII types</name>
  <files>
    - src/Shared/Dhadgar.ServiceDefaults/Logging/Redactors/EmailRedactor.cs
    - src/Shared/Dhadgar.ServiceDefaults/Logging/Redactors/TokenRedactor.cs
    - src/Shared/Dhadgar.ServiceDefaults/Logging/Redactors/ConnectionStringRedactor.cs
  </files>
  <action>
    Create Logging/Redactors/ folder with three redactor implementations:

    1. EmailRedactor.cs:
       - Inherit from Microsoft.Extensions.Compliance.Redaction.Redactor
       - Override GetRedactedLength() to return constant 11 ("***@***.***")
       - Override Redact() to always return "***@***.***"
       - This protects email domain info (not just username)

    2. TokenRedactor.cs:
       - Inherit from Redactor
       - Return "[REDACTED-TOKEN]" for any token value
       - Use for Bearer tokens, API keys, refresh tokens
       - Show length hint: "[REDACTED-TOKEN:len=32]" format

    3. ConnectionStringRedactor.cs:
       - Inherit from Redactor
       - Parse connection string, keep Host/Server visible, redact Password/User
       - Output format: "Host=xxx;Database=xxx;[CREDENTIALS-REDACTED]"
       - Use regex to find Password= and User= segments

    Follow the Redactor pattern from research (GetRedactedLength, Redact methods).
    Add XML documentation explaining what each redactor does.
  </action>
  <verify>
    Run: `dotnet build src/Shared/Dhadgar.ServiceDefaults`
    Expected: Build succeeds, all redactors compile without warnings
  </verify>
  <done>
    - EmailRedactor replaces emails with "***@***.***"
    - TokenRedactor replaces tokens with "[REDACTED-TOKEN:len=N]"
    - ConnectionStringRedactor preserves host/database, redacts credentials
    - All redactors have XML documentation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create logging extensions with redaction registration</name>
  <files>
    - src/Shared/Dhadgar.ServiceDefaults/Logging/LoggingExtensions.cs
  </files>
  <action>
    Create src/Shared/Dhadgar.ServiceDefaults/Logging/LoggingExtensions.cs with:

    1. AddDhadgarLogging(this IServiceCollection services) extension method:
       - Register redaction services: services.AddRedaction(builder => {
           builder.SetRedactor<EmailRedactor>(DhadgarDataClassifications.Email);
           builder.SetRedactor<TokenRedactor>(DhadgarDataClassifications.Token);
           builder.SetRedactor<TokenRedactor>(DhadgarDataClassifications.ApiKey);
           builder.SetRedactor<ErasingRedactor>(DhadgarDataClassifications.Password);
           builder.SetRedactor<ConnectionStringRedactor>(DhadgarDataClassifications.ConnectionString);
         })
       - Call services.AddOrganizationContext() for tenant isolation
       - Register ISecurityEventLogger (singleton)

    2. AddDhadgarLogging(this ILoggingBuilder builder, string serviceName, IConfiguration configuration) extension:
       - Call builder.EnableRedaction() to enable redaction in logging pipeline
       - Configure OpenTelemetry logging with:
         - SetResourceBuilder with service name
         - IncludeFormattedMessage = true
         - IncludeScopes = true (CRITICAL for correlation context)
         - ParseStateValues = true
         - Add OTLP exporter if OpenTelemetry:OtlpEndpoint is configured

    Include XML documentation explaining:
    - What each method does
    - That EnableRedaction() requires Microsoft.Extensions.Telemetry
    - That IncludeScopes is required for correlation/tenant context to appear in logs
  </action>
  <verify>
    Run: `dotnet build src/Shared/Dhadgar.ServiceDefaults`
    Run: `dotnet test tests/Dhadgar.ServiceDefaults.Tests` (if tests exist)
    Expected: Build succeeds, no compiler warnings about missing references
  </verify>
  <done>
    - LoggingExtensions.cs exists with AddDhadgarLogging extension methods
    - Redaction is wired up for Email, Token, Password, ConnectionString, ApiKey
    - OpenTelemetry logging configured with IncludeScopes = true
    - XML documentation explains usage
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   ```bash
   dotnet build src/Shared/Dhadgar.ServiceDefaults
   ```
   Expected: Success with 0 errors

2. Package verification:
   ```bash
   grep -E "Microsoft.Extensions.Compliance.Redaction|Microsoft.Extensions.Telemetry" Directory.Packages.props
   ```
   Expected: Both packages listed

3. File structure verification:
   ```bash
   ls -la src/Shared/Dhadgar.ServiceDefaults/Logging/
   ls -la src/Shared/Dhadgar.ServiceDefaults/Logging/Redactors/
   ```
   Expected: DhadgarDataClassifications.cs, LogCategories.cs, LoggingExtensions.cs, Redactors/ folder with 3 files
</verification>

<success_criteria>
1. Microsoft.Extensions.Compliance.Redaction and Microsoft.Extensions.Telemetry packages added to central package management
2. DhadgarDataClassifications defines taxonomy with Email, Token, Password, ConnectionString, ApiKey, IpAddress
3. Three custom redactors exist (EmailRedactor, TokenRedactor, ConnectionStringRedactor)
4. LogCategories documents EventId ranges for all service domains
5. AddDhadgarLogging extension methods exist for both IServiceCollection and ILoggingBuilder
6. Solution builds successfully: `dotnet build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-logging-foundation/01-01-SUMMARY.md`
</output>
