---
phase: 02-distributed-tracing
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/Shared/Dhadgar.ServiceDefaults/Tracing/DhadgarActivitySource.cs
  - src/Shared/Dhadgar.ServiceDefaults/Middleware/ProblemDetailsMiddleware.cs
  - tests/Dhadgar.ServiceDefaults.Tests/Middleware/ProblemDetailsMiddlewareTests.cs
autonomous: true

must_haves:
  truths:
    - "Developers can create custom spans using DhadgarActivitySource"
    - "Error responses include TraceId from Activity.Current"
    - "TraceId in error responses can be used to find the trace in Jaeger/Grafana"
  artifacts:
    - path: "src/Shared/Dhadgar.ServiceDefaults/Tracing/DhadgarActivitySource.cs"
      provides: "Shared ActivitySource for custom business spans"
      exports: ["DhadgarActivitySource"]
    - path: "src/Shared/Dhadgar.ServiceDefaults/Middleware/ProblemDetailsMiddleware.cs"
      provides: "Updated middleware with TraceId from Activity.Current"
      contains: "Activity.Current?.TraceId"
    - path: "tests/Dhadgar.ServiceDefaults.Tests/Middleware/ProblemDetailsMiddlewareTests.cs"
      provides: "Tests verifying TraceId in Problem Details responses"
      contains: "traceId"
  key_links:
    - from: "src/Shared/Dhadgar.ServiceDefaults/Middleware/ProblemDetailsMiddleware.cs"
      to: "System.Diagnostics.Activity"
      via: "Activity.Current?.TraceId"
      pattern: "Activity\\.Current\\??\\.TraceId"
    - from: "src/Shared/Dhadgar.ServiceDefaults/Tracing/DhadgarActivitySource.cs"
      to: "src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingExtensions.cs"
      via: "ActivitySource registration in AddDhadgarTracing"
      pattern: "AddSource.*Dhadgar"
---

<objective>
Create custom span support via ActivitySource and update ProblemDetailsMiddleware to include TraceId for error correlation.

Purpose: Complete the distributed tracing requirements by enabling custom business spans (TRACE-03) and ensuring error responses include TraceId (TRACE-04). This allows developers to instrument important operations and users to correlate errors with traces.

Output: DhadgarActivitySource for creating custom spans, updated ProblemDetailsMiddleware with Activity.Current TraceId, and tests verifying TraceId appears in error responses.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-distributed-tracing/02-RESEARCH.md

# Prior plan outputs
@.planning/phases/02-distributed-tracing/02-01-SUMMARY.md
@.planning/phases/02-distributed-tracing/02-02-SUMMARY.md

# Files to modify
@src/Shared/Dhadgar.ServiceDefaults/Middleware/ProblemDetailsMiddleware.cs
@src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingExtensions.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared ActivitySource for custom spans</name>
  <files>
    - src/Shared/Dhadgar.ServiceDefaults/Tracing/DhadgarActivitySource.cs
    - src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingExtensions.cs
  </files>
  <action>
    1. Create src/Shared/Dhadgar.ServiceDefaults/Tracing/DhadgarActivitySource.cs:
       ```csharp
       using System.Diagnostics;

       namespace Dhadgar.ServiceDefaults.Tracing;

       /// <summary>
       /// Shared ActivitySource for creating custom business operation spans.
       /// Use this to instrument important operations that should appear in traces.
       /// </summary>
       /// <example>
       /// using var activity = DhadgarActivitySource.StartActivity("server.provision");
       /// activity?.SetTag("server.id", serverId);
       /// // ... do work ...
       /// activity?.SetStatus(ActivityStatusCode.Ok);
       /// </example>
       public static class DhadgarActivitySource
       {
           /// <summary>
           /// The shared ActivitySource for Dhadgar business operations.
           /// </summary>
           public static readonly ActivitySource Source = new("Dhadgar.Operations", "1.0.0");

           /// <summary>
           /// The name of the ActivitySource for registration with OpenTelemetry.
           /// </summary>
           public static string Name => Source.Name;

           /// <summary>
           /// Starts a new activity (span) for a business operation.
           /// Returns null if no listeners are registered (sampling).
           /// </summary>
           /// <param name="operationName">Name of the operation (e.g., "server.start", "task.execute")</param>
           /// <param name="kind">The kind of activity. Defaults to Internal for business logic.</param>
           /// <returns>A started Activity, or null if not sampled.</returns>
           public static Activity? StartActivity(
               string operationName,
               ActivityKind kind = ActivityKind.Internal)
           {
               return Source.StartActivity(operationName, kind);
           }

           /// <summary>
           /// Starts a new activity with initial tags.
           /// </summary>
           public static Activity? StartActivity(
               string operationName,
               ActivityKind kind,
               IEnumerable<KeyValuePair<string, object?>> tags)
           {
               var activity = Source.StartActivity(operationName, kind);

               if (activity?.IsAllDataRequested == true)
               {
                   foreach (var tag in tags)
                   {
                       activity.SetTag(tag.Key, tag.Value);
                   }
               }

               return activity;
           }
       }
       ```

    2. Update src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingExtensions.cs to register the shared ActivitySource:
       - In the AddDhadgarTracing() method, add:
         ```csharp
         .AddSource(DhadgarActivitySource.Name)
         ```
       - This ensures custom spans from DhadgarActivitySource appear in traces

    3. Add XML documentation explaining:
       - Always check for null (sampling may skip the activity)
       - Use using statement to ensure activity is disposed/completed
       - Set status and record exceptions for error handling
       - Tags should follow OpenTelemetry semantic conventions where applicable
  </action>
  <verify>
    Run: `dotnet build src/Shared/Dhadgar.ServiceDefaults`
    Expected: Build succeeds with no warnings
  </verify>
  <done>
    - DhadgarActivitySource.cs provides static ActivitySource
    - StartActivity() methods available for creating custom spans
    - ActivitySource registered in AddDhadgarTracing()
    - XML documentation explains usage patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ProblemDetailsMiddleware with TraceId</name>
  <files>
    - src/Shared/Dhadgar.ServiceDefaults/Middleware/ProblemDetailsMiddleware.cs
  </files>
  <action>
    1. Add using statement at the top:
       ```csharp
       using System.Diagnostics;
       ```

    2. In HandleExceptionAsync(), update the traceId assignment (around line 56):
       ```csharp
       // TRACE-04: Get TraceId from Activity.Current (set by OTEL AspNetCore instrumentation)
       // Fall back to CorrelationId if no active trace, then to HttpContext.TraceIdentifier
       var traceId = Activity.Current?.TraceId.ToString()
           ?? context.Items["CorrelationId"]?.ToString()
           ?? context.TraceIdentifier
           ?? "unknown";
       ```

    3. The existing problemDetails object already includes traceId - verify it's present:
       ```csharp
       var problemDetails = new
       {
           type = "https://meridian.console/errors/internal-server-error",
           title = "Internal Server Error",
           status = (int)HttpStatusCode.InternalServerError,
           detail = includeDetails ? ... : ...,
           instance = context.Request.Path.ToString(),
           traceId = traceId,  // <-- Verify this exists
           extensions = ...
       };
       ```

    4. Update the log message to clarify it's the OpenTelemetry TraceId:
       ```csharp
       _logger.LogError(exception,
           "Unhandled exception. TraceId: {TraceId}, Path: {Path}",
           traceId, context.Request.Path);
       ```

    The key change is using Activity.Current?.TraceId instead of just CorrelationId. This ensures the TraceId matches what appears in Jaeger/Grafana traces.
  </action>
  <verify>
    Run: `dotnet build src/Shared/Dhadgar.ServiceDefaults`
    Expected: Build succeeds
  </verify>
  <done>
    - ProblemDetailsMiddleware uses Activity.Current?.TraceId
    - Fallback chain: Activity.TraceId -> CorrelationId -> TraceIdentifier -> "unknown"
    - TraceId appears in error response JSON
    - Using System.Diagnostics added
  </done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for TraceId in error responses</name>
  <files>
    - tests/Dhadgar.ServiceDefaults.Tests/Middleware/ProblemDetailsMiddlewareTests.cs
  </files>
  <action>
    1. Create or update tests/Dhadgar.ServiceDefaults.Tests/Middleware/ProblemDetailsMiddlewareTests.cs:
       ```csharp
       using System.Diagnostics;
       using System.Net;
       using System.Text.Json;
       using Dhadgar.ServiceDefaults.Middleware;
       using Microsoft.AspNetCore.Builder;
       using Microsoft.AspNetCore.Hosting;
       using Microsoft.AspNetCore.Http;
       using Microsoft.AspNetCore.TestHost;
       using Microsoft.Extensions.DependencyInjection;
       using Microsoft.Extensions.Hosting;
       using Xunit;

       namespace Dhadgar.ServiceDefaults.Tests.Middleware;

       public class ProblemDetailsMiddlewareTests
       {
           [Fact]
           public async Task ErrorResponse_IncludesTraceId_FromActivityCurrent()
           {
               // Arrange
               using var host = await new HostBuilder()
                   .ConfigureWebHost(webBuilder =>
                   {
                       webBuilder
                           .UseTestServer()
                           .ConfigureServices(services =>
                           {
                               services.AddRouting();
                           })
                           .Configure(app =>
                           {
                               app.UseMiddleware<ProblemDetailsMiddleware>();
                               app.UseRouting();
                               app.UseEndpoints(endpoints =>
                               {
                                   endpoints.MapGet("/error", context =>
                                       throw new InvalidOperationException("Test error"));
                               });
                           });
                   })
                   .StartAsync();

               var client = host.GetTestClient();

               // Act
               var response = await client.GetAsync("/error");

               // Assert
               Assert.Equal(HttpStatusCode.InternalServerError, response.StatusCode);
               Assert.Equal("application/problem+json", response.Content.Headers.ContentType?.MediaType);

               var json = await response.Content.ReadAsStringAsync();
               using var doc = JsonDocument.Parse(json);
               var root = doc.RootElement;

               Assert.True(root.TryGetProperty("traceId", out var traceIdElement),
                   "Problem Details should include traceId property");
               Assert.False(string.IsNullOrEmpty(traceIdElement.GetString()),
                   "traceId should not be empty");
           }

           [Fact]
           public async Task ErrorResponse_TraceId_MatchesActiveActivity()
           {
               // Arrange
               string? capturedTraceId = null;

               using var host = await new HostBuilder()
                   .ConfigureWebHost(webBuilder =>
                   {
                       webBuilder
                           .UseTestServer()
                           .ConfigureServices(services =>
                           {
                               services.AddRouting();
                           })
                           .Configure(app =>
                           {
                               // Middleware to start an activity and capture its TraceId
                               app.Use(async (context, next) =>
                               {
                                   using var activity = new ActivitySource("Test")
                                       .StartActivity("TestRequest");
                                   capturedTraceId = activity?.TraceId.ToString();
                                   await next();
                               });
                               app.UseMiddleware<ProblemDetailsMiddleware>();
                               app.UseRouting();
                               app.UseEndpoints(endpoints =>
                               {
                                   endpoints.MapGet("/error", context =>
                                       throw new InvalidOperationException("Test error"));
                               });
                           });
                   })
                   .StartAsync();

               var client = host.GetTestClient();

               // Register the test ActivitySource so activities are created
               using var listener = new ActivityListener
               {
                   ShouldListenTo = source => source.Name == "Test",
                   Sample = (ref ActivityCreationOptions<ActivityContext> _) =>
                       ActivitySamplingResult.AllData
               };
               ActivitySource.AddActivityListener(listener);

               // Act
               var response = await client.GetAsync("/error");

               // Assert
               var json = await response.Content.ReadAsStringAsync();
               using var doc = JsonDocument.Parse(json);
               var root = doc.RootElement;

               var responseTraceId = root.GetProperty("traceId").GetString();

               // When an activity is present, traceId should match
               if (!string.IsNullOrEmpty(capturedTraceId))
               {
                   Assert.Equal(capturedTraceId, responseTraceId);
               }
           }

           [Fact]
           public async Task ErrorResponse_FallsBackToCorrelationId_WhenNoActivity()
           {
               // Arrange
               const string correlationId = "test-correlation-123";

               using var host = await new HostBuilder()
                   .ConfigureWebHost(webBuilder =>
                   {
                       webBuilder
                           .UseTestServer()
                           .ConfigureServices(services =>
                           {
                               services.AddRouting();
                           })
                           .Configure(app =>
                           {
                               // Set CorrelationId without Activity
                               app.Use(async (context, next) =>
                               {
                                   context.Items["CorrelationId"] = correlationId;
                                   await next();
                               });
                               app.UseMiddleware<ProblemDetailsMiddleware>();
                               app.UseRouting();
                               app.UseEndpoints(endpoints =>
                               {
                                   endpoints.MapGet("/error", context =>
                                       throw new InvalidOperationException("Test error"));
                               });
                           });
                   })
                   .StartAsync();

               var client = host.GetTestClient();

               // Act
               var response = await client.GetAsync("/error");

               // Assert
               var json = await response.Content.ReadAsStringAsync();
               using var doc = JsonDocument.Parse(json);
               var root = doc.RootElement;

               var responseTraceId = root.GetProperty("traceId").GetString();
               Assert.Equal(correlationId, responseTraceId);
           }
       }
       ```

    2. Ensure the test project has required references:
       - Microsoft.AspNetCore.TestHost
       - System.Text.Json

    3. Tests verify:
       - traceId property exists in Problem Details response
       - traceId matches Activity.Current when present
       - Falls back to CorrelationId when no Activity exists
  </action>
  <verify>
    Run: `dotnet test tests/Dhadgar.ServiceDefaults.Tests --filter "FullyQualifiedName~ProblemDetailsMiddlewareTests"`
    Expected: All tests pass
  </verify>
  <done>
    - ProblemDetailsMiddlewareTests.cs exists with TraceId tests
    - Test verifies traceId property in error response
    - Test verifies traceId matches Activity.Current
    - Test verifies fallback to CorrelationId
    - All tests pass
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   ```bash
   dotnet build src/Shared/Dhadgar.ServiceDefaults
   dotnet build tests/Dhadgar.ServiceDefaults.Tests
   ```
   Expected: Both builds succeed with 0 errors

2. Test verification:
   ```bash
   dotnet test tests/Dhadgar.ServiceDefaults.Tests --filter "FullyQualifiedName~ProblemDetailsMiddlewareTests"
   ```
   Expected: All tests pass

3. ActivitySource registration verification:
   ```bash
   grep "AddSource.*Dhadgar" src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingExtensions.cs
   ```
   Expected: DhadgarActivitySource.Name is registered

4. TraceId usage verification:
   ```bash
   grep "Activity.Current" src/Shared/Dhadgar.ServiceDefaults/Middleware/ProblemDetailsMiddleware.cs
   ```
   Expected: Activity.Current?.TraceId usage present
</verification>

<success_criteria>
1. DhadgarActivitySource exists and provides StartActivity() methods for custom spans
2. DhadgarActivitySource is registered in AddDhadgarTracing()
3. ProblemDetailsMiddleware uses Activity.Current?.TraceId with CorrelationId fallback
4. Integration tests verify TraceId appears in error responses
5. All tests pass: `dotnet test tests/Dhadgar.ServiceDefaults.Tests` succeeds
6. Solution builds successfully: `dotnet build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-distributed-tracing/02-03-SUMMARY.md`
</output>
