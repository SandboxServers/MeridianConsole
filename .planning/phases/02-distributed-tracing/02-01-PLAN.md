---
phase: 02-distributed-tracing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Directory.Packages.props
  - src/Shared/Dhadgar.ServiceDefaults/Dhadgar.ServiceDefaults.csproj
  - src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingExtensions.cs
  - src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingConstants.cs
autonomous: true

must_haves:
  truths:
    - "EF Core and Redis instrumentation packages are available for all services"
    - "AddDhadgarTracing() extension method exists and configures EF Core instrumentation"
    - "Services can call AddDhadgarTracing() to get tracing with EF Core spans automatically"
  artifacts:
    - path: "Directory.Packages.props"
      provides: "Central package versions for OTEL EF Core and Redis instrumentation"
      contains: "OpenTelemetry.Instrumentation.EntityFrameworkCore"
    - path: "src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingExtensions.cs"
      provides: "AddDhadgarTracing() extension method"
      exports: ["AddDhadgarTracing"]
    - path: "src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingConstants.cs"
      provides: "Span naming conventions and constants"
      exports: ["TracingConstants"]
  key_links:
    - from: "src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingExtensions.cs"
      to: "OpenTelemetry.Instrumentation.EntityFrameworkCore"
      via: "AddEntityFrameworkCoreInstrumentation()"
      pattern: "AddEntityFrameworkCoreInstrumentation"
---

<objective>
Create core tracing infrastructure in ServiceDefaults with centralized configuration for EF Core and Redis instrumentation.

Purpose: Establish the foundational tracing components (TRACE-01, TRACE-02) that all services will inherit. This centralizes OpenTelemetry tracing configuration so services automatically get database and cache spans without per-service setup.

Output: New Tracing/ folder in ServiceDefaults with AddDhadgarTracing() extension method, EF Core instrumentation packages in central package management, and tracing constants for span naming conventions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-distributed-tracing/02-RESEARCH.md

# Existing patterns to follow
@src/Shared/Dhadgar.ServiceDefaults/Logging/LoggingExtensions.cs
@src/Shared/Dhadgar.ServiceDefaults/ServiceDefaultsExtensions.cs
@Directory.Packages.props
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OpenTelemetry instrumentation packages</name>
  <files>
    - Directory.Packages.props
    - src/Shared/Dhadgar.ServiceDefaults/Dhadgar.ServiceDefaults.csproj
  </files>
  <action>
    1. Add new packages to Directory.Packages.props in the Observability section:
       ```xml
       <PackageVersion Include="OpenTelemetry.Instrumentation.EntityFrameworkCore" Version="1.0.0-beta.12" />
       <PackageVersion Include="OpenTelemetry.Instrumentation.StackExchangeRedis" Version="1.0.0-rc9.14" />
       ```
       Note: Use stable versions from NuGet. Check current stable versions if build fails.

    2. Add PackageReference to Dhadgar.ServiceDefaults.csproj:
       ```xml
       <PackageReference Include="OpenTelemetry.Instrumentation.EntityFrameworkCore" />
       <PackageReference Include="OpenTelemetry.Instrumentation.StackExchangeRedis" />
       ```

    3. Verify existing OTEL packages are already referenced:
       - OpenTelemetry.Exporter.OpenTelemetryProtocol (already present)
       - OpenTelemetry.Extensions.Hosting (may need to add)
       - OpenTelemetry.Instrumentation.AspNetCore (may need to add)
       - OpenTelemetry.Instrumentation.Http (may need to add)
  </action>
  <verify>
    Run: `dotnet restore src/Shared/Dhadgar.ServiceDefaults`
    Run: `dotnet build src/Shared/Dhadgar.ServiceDefaults`
    Expected: Build succeeds with new packages resolved
  </verify>
  <done>
    - Directory.Packages.props contains OpenTelemetry.Instrumentation.EntityFrameworkCore
    - Directory.Packages.props contains OpenTelemetry.Instrumentation.StackExchangeRedis
    - ServiceDefaults.csproj references both packages
    - Solution restores and builds successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tracing constants and extension method</name>
  <files>
    - src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingConstants.cs
    - src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingExtensions.cs
  </files>
  <action>
    1. Create src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingConstants.cs:
       - Define static class TracingConstants
       - Add span name constants following OpenTelemetry semantic conventions:
         - DatabaseSystem = "postgresql"
         - CacheSystem = "redis"
       - Add activity source name prefix: ActivitySourcePrefix = "Dhadgar."
       - Document conventions for custom span naming

    2. Create src/Shared/Dhadgar.ServiceDefaults/Tracing/TracingExtensions.cs:
       - Create AddDhadgarTracing(this IServiceCollection services, IConfiguration configuration, string serviceName, Action<TracerProviderBuilder>? configureTracing = null) extension method
       - Read OTLP endpoint from configuration["OpenTelemetry:OtlpEndpoint"]
       - Create ResourceBuilder with service name
       - Configure OpenTelemetry WithTracing:
         - SetResourceBuilder(resourceBuilder)
         - AddAspNetCoreInstrumentation()
         - AddHttpClientInstrumentation()
         - AddEntityFrameworkCoreInstrumentation(options => {
             options.EnrichWithIDbCommand = (activity, command) => {
               activity.SetTag("db.system", TracingConstants.DatabaseSystem);
             };
           })
         - Allow service-specific configuration via configureTracing callback
         - Add OTLP exporter if endpoint configured

       - Add XML documentation explaining:
         - This method configures base tracing for all services
         - EF Core queries are automatically traced
         - Services using Redis should call AddDhadgarRedisInstrumentation() in the callback
         - Custom ActivitySources must be registered via AddSource() in the callback

    Follow the pattern from LoggingExtensions.cs for consistency.
  </action>
  <verify>
    Run: `dotnet build src/Shared/Dhadgar.ServiceDefaults`
    Expected: Build succeeds with no warnings
  </verify>
  <done>
    - TracingConstants.cs defines database system and span naming constants
    - TracingExtensions.cs provides AddDhadgarTracing() extension method
    - EF Core instrumentation is configured with db.system tag enrichment
    - OTLP exporter conditionally added based on configuration
    - XML documentation explains usage
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   ```bash
   dotnet build src/Shared/Dhadgar.ServiceDefaults
   ```
   Expected: Success with 0 errors

2. Package verification:
   ```bash
   grep -E "OpenTelemetry.Instrumentation.EntityFrameworkCore|OpenTelemetry.Instrumentation.StackExchangeRedis" Directory.Packages.props
   ```
   Expected: Both packages listed

3. File structure verification:
   ```bash
   ls -la src/Shared/Dhadgar.ServiceDefaults/Tracing/
   ```
   Expected: TracingConstants.cs and TracingExtensions.cs exist
</verification>

<success_criteria>
1. OpenTelemetry.Instrumentation.EntityFrameworkCore and StackExchangeRedis packages added to central package management
2. TracingConstants.cs defines span naming conventions
3. AddDhadgarTracing() extension method exists and configures EF Core instrumentation
4. OTLP exporter is conditionally configured based on OpenTelemetry:OtlpEndpoint setting
5. Solution builds successfully: `dotnet build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-distributed-tracing/02-01-SUMMARY.md`
</output>
