---
phase: 05-error-handling
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/Dhadgar.Identity/Endpoints/MembershipEndpoints.cs
  - src/Dhadgar.Identity/Endpoints/OrganizationEndpoints.cs
  - src/Dhadgar.Identity/Endpoints/RoleEndpoints.cs
  - src/Dhadgar.Identity/Endpoints/UserEndpoints.cs
  - src/Dhadgar.Identity/Endpoints/SessionEndpoints.cs
  - src/Dhadgar.Identity/Endpoints/MeEndpoints.cs
  - src/Dhadgar.Identity/Endpoints/TokenExchangeEndpoint.cs
  - src/Dhadgar.Identity/Endpoints/WebhookEndpoint.cs
  - src/Dhadgar.Identity/Endpoints/InternalEndpoints.cs
  - src/Dhadgar.Identity/Endpoints/EndpointHelpers.cs
  - src/Dhadgar.Secrets/Endpoints/SecretsEndpoints.cs
  - src/Dhadgar.Secrets/Endpoints/SecretWriteEndpoints.cs
  - src/Dhadgar.Secrets/Endpoints/KeyVaultEndpoints.cs
  - src/Dhadgar.Secrets/Endpoints/CertificateEndpoints.cs
  - src/Dhadgar.Identity/Program.cs
  - src/Dhadgar.Secrets/Program.cs
  - tests/Dhadgar.Identity.Tests/Endpoints/ProblemDetailsIntegrationTests.cs
  - tests/Dhadgar.Secrets.Tests/Endpoints/ProblemDetailsIntegrationTests.cs
autonomous: true

must_haves:
  truths:
    - "All Identity service error responses return RFC 9457 Problem Details format"
    - "All Secrets service error responses return RFC 9457 Problem Details format"
    - "Error responses include traceId and correlationId for log correlation"
    - "No endpoint returns { error = '...' } anonymous objects"
  artifacts:
    - path: "src/Dhadgar.Identity/Program.cs"
      provides: "Identity service with error handling registration"
      contains: "AddDhadgarErrorHandling"
    - path: "src/Dhadgar.Secrets/Program.cs"
      provides: "Secrets service with error handling registration"
      contains: "AddDhadgarErrorHandling"
    - path: "tests/Dhadgar.Identity.Tests/Endpoints/ProblemDetailsIntegrationTests.cs"
      provides: "Integration tests for Identity Problem Details responses"
      min_lines: 50
  key_links:
    - from: "src/Dhadgar.Identity/Program.cs"
      to: "ErrorHandlingExtensions"
      via: "AddDhadgarErrorHandling() call"
      pattern: "AddDhadgarErrorHandling\\(\\)"
    - from: "src/Dhadgar.Identity/Endpoints/*.cs"
      to: "Results.Problem"
      via: "error response returns"
      pattern: "Results\\.Problem\\("
---

<objective>
Migrate Identity and Secrets service endpoints from `{ error = "..." }` responses to RFC 9457 Problem Details format.

Purpose: Ensure all API errors across pilot services use consistent Problem Details format with trace context (ERR-01, ERR-04).

Output: Updated endpoint files, service registrations, and integration tests proving compliance.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-error-handling/05-RESEARCH.md

# Prior plan summary for infrastructure
@.planning/phases/05-error-handling/05-01-SUMMARY.md

# Endpoints to migrate
@src/Dhadgar.Identity/Endpoints/MembershipEndpoints.cs
@src/Dhadgar.Identity/Endpoints/EndpointHelpers.cs
@src/Dhadgar.Secrets/Endpoints/SecretsEndpoints.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register error handling in Identity and Secrets services</name>
  <files>
    src/Dhadgar.Identity/Program.cs
    src/Dhadgar.Secrets/Program.cs
  </files>
  <action>
Update both service Program.cs files to register and use error handling:

**In builder.Services section (before Build()):**
```csharp
builder.Services.AddDhadgarErrorHandling();
```

**In app middleware section (after CorrelationMiddleware, before Authentication):**
```csharp
// Middleware order:
// 1. CorrelationMiddleware (sets correlation IDs)
// 2. TenantEnrichmentMiddleware (adds tenant context)
// 3. UseDhadgarErrorHandling() (exception handler + status code pages)
// 4. RequestLoggingMiddleware (logs requests)
// 5. Authentication/Authorization
app.UseDhadgarErrorHandling();
```

Add the required using statement:
```csharp
using Dhadgar.ServiceDefaults.Errors;
```

If the service uses `UseDhadgarMiddleware()` extension, ensure `UseDhadgarErrorHandling()` is called AFTER correlation/tenant middleware but BEFORE request logging. The order matters because:
- Correlation must be set first (for trace IDs in error responses)
- Error handling catches exceptions and formats responses
- Request logging logs the final response status
  </action>
  <verify>
    dotnet build src/Dhadgar.Identity && dotnet build src/Dhadgar.Secrets
  </verify>
  <done>
    Both services register AddDhadgarErrorHandling() and call UseDhadgarErrorHandling() in correct pipeline order.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Identity endpoints to Results.Problem()</name>
  <files>
    src/Dhadgar.Identity/Endpoints/MembershipEndpoints.cs
    src/Dhadgar.Identity/Endpoints/OrganizationEndpoints.cs
    src/Dhadgar.Identity/Endpoints/RoleEndpoints.cs
    src/Dhadgar.Identity/Endpoints/UserEndpoints.cs
    src/Dhadgar.Identity/Endpoints/SessionEndpoints.cs
    src/Dhadgar.Identity/Endpoints/MeEndpoints.cs
    src/Dhadgar.Identity/Endpoints/TokenExchangeEndpoint.cs
    src/Dhadgar.Identity/Endpoints/WebhookEndpoint.cs
    src/Dhadgar.Identity/Endpoints/InternalEndpoints.cs
    src/Dhadgar.Identity/Endpoints/EndpointHelpers.cs
  </files>
  <action>
Replace all `Results.BadRequest(new { error = "..." })` and `Results.NotFound(new { error = "..." })` patterns with `Results.Problem()`.

**Pattern replacement:**

Old:
```csharp
return Results.BadRequest(new { error = result.Error });
```

New:
```csharp
return Results.Problem(
    detail: result.Error,
    statusCode: StatusCodes.Status400BadRequest,
    title: "Bad Request",
    type: "https://meridian.console/errors/bad-request");
```

Old:
```csharp
return Results.NotFound(new { error = result.Error });
```

New:
```csharp
return Results.Problem(
    detail: result.Error,
    statusCode: StatusCodes.Status404NotFound,
    title: "Not Found",
    type: "https://meridian.console/errors/not-found");
```

**For validation errors with field-level details:**
```csharp
return Results.ValidationProblem(
    errors: new Dictionary<string, string[]> { ["fieldName"] = ["error message"] },
    detail: "Validation failed",
    type: "https://meridian.console/errors/validation");
```

**Error type URIs to use:**
- 400 Bad Request: `https://meridian.console/errors/bad-request`
- 400 Validation: `https://meridian.console/errors/validation`
- 401 Unauthorized: `https://meridian.console/errors/unauthorized`
- 403 Forbidden: `https://meridian.console/errors/forbidden`
- 404 Not Found: `https://meridian.console/errors/not-found`
- 409 Conflict: `https://meridian.console/errors/conflict`

**EndpointHelpers.cs special handling:**
If there's a shared helper method that returns error results, update it to return Problem Details format.

Note: The `CustomizeProblemDetails` callback in `AddDhadgarErrorHandling()` automatically adds traceId and correlationId to all Results.Problem() responses, so you don't need to add them manually.
  </action>
  <verify>
    dotnet build src/Dhadgar.Identity
    grep -r "Results\.BadRequest(new {" src/Dhadgar.Identity/Endpoints/ | wc -l  # Should be 0
    grep -r "Results\.NotFound(new {" src/Dhadgar.Identity/Endpoints/ | wc -l   # Should be 0
  </verify>
  <done>
    All Identity endpoints use Results.Problem() or Results.ValidationProblem() for error responses.
    No endpoints return { error = "..." } anonymous objects.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate Secrets endpoints and add integration tests</name>
  <files>
    src/Dhadgar.Secrets/Endpoints/SecretsEndpoints.cs
    src/Dhadgar.Secrets/Endpoints/SecretWriteEndpoints.cs
    src/Dhadgar.Secrets/Endpoints/KeyVaultEndpoints.cs
    src/Dhadgar.Secrets/Endpoints/CertificateEndpoints.cs
    tests/Dhadgar.Identity.Tests/Endpoints/ProblemDetailsIntegrationTests.cs
    tests/Dhadgar.Secrets.Tests/Endpoints/ProblemDetailsIntegrationTests.cs
  </files>
  <action>
**Secrets endpoint migration:**
Apply the same pattern replacement as Identity endpoints:
- Replace `Results.BadRequest(new { error = "..." })` with `Results.Problem(...)`
- Replace `Results.NotFound(new { error = "..." })` with `Results.Problem(...)`

**Integration tests (both services):**

Create `ProblemDetailsIntegrationTests.cs` in each test project:

```csharp
public class ProblemDetailsIntegrationTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly HttpClient _client;

    public ProblemDetailsIntegrationTests(WebApplicationFactory<Program> factory)
    {
        _client = factory.CreateClient();
    }

    [Fact]
    public async Task ErrorResponse_ReturnsProblemDetailsFormat()
    {
        // Arrange - Call an endpoint that will return 4xx
        // (e.g., invalid input, missing resource)

        // Act
        var response = await _client.GetAsync("/api/v1/endpoint-that-returns-error");

        // Assert
        Assert.Equal("application/problem+json", response.Content.Headers.ContentType?.MediaType);

        var content = await response.Content.ReadAsStringAsync();
        var problemDetails = JsonSerializer.Deserialize<ProblemDetails>(content, new JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true
        });

        Assert.NotNull(problemDetails);
        Assert.NotNull(problemDetails.Type);
        Assert.NotNull(problemDetails.Title);
        Assert.NotNull(problemDetails.Status);
        Assert.NotNull(problemDetails.Instance);

        // Verify trace context is included
        Assert.True(problemDetails.Extensions.ContainsKey("traceId"));
        Assert.True(problemDetails.Extensions.ContainsKey("correlationId"));
    }

    [Fact]
    public async Task ValidationError_ReturnsValidationProblemDetails()
    {
        // Test that validation errors include "errors" dictionary
        // ...
    }

    [Fact]
    public async Task NotFound_ReturnsProblemDetailsWithCorrectStatus()
    {
        // Test 404 responses
        // ...
    }
}
```

For Identity, test endpoints like:
- Invalid organization ID format -> 400
- Non-existent member -> 404
- Missing required field -> 400 with validation errors

For Secrets, test endpoints like:
- Invalid secret name format -> 400
- Non-existent secret -> 404
- Missing authorization -> 403
  </action>
  <verify>
    dotnet build src/Dhadgar.Secrets
    dotnet test tests/Dhadgar.Identity.Tests --filter "ProblemDetails"
    dotnet test tests/Dhadgar.Secrets.Tests --filter "ProblemDetails"
    grep -r "Results\.BadRequest(new {" src/Dhadgar.Secrets/Endpoints/ | wc -l  # Should be 0
  </verify>
  <done>
    All Secrets endpoints use Results.Problem() for error responses.
    Integration tests verify Problem Details format with trace context.
    Tests pass for both Identity and Secrets services.
  </done>
</task>

</tasks>

<verification>
```bash
# Build both services
dotnet build src/Dhadgar.Identity
dotnet build src/Dhadgar.Secrets

# Verify no old patterns remain
echo "Identity BadRequest old pattern count:"
grep -r "Results\.BadRequest(new {" src/Dhadgar.Identity/Endpoints/ | wc -l

echo "Identity NotFound old pattern count:"
grep -r "Results\.NotFound(new {" src/Dhadgar.Identity/Endpoints/ | wc -l

echo "Secrets BadRequest old pattern count:"
grep -r "Results\.BadRequest(new {" src/Dhadgar.Secrets/Endpoints/ | wc -l

echo "Secrets NotFound old pattern count:"
grep -r "Results\.NotFound(new {" src/Dhadgar.Secrets/Endpoints/ | wc -l

# Run integration tests
dotnet test tests/Dhadgar.Identity.Tests --filter "ProblemDetails"
dotnet test tests/Dhadgar.Secrets.Tests --filter "ProblemDetails"

# Verify new patterns exist
grep -r "Results\.Problem(" src/Dhadgar.Identity/Endpoints/ | head -5
grep -r "Results\.Problem(" src/Dhadgar.Secrets/Endpoints/ | head -5
```
</verification>

<success_criteria>
- [ ] Identity service registers AddDhadgarErrorHandling() and UseDhadgarErrorHandling()
- [ ] Secrets service registers AddDhadgarErrorHandling() and UseDhadgarErrorHandling()
- [ ] Zero occurrences of `Results.BadRequest(new { error = })` in Identity endpoints
- [ ] Zero occurrences of `Results.NotFound(new { error = })` in Identity endpoints
- [ ] Zero occurrences of `Results.BadRequest(new { error = })` in Secrets endpoints
- [ ] Zero occurrences of `Results.NotFound(new { error = })` in Secrets endpoints
- [ ] Integration tests verify Problem Details format
- [ ] Integration tests verify traceId and correlationId presence
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-error-handling/05-02-SUMMARY.md`
</output>
