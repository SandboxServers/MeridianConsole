name: PR-Agent Review (Manual)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  pr-agent:
    runs-on: ubuntu-latest
    # Only run when someone comments with /spirit command on a PR
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '/spirit') }}
    steps:
      - name: Generate token for spirit-of-the-diff
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SPIRIT_APP_ID }}
          private-key: ${{ secrets.SPIRIT_PRIVATE_KEY }}

      - name: Run PR-Agent review via CLI
        env:
          OPENROUTER.KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          # Install PR-Agent
          pip install pr-agent

          # Run review command with correct CLI syntax
          pr-agent \
            --pr_url="https://github.com/${{ github.repository }}/pull/${{ github.event.issue.number }}" \
            review \
            --config.model="openrouter/mistralai/devstral-2512:free" \
            --config.fallback_models='["openrouter/mistralai/mistral-7b-instruct:free"]' \
            --config.custom_model_max_tokens="262144" \
            --pr_reviewer.auto_review=false \
            --pr_reviewer.require_tests_review=false
