name: PR-Agent Review (Manual)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  pr-agent:
    runs-on: ubuntu-latest
    # Only run when someone comments with /spirit command on a PR
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '/spirit') }}
    steps:
      - name: Generate token for spirit-of-the-diff
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SPIRIT_APP_ID }}
          private-key: ${{ secrets.SPIRIT_PRIVATE_KEY }}

      - name: Rewrite event payload to use /review command
        run: |
          # PR-Agent reads the GitHub event payload to get the comment body
          # We need to rewrite /spirit to /review so PR-Agent recognizes it
          EVENT_PATH="${{ github.event_path }}"

          # Read current event payload
          EVENT_JSON=$(cat "$EVENT_PATH")

          # Replace /spirit with /review in the comment body
          MODIFIED_JSON=$(echo "$EVENT_JSON" | jq '.comment.body = (.comment.body | sub("^/spirit"; "/review"))')

          # Write modified payload back
          echo "$MODIFIED_JSON" > "$EVENT_PATH"

          echo "Modified comment body in event payload from /spirit to /review"

      - name: PR-Agent action
        uses: qodo-ai/pr-agent@main
        env:
          # OpenRouter configuration (PR-Agent reads OPENROUTER.KEY and sets OPENROUTER_API_KEY internally)
          OPENROUTER.KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # Mistral Devstral - Code-optimized, FREE (LiteLLM requires openrouter/ prefix)
          config.model: "openrouter/mistralai/devstral-2512:free"
          config.fallback_models: '["openrouter/mistralai/mistral-7b-instruct:free"]'
          config.custom_model_max_tokens: "262144"
          # Use spirit-of-the-diff bot token
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
          # Optional: customize behavior
          PR_REVIEWER.AUTO_REVIEW: "false"
          PR_REVIEWER.REQUIRE_TESTS_REVIEW: "false"
