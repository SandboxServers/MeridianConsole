name: PR-Agent Review (Manual)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  pr-agent:
    runs-on: ubuntu-latest
    # Only run when someone comments with /spirit command on a PR
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '/spirit') }}
    steps:
      - name: Generate token for spirit-of-the-diff
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SPIRIT_APP_ID }}
          private-key: ${{ secrets.SPIRIT_PRIVATE_KEY }}

      - name: PR-Agent action
        uses: qodo-ai/pr-agent@main
        env:
          # OpenRouter configuration (PR-Agent reads OPENROUTER.KEY and sets OPENROUTER_API_KEY internally)
          OPENROUTER.KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # Mistral Devstral - Code-optimized, FREE (LiteLLM requires openrouter/ prefix)
          config.model: "openrouter/mistralai/devstral-2512:free"
          config.fallback_models: '["openrouter/mistralai/mistral-7b-instruct:free"]'
          config.custom_model_max_tokens: "262144"
          # Use spirit-of-the-diff bot token
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
          # Tell PR-Agent to run review command (triggered by /spirit in GitHub)
          GITHUB_ACTION: "review"
          # Optional: customize behavior
          PR_REVIEWER.AUTO_REVIEW: "false"
          PR_REVIEWER.REQUIRE_TESTS_REVIEW: "false"
