@page "/dependencies"
@implements IDisposable
@inject DependencyGraphService GraphService
@inject IJSRuntime JS

<PageTitle>Dependency Map</PageTitle>

<div class="space-y-6">
    <MudPaper Class="rounded-2xl border border-white/10 bg-white/5 p-6" Elevation="0">
        <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
            <div>
                <MudText Typo="Typo.h4" Class="font-bold tracking-tight">Interactive Dependency Map</MudText>
                <MudText Typo="Typo.body1" Class="mt-2" Style="color: rgba(255,255,255,0.75);">
                    Click a node to inspect its responsibilities, endpoints, and relationships. Use search to jump.
                </MudText>
            </div>

            <div class="w-full md:w-96">
                <MudTextField @bind-Value="Query"
                              Label="Search"
                              Placeholder="Try: Gateway, RabbitMQ, Nodes..."
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Immediate="true"
                              Clearable="true"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              AdornmentColor="Color.Primary"
                              Class="rounded-xl"
                              Style="border-radius: 0.75rem; background: rgba(0,0,0,0.3);" />
            </div>
        </div>

        <!-- Phone tabs -->
        <div class="mt-4 flex md:hidden items-center gap-2">
            <MudButtonGroup OverrideStyles="false" Class="w-full rounded-2xl border border-white/10 bg-white/5 p-1">
                <MudButton OnClick='() => SetMobileView("graph")'
                           Variant="@(_mobileView == "graph" ? Variant.Filled : Variant.Text)"
                           Color="Color.Default"
                           Class="flex-1 rounded-xl"
                           Style="@GetMobileTabStyle("graph")">
                    Graph
                </MudButton>
                <MudButton OnClick='() => SetMobileView("details")'
                           Variant="@(_mobileView == "details" ? Variant.Filled : Variant.Text)"
                           Color="Color.Default"
                           Class="flex-1 rounded-xl"
                           Style="@GetMobileTabStyle("details")">
                    Details
                </MudButton>
            </MudButtonGroup>
        </div>
    </MudPaper>

    <div class="grid gap-4 lg:grid-cols-3">
        <!-- Graph panel -->
        <MudPaper Class="@($"lg:col-span-2 rounded-2xl border border-white/10 bg-white/5 p-3 {GraphPanelExtraClass}")" Elevation="0">
            <div class="flex flex-wrap items-center justify-between gap-2 px-2 pb-3">
                <div class="flex flex-wrap gap-2">
                    <MudChip T="string" Size="Size.Small" Style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7);">Scroll / pinch to zoom</MudChip>
                    <MudChip T="string" Size="Size.Small" Style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7);">Drag nodes</MudChip>
                    <MudChip T="string" Size="Size.Small" Style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7);">Tap background to clear</MudChip>
                </div>

                <div class="flex flex-wrap gap-2">
                    <MudButton OnClick="FitGraphAsync"
                               Variant="Variant.Filled"
                               Size="Size.Small"
                               Class="rounded-xl"
                               Style="background: rgba(255,255,255,0.1); text-transform: none;">
                        Fit
                    </MudButton>
                    <MudButton OnClick="ResetGraphAsync"
                               Variant="Variant.Filled"
                               Size="Size.Small"
                               Class="rounded-xl"
                               Style="background: rgba(255,255,255,0.1); text-transform: none;">
                        Reset
                    </MudButton>
                    <MudButton OnClick="ToggleDrawer"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               Class="hidden md:inline-flex lg:hidden rounded-xl font-semibold"
                               Style="text-transform: none;">
                        Details
                    </MudButton>
                </div>
            </div>

            <div id="@GraphContainerId" class="h-[70vh] w-full rounded-xl bg-black/30"></div>

            @if (_initError)
            {
                <MudAlert Severity="Severity.Warning" Class="mt-3 rounded-xl" Dense="true">
                    Graph renderer failed to initialize. If you're behind a strict network, the Cytoscape CDN may be blocked.
                    Check DevTools console for details.
                </MudAlert>
            }
        </MudPaper>

        <!-- Desktop details panel -->
        <div class="hidden lg:block">
            <DependencyDetailsPanel Selected="_selected"
                                    SelectByName="SelectByNameAsync"
                                    Clear="ClearSelectionAsync"
                                    Class="rounded-2xl border border-white/10 bg-white/5 p-6" />
        </div>
    </div>

    <!-- Phone details panel (tabbed) -->
    <div class="@PhoneDetailsExtraClass">
        <DependencyDetailsPanel Selected="_selected"
                                SelectByName="SelectByNameAsync"
                                Clear="ClearSelectionAsync"
                                Class="rounded-2xl border border-white/10 bg-white/5 p-6" />
    </div>
</div>

<!-- Tablet drawer (md to lg) -->
<MudOverlay @bind-Visible="_drawerOpen" OnClick="CloseDrawer" ZIndex="49" Class="hidden md:block lg:hidden" />
<div class="@TabletDrawerRootClass">
    <div class="@TabletDrawerPanelClass">
        <div class="flex items-center justify-between">
            <MudText Typo="Typo.body2" Class="font-semibold" Style="color: rgba(255,255,255,0.8);">Details</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.Close"
                           Size="Size.Small"
                           OnClick="CloseDrawer"
                           Style="border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05);"
                           aria-label="Close details" />
        </div>

        <div class="mt-4 overflow-auto">
            <DependencyDetailsPanel Selected="_selected"
                                    SelectByName="SelectByNameAsync"
                                    Clear="ClearSelectionAsync"
                                    Class="rounded-2xl border border-white/10 bg-white/5 p-4" />
        </div>
    </div>
</div>

@code {
    private const string GraphContainerId = "dhadgar-dependency-graph";

    private DependencyGraphData? _data;
    private DependencyNode? _selected;
    private DotNetObjectReference<Dependencies>? _dotNetRef;
    private bool _initialized;
    private bool _initError;
    private bool _drawerOpen;
    private string _mobileView = "graph";
private string _query = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _data = await GraphService.GetAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Blazor may render once before OnInitializedAsync completes (async yield),
        // so we initialize the JS graph the first time we have data.
        if (_initialized) return;
        if (_data is null) return;

        _dotNetRef = DotNetObjectReference.Create(this);

        try
        {
            await JS.InvokeVoidAsync("dhadgarDeps.init", GraphContainerId, _data, _dotNetRef);
            _initialized = true;

            if (!string.IsNullOrWhiteSpace(_query))
            {
                await JS.InvokeVoidAsync("dhadgarDeps.search", _query);
            }
        }
        catch (JSException)
        {
            // If JS fails (e.g., CDN blocked), keep page usable and show a hint.
            _initialized = false;
            _initError = true;
            StateHasChanged();
        }
    }


    private string GraphPanelExtraClass => _mobileView == "details" ? "hidden md:block" : string.Empty;

    private string PhoneDetailsExtraClass => $"md:hidden {( _mobileView == "details" ? "" : "hidden" )}";

    private string TabletDrawerRootClass => $"fixed inset-0 z-50 hidden md:block lg:hidden {( _drawerOpen ? "" : "pointer-events-none" )}";

    private string TabletDrawerBackdropClass => $"absolute inset-0 bg-black/60 transition-opacity duration-200 {( _drawerOpen ? "opacity-100" : "opacity-0" )}";

    private string TabletDrawerPanelClass => $"absolute bottom-0 left-0 right-0 max-h-[70vh] rounded-t-2xl border-t border-white/10 bg-slate-950/90 p-4 shadow-2xl backdrop-blur transition-transform duration-200 {( _drawerOpen ? "translate-y-0" : "translate-y-full" )}";

    private string TabClass(string view)
        => $"flex-1 rounded-xl px-4 py-2 text-sm font-semibold {( _mobileView == view ? "bg-white/10 text-white" : "text-white/70 hover:bg-white/5" )}";

    private string GetMobileTabStyle(string view)
        => _mobileView == view
            ? "background: rgba(255,255,255,0.1); text-transform: none;"
            : "text-transform: none;";

    private void SetMobileView(string view)
    {
        _mobileView = view;
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private Task CloseDrawer()
    {
        _drawerOpen = false;
        return Task.CompletedTask;
    }

    private async Task FitGraphAsync()
    {
        if (_initialized)
            await JS.InvokeVoidAsync("dhadgarDeps.fit");
    }

    private async Task ResetGraphAsync()
    {
        if (_initialized)
            await JS.InvokeVoidAsync("dhadgarDeps.reset");
    }


    private string Query
    {
        get => _query;
        set
        {
            _query = value ?? string.Empty;
            if (_initialized)
            {
                _ = JS.InvokeVoidAsync("dhadgarDeps.search", _query);
            }
        }
    }

    [JSInvokable]
    public Task OnNodeSelected(string nodeId)
    {
        if (_data is null) return Task.CompletedTask;

        _selected = _data.Nodes.FirstOrDefault(n => n.Id == nodeId);
        _drawerOpen = _selected is not null;
        _mobileView = _selected is not null ? "details" : _mobileView;
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnBackgroundClicked()
    {
        _selected = null;
        _drawerOpen = false;
        _mobileView = "graph";
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task SelectByNameAsync(string name)
    {
        if (_data is null) return;

        var node = _data.Nodes.FirstOrDefault(n => string.Equals(n.Name, name, StringComparison.OrdinalIgnoreCase));
        if (node is null) return;

        _selected = node;
        StateHasChanged();

        if (_initialized)
        {
            await JS.InvokeVoidAsync("dhadgarDeps.select", node.Id);
        }
    }

    private async Task ClearSelectionAsync()
    {
        _selected = null;
        _drawerOpen = false;
        _mobileView = "graph";
        StateHasChanged();

        if (_initialized)
        {
            await JS.InvokeVoidAsync("dhadgarDeps.clear");
        }
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }
}
