@page "/dependencies"
@implements IDisposable
@inject DependencyGraphService GraphService
@inject IJSRuntime JS

<PageTitle>Dependency Map</PageTitle>

<div class="space-y-6">
    <div class="rounded-2xl border border-white/10 bg-white/5 p-6">
        <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">Interactive Dependency Map</h1>
                <p class="mt-2 text-white/75">
                    Click a node to inspect its responsibilities, endpoints, and relationships. Use search to jump.
                </p>
            </div>

            <div class="w-full md:w-96">
                <label class="block text-xs font-semibold tracking-wide text-white/60">Search</label>
                <input class="mt-1 w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="Try: Gateway, RabbitMQ, Nodes…"
                       @bind="Query"
                       @bind:event="oninput" />
            </div>
        </div>

        <!-- Phone tabs -->
        <div class="mt-4 flex md:hidden items-center gap-2 rounded-2xl border border-white/10 bg-white/5 p-1">
            <button class='@TabClass("graph")' @onclick='() => SetMobileView("graph")'>Graph</button>
            <button class='@TabClass("details")' @onclick='() => SetMobileView("details")'>Details</button>
        </div>
    </div>

    <div class="grid gap-4 lg:grid-cols-3">
        <!-- Graph panel -->
        <div class="lg:col-span-2 rounded-2xl border border-white/10 bg-white/5 p-3 @GraphPanelExtraClass">
            <div class="flex flex-wrap items-center justify-between gap-2 px-2 pb-3">
                <div class="flex flex-wrap gap-2 text-xs text-white/70">
                    <span class="rounded-full bg-white/5 px-2 py-1">Scroll / pinch to zoom</span>
                    <span class="rounded-full bg-white/5 px-2 py-1">Drag nodes</span>
                    <span class="rounded-full bg-white/5 px-2 py-1">Tap background to clear</span>
                </div>

                <div class="flex flex-wrap gap-2">
                    <button class="rounded-xl bg-white/10 px-3 py-2 text-xs hover:bg-white/15"
                            @onclick="FitGraphAsync">
                        Fit
                    </button>
                    <button class="rounded-xl bg-white/10 px-3 py-2 text-xs hover:bg-white/15"
                            @onclick="ResetGraphAsync">
                        Reset
                    </button>
                    <button class="hidden md:inline-flex lg:hidden rounded-xl bg-indigo-500 px-3 py-2 text-xs font-semibold text-white hover:bg-indigo-400"
                            @onclick="ToggleDrawer">
                        Details
                    </button>
                </div>
            </div>

            <div id="@GraphContainerId" class="h-[70vh] w-full rounded-xl bg-black/30"></div>

            @if (_initError)
            {
                <div class="mt-3 rounded-xl border border-amber-500/30 bg-amber-500/10 p-3 text-sm text-amber-200">
                    Graph renderer failed to initialize. If you’re behind a strict network, the Cytoscape CDN may be blocked.
                    Check DevTools console for details.
                </div>
            }
        </div>

        <!-- Desktop details panel -->
        <div class="hidden lg:block">
            <DependencyDetailsPanel Selected="_selected"
                                    SelectByName="SelectByNameAsync"
                                    Clear="ClearSelectionAsync"
                                    Class="rounded-2xl border border-white/10 bg-white/5 p-6" />
        </div>
    </div>

    <!-- Phone details panel (tabbed) -->
    <div class="@PhoneDetailsExtraClass">
        <DependencyDetailsPanel Selected="_selected"
                                SelectByName="SelectByNameAsync"
                                Clear="ClearSelectionAsync"
                                Class="rounded-2xl border border-white/10 bg-white/5 p-6" />
    </div>
</div>

<!-- Tablet drawer (md → lg) -->
<div class="@TabletDrawerRootClass">
    <div class="@TabletDrawerBackdropClass" @onclick="CloseDrawer"></div>
    <div class="@TabletDrawerPanelClass">
        <div class="flex items-center justify-between">
            <div class="text-sm font-semibold text-white/80">Details</div>
            <button class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm hover:bg-white/10"
                    @onclick="CloseDrawer"
                    aria-label="Close details">
                ✕
            </button>
        </div>

        <div class="mt-4 overflow-auto">
            <DependencyDetailsPanel Selected="_selected"
                                    SelectByName="SelectByNameAsync"
                                    Clear="ClearSelectionAsync"
                                    Class="rounded-2xl border border-white/10 bg-white/5 p-4" />
        </div>
    </div>
</div>

@code {
    private const string GraphContainerId = "dhadgar-dependency-graph";

    private DependencyGraphData? _data;
    private DependencyNode? _selected;
    private DotNetObjectReference<Dependencies>? _dotNetRef;
    private bool _initialized;
    private bool _initError;
    private bool _drawerOpen;
    private string _mobileView = "graph";
private string _query = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _data = await GraphService.GetAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Blazor may render once before OnInitializedAsync completes (async yield),
        // so we initialize the JS graph the first time we have data.
        if (_initialized) return;
        if (_data is null) return;

        _dotNetRef = DotNetObjectReference.Create(this);

        try
        {
            await JS.InvokeVoidAsync("dhadgarDeps.init", GraphContainerId, _data, _dotNetRef);
            _initialized = true;

            if (!string.IsNullOrWhiteSpace(_query))
            {
                await JS.InvokeVoidAsync("dhadgarDeps.search", _query);
            }
        }
        catch (JSException)
        {
            // If JS fails (e.g., CDN blocked), keep page usable and show a hint.
            _initialized = false;
            _initError = true;
            StateHasChanged();
        }
    }


    private string GraphPanelExtraClass => _mobileView == "details" ? "hidden md:block" : string.Empty;

    private string PhoneDetailsExtraClass => $"md:hidden {( _mobileView == "details" ? "" : "hidden" )}";

    private string TabletDrawerRootClass => $"fixed inset-0 z-50 hidden md:block lg:hidden {( _drawerOpen ? "" : "pointer-events-none" )}";

    private string TabletDrawerBackdropClass => $"absolute inset-0 bg-black/60 transition-opacity duration-200 {( _drawerOpen ? "opacity-100" : "opacity-0" )}";

    private string TabletDrawerPanelClass => $"absolute bottom-0 left-0 right-0 max-h-[70vh] rounded-t-2xl border-t border-white/10 bg-slate-950/90 p-4 shadow-2xl backdrop-blur transition-transform duration-200 {( _drawerOpen ? "translate-y-0" : "translate-y-full" )}";

    private string TabClass(string view)
        => $"flex-1 rounded-xl px-4 py-2 text-sm font-semibold {( _mobileView == view ? "bg-white/10 text-white" : "text-white/70 hover:bg-white/5" )}";

    private void SetMobileView(string view)
    {
        _mobileView = view;
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private Task CloseDrawer()
    {
        _drawerOpen = false;
        return Task.CompletedTask;
    }

    private async Task FitGraphAsync()
    {
        if (_initialized)
            await JS.InvokeVoidAsync("dhadgarDeps.fit");
    }

    private async Task ResetGraphAsync()
    {
        if (_initialized)
            await JS.InvokeVoidAsync("dhadgarDeps.reset");
    }


    private string Query
    {
        get => _query;
        set
        {
            _query = value ?? string.Empty;
            if (_initialized)
            {
                _ = JS.InvokeVoidAsync("dhadgarDeps.search", _query);
            }
        }
    }

    [JSInvokable]
    public Task OnNodeSelected(string nodeId)
    {
        if (_data is null) return Task.CompletedTask;

        _selected = _data.Nodes.FirstOrDefault(n => n.Id == nodeId);
        _drawerOpen = _selected is not null;
        _mobileView = _selected is not null ? "details" : _mobileView;
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnBackgroundClicked()
    {
        _selected = null;
        _drawerOpen = false;
        _mobileView = "graph";
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task SelectByNameAsync(string name)
    {
        if (_data is null) return;

        var node = _data.Nodes.FirstOrDefault(n => string.Equals(n.Name, name, StringComparison.OrdinalIgnoreCase));
        if (node is null) return;

        _selected = node;
        StateHasChanged();

        if (_initialized)
        {
            await JS.InvokeVoidAsync("dhadgarDeps.select", node.Id);
        }
    }

    private async Task ClearSelectionAsync()
    {
        _selected = null;
        _drawerOpen = false;
        _mobileView = "graph";
        StateHasChanged();

        if (_initialized)
        {
            await JS.InvokeVoidAsync("dhadgarDeps.clear");
        }
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }
}
