@page "/database-schemas"
@inject Dhadgar.Scope.Services.DbSchemaCatalogService CatalogService

<PageTitle>Database Schemas</PageTitle>

<div class="space-y-6">
    <div class="rounded-2xl border border-white/10 bg-white/5 p-6">
        <div class="flex flex-col gap-4 xl:flex-row xl:items-end xl:justify-between">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">Database Schemas Explorer</h1>
                <p class="mt-2 text-white/75 max-w-3xl">
                    Each microservice owns its own schema (dot model). In SaaS, schemas live in separate DBs; in KiP, schemas live together in one DB.
                    This explorer is designed to match an EF Core implementation.
                </p>
            </div>

            <div class="w-full xl:w-[32rem]">
                <label class="block text-xs font-semibold tracking-wide text-white/60">Search</label>
                <input class="mt-1 w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="Try: identity.users, servers.game_servers…"
                       @bind="Query"
                       @bind:event="oninput" />
            </div>
        </div>

        <div class="mt-5 grid gap-4 lg:grid-cols-3">
            <div class="space-y-3 lg:col-span-2">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div class="flex-1 min-w-[12rem]">
                        <label class="block text-xs font-semibold tracking-wide text-white/60">Service</label>
                        <select class="mt-1 w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white"
                                @bind="ServiceKey" @bind:after="OnServiceChanged" style="color-scheme: dark;">
                            <option value="">All services</option>
                            @if (_catalog is not null)
                            {
                                @foreach (var s in _catalog.Services.OrderBy(s => s.Name))
                                {
                                    <option value="@s.Key">@s.Name (@s.Schema)</option>
                                }
                            }
                        </select>
                    </div>
                </div>

                <div class="rounded-2xl border border-white/10 bg-black/20 p-4 h-[70vh] md:h-[72vh] lg:h-[75vh] overflow-auto">
                    @if (_catalog is null)
                    {
                        <div class="text-sm text-white/70">Loading…</div>
                    }
                    else
                    {
                        @foreach (var group in TreeGroups)
                        {
                            <details class="mb-3 rounded-xl border border-white/10 bg-white/5 p-3">
                                <summary class="cursor-pointer text-sm font-semibold text-white/80">
                                    @group.ServiceName
                                    <span class="ml-2 text-xs text-white/50">(@group.Schema)</span>
                                </summary>
                                <div class="mt-3 space-y-3">
                                    @foreach (var kindGroup in group.Kinds)
                                    {
                                        <details class="rounded-xl border border-white/10 bg-black/30 p-3">
                                            <summary class="cursor-pointer text-xs font-semibold text-white/70 uppercase tracking-wide">
                                                @kindGroup.Kind (@kindGroup.Items.Count)
                                            </summary>
                                            <div class="mt-2 space-y-2">
                                                @foreach (var item in kindGroup.Items)
                                                {
                                                    <button class="w-full text-left rounded-xl border border-white/10 bg-black/40 px-3 py-2 text-sm text-white/85 hover:bg-white/10"
                                                            @onclick="() => SelectItem(item)">
                                                        <div class="font-semibold">@item.Id</div>
                                                        @if (item.Details?.Count > 0)
                                                        {
                                                            <div class="mt-1 text-xs text-white/60 line-clamp-2">@item.Details.First()</div>
                                                        }
                                                    </button>
                                                }
                                            </div>
                                        </details>
                                    }
                                </div>
                            </details>
                        }
                    }
                </div>

                <!-- Mobile tabs -->
                <div class="mt-3 flex md:hidden items-center gap-2 rounded-2xl border border-white/10 bg-white/5 p-1">
                    <button class='@TabClass("details")' @onclick='() => SetMobileView("details")'>Details</button>
                </div>
            </div>

            <div class="space-y-4 @DetailsPanelExtraClass">
                <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-sm font-semibold text-white/80">Selected item</div>
                        @if (_selected is not null)
                        {
                            <button class="rounded-xl bg-white/10 px-3 py-2 text-xs hover:bg-white/15"
                                    @onclick="ClearSelection">Clear</button>
                        }
                    </div>

                    @if (_selected is null)
                    {
                        <div class="mt-3 text-sm text-white/70">Tap a table/view/function/enum to see details.</div>
                    }
                    else
                    {
                        <div class="mt-4">
                            <div class="text-xl font-bold text-white">@_selected.Id</div>
                            <div class="mt-1 text-xs text-white/60 uppercase tracking-wide">@_selected.Kind</div>

                            <div class="mt-4 space-y-2 text-sm text-white/75">
                                @foreach (var d in _selected.Details)
                                {
                                    <div class="rounded-xl border border-white/10 bg-black/20 px-3 py-2 font-mono text-xs whitespace-pre-wrap">@d</div>
                                }
                            </div>
                        </div>
                    }
                </div>

                @if (_catalog?.Notes?.Count > 0)
                {
                    <div class="hidden lg:block rounded-2xl border border-white/10 bg-white/5 p-5">
                        <div class="text-sm font-semibold text-white/80">Notes</div>
                        <ul class="mt-3 list-disc pl-5 text-sm text-white/75 space-y-2">
                            @foreach (var n in _catalog.Notes)
                            {
                                <li>@n</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private Dhadgar.Scope.Services.DbSchemaCatalog? _catalog;
    private Dhadgar.Scope.Services.DbSchemaItem? _selected;

    private string Query { get; set; } = string.Empty;
    private string ServiceKey { get; set; } = string.Empty;

    private string _mobileView = "details";
    private string DetailsPanelExtraClass => _mobileView == "details" ? "" : "hidden md:block";

    protected override async Task OnInitializedAsync()
    {
        _catalog = await CatalogService.GetAsync();
    }

    private async Task OnServiceChanged()
    {
        await Task.CompletedTask;
    }

    private string TabClass(string v)
        => $"flex-1 rounded-xl px-3 py-2 text-xs font-semibold {( _mobileView == v ? "bg-indigo-500 text-white" : "bg-white/5 text-white/80 hover:bg-white/10" )}";

    private void SetMobileView(string v) => _mobileView = v;

    private void ClearSelection()
    {
        _selected = null;
    }

    private void SelectItem(Dhadgar.Scope.Services.DbSchemaItem item)
    {
        _selected = item;
        _mobileView = "details";
    }

    private string NormalizeSearch(string? value)
        => (value ?? string.Empty).Trim().ToLowerInvariant();

    private bool ItemMatches(Dhadgar.Scope.Services.DbSchemaItem item)
    {
        var query = NormalizeSearch(Query);
        if (string.IsNullOrWhiteSpace(query)) return true;

        if ((item.Id ?? string.Empty).ToLowerInvariant().Contains(query)) return true;
        if ((item.Kind ?? string.Empty).ToLowerInvariant().Contains(query)) return true;
        if (item.Details.Any(d => NormalizeSearch(d).Contains(query))) return true;
        return false;
    }

    private IEnumerable<(string ServiceName, string Schema, List<(string Kind, List<Dhadgar.Scope.Services.DbSchemaItem> Items)> Kinds)> TreeGroups
    {
        get
        {
            if (_catalog is null) return Array.Empty<(string, string, List<(string, List<Dhadgar.Scope.Services.DbSchemaItem>)>)>();

            var services = _catalog.Services.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(ServiceKey))
            {
                services = services.Where(s => s.Key == ServiceKey);
            }

            var query = NormalizeSearch(Query);

            return services
                .Select(s =>
                {
                    var items = s.Items.Where(ItemMatches).ToList();
                    if (!items.Any() && !string.IsNullOrWhiteSpace(query))
                        return (ServiceName: s.Name, Schema: s.Schema, Kinds: new List<(string, List<Dhadgar.Scope.Services.DbSchemaItem>)>());

                    var kinds = items
                        .GroupBy(i => i.Kind ?? "table")
                        .Select(g => (Kind: g.Key, Items: g.OrderBy(i => i.Id).ToList()))
                        .OrderBy(g => g.Kind)
                        .ToList();

                    return (ServiceName: s.Name, Schema: s.Schema, Kinds: kinds);
                })
                .Where(s => s.Kinds.Count > 0)
                .OrderBy(s => s.ServiceName)
                .ToList();
        }
    }

}
