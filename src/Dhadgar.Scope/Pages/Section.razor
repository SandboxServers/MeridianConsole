@page "/s/{Slug}"
@using Dhadgar.Scope.Services
@inject ScopeContentService ContentService
@inject NavigationManager Nav

<PageTitle>@_section?.Title</PageTitle>

@if (_section is null)
{
    <div class="p-6 text-white/80">Section not found.</div>
}
else
{
    <div class="space-y-4">
        <!-- Breadcrumb + story controls -->
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="min-w-0">
                    <div class="text-xs font-semibold tracking-wide text-white/60">Scope • Story Mode</div>
                    <div class="mt-1 flex flex-wrap items-center gap-2 text-sm text-white/80">
                        <a class="rounded-full bg-white/5 px-3 py-1 hover:bg-white/10"
                           href="/">
                            Contents
                        </a>
                        <span class="text-white/40">/</span>
                        <span class="truncate">
                            <span class="font-semibold text-white">@_section.Number.</span>
                            <span class="font-semibold text-indigo-200">@_section.Title</span>
                        </span>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <a class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs hover:bg-white/10 @(PrevHref is null ? "pointer-events-none opacity-40" : "")"
                       href="@PrevHref">
                        ◀ Prev
                    </a>
                    <a class="rounded-xl border border-white/10 bg-indigo-500 px-3 py-2 text-xs font-semibold text-white hover:bg-indigo-400 @(NextHref is null ? "pointer-events-none opacity-40" : "")"
                       href="@NextHref">
                        Next ▶
                    </a>
                </div>
            </div>

            <div class="mt-3">
                <div class="h-1.5 w-full rounded-full bg-white/10 overflow-hidden">
                    <div class="h-full rounded-full bg-indigo-500" style="width:@Progress%"></div>
                </div>
                <div class="mt-2 text-xs text-white/60">@ProgressText</div>
            </div>
        </div>

        <DynamicComponent Type="@_section.ComponentType" />
    </div>

    <!-- Sticky bottom nav for phones -->
    <div class="md:hidden fixed bottom-4 left-4 right-4 z-40">
        <div class="rounded-2xl border border-white/10 bg-black/60 backdrop-blur px-3 py-2 flex items-center justify-between gap-2">
            <a class="flex-1 text-center rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-white/90 hover:bg-white/10 @(PrevHref is null ? "pointer-events-none opacity-40" : "")"
               href="@PrevHref">
                ◀ Prev
            </a>
            <a class="flex-1 text-center rounded-xl bg-indigo-500 px-3 py-2 text-xs font-semibold text-white hover:bg-indigo-400 @(NextHref is null ? "pointer-events-none opacity-40" : "")"
               href="@NextHref">
                Next ▶
            </a>
        </div>
    </div>
}

@code {
    [Parameter] public string? Slug { get; set; }

    private ScopeSectionInfo? _section;
    private List<ScopeSectionInfo> _all = new();

    private string? PrevHref { get; set; }
    private string? NextHref { get; set; }
    private string Progress => _all.Count == 0 ? "0" : Math.Round(((double)_section!.Number / _all.Count) * 100, 0).ToString();
    private string ProgressText => _all.Count == 0 ? "" : $"Section {_section!.Number} of {_all.Count}";

    protected override async Task OnParametersSetAsync()
    {
        _all = (await ContentService.GetSectionsAsync()).ToList();
        _section = _all.FirstOrDefault(s => s.Slug.Equals(Slug, StringComparison.OrdinalIgnoreCase));

        if (_section is null)
        {
            PrevHref = null;
            NextHref = null;
            return;
        }

        var idx = _all.FindIndex(s => s.Slug == _section.Slug);
        PrevHref = idx > 0 ? $"/s/{_all[idx - 1].Slug}" : null;
        NextHref = idx >= 0 && idx < _all.Count - 1 ? $"/s/{_all[idx + 1].Slug}" : null;
    }
}
