@page "/s/{Slug}"
@using Dhadgar.Scope.Services
@inject ScopeContentService ContentService
@inject NavigationManager Nav

<PageTitle>@_section?.Title</PageTitle>

@if (_section is null)
{
    <MudPaper Class="rounded-2xl border border-white/10 bg-white/5 p-6" Elevation="0">
        <MudText Typo="Typo.body1" Style="color: rgba(255,255,255,0.8);">Section not found.</MudText>
    </MudPaper>
}
else
{
    <div class="space-y-4">
        <!-- Breadcrumb + story controls -->
        <MudPaper Class="rounded-2xl border border-white/10 bg-white/5 p-4" Elevation="0">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="min-w-0">
                    <MudText Typo="Typo.caption" Class="font-semibold tracking-wide" Style="color: rgba(255,255,255,0.6);">
                        Scope - Story Mode
                    </MudText>
                    <div class="mt-1 flex flex-wrap items-center gap-2 text-sm">
                        <MudButton Href="/"
                                   Variant="Variant.Text"
                                   Size="Size.Small"
                                   Class="rounded-full px-3 py-1"
                                   Style="background: rgba(255,255,255,0.05); text-transform: none; min-width: auto;">
                            Contents
                        </MudButton>
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.4);">/</MudText>
                        <span class="truncate">
                            <MudText Typo="Typo.body2" Class="font-semibold" Style="display: inline;">@_section.Number.</MudText>
                            <MudText Typo="Typo.body2" Class="font-semibold" Style="display: inline; color: #c7d2fe;">@_section.Title</MudText>
                        </span>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <MudButton Href="@PrevHref"
                               Variant="Variant.Outlined"
                               Size="Size.Small"
                               Disabled="@(PrevHref is null)"
                               Class="rounded-xl"
                               Style="border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); text-transform: none;">
                        <MudIcon Icon="@Icons.Material.Filled.ChevronLeft" Size="Size.Small" /> Prev
                    </MudButton>
                    <MudButton Href="@NextHref"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               Disabled="@(NextHref is null)"
                               Class="rounded-xl font-semibold"
                               Style="text-transform: none;">
                        Next <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" />
                    </MudButton>
                </div>
            </div>

            <div class="mt-3">
                <MudProgressLinear Value="@(double.Parse(Progress))"
                                   Color="Color.Primary"
                                   Rounded="true"
                                   Size="Size.Small"
                                   Style="height: 6px; background: rgba(255,255,255,0.1);" />
                <MudText Typo="Typo.caption" Class="mt-2" Style="color: rgba(255,255,255,0.6);">@ProgressText</MudText>
            </div>
        </MudPaper>

        <DynamicComponent Type="@_section.ComponentType" />
    </div>

    <!-- Sticky bottom nav for phones -->
    <div class="md:hidden fixed bottom-4 left-4 right-4 z-40">
        <MudPaper Class="rounded-2xl border border-white/10 px-3 py-2 flex items-center justify-between gap-2"
                  Elevation="0"
                  Style="background: rgba(0,0,0,0.6); backdrop-filter: blur(12px);">
            <MudButton Href="@PrevHref"
                       Variant="Variant.Outlined"
                       Size="Size.Small"
                       Disabled="@(PrevHref is null)"
                       FullWidth="true"
                       Class="flex-1 rounded-xl"
                       Style="border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); text-transform: none;">
                <MudIcon Icon="@Icons.Material.Filled.ChevronLeft" Size="Size.Small" /> Prev
            </MudButton>
            <MudButton Href="@NextHref"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Small"
                       Disabled="@(NextHref is null)"
                       FullWidth="true"
                       Class="flex-1 rounded-xl font-semibold"
                       Style="text-transform: none;">
                Next <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" />
            </MudButton>
        </MudPaper>
    </div>
}

@code {
    [Parameter] public string? Slug { get; set; }

    private ScopeSectionInfo? _section;
    private List<ScopeSectionInfo> _all = new();

    private string? PrevHref { get; set; }
    private string? NextHref { get; set; }
    private string Progress => _all.Count == 0 ? "0" : Math.Round(((double)_section!.Number / _all.Count) * 100, 0).ToString();
    private string ProgressText => _all.Count == 0 ? "" : $"Section {_section!.Number} of {_all.Count}";

    protected override async Task OnParametersSetAsync()
    {
        _all = (await ContentService.GetSectionsAsync()).ToList();
        _section = _all.FirstOrDefault(s => s.Slug.Equals(Slug, StringComparison.OrdinalIgnoreCase));

        if (_section is null)
        {
            PrevHref = null;
            NextHref = null;
            return;
        }

        var idx = _all.FindIndex(s => s.Slug == _section.Slug);
        PrevHref = idx > 0 ? $"/s/{_all[idx - 1].Slug}" : null;
        NextHref = idx >= 0 && idx < _all.Count - 1 ? $"/s/{_all[idx + 1].Slug}" : null;
    }
}
