@page "/architecture-explorer"
@implements IAsyncDisposable
@using System.Text.Json
@using Microsoft.JSInterop
@inject Dhadgar.Scope.Services.ArchitectureGraphService GraphService
@inject IJSRuntime JS

<PageTitle>System Architecture</PageTitle>

<div class="space-y-6">
    <div class="rounded-2xl border border-white/10 bg-white/5 p-6">
        <div class="flex flex-col gap-4 xl:flex-row xl:items-end xl:justify-between">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">System Architecture Explorer</h1>
                <p class="mt-2 text-white/75 max-w-3xl">
                    A modern “miniature build-out” view of the Meridian Console platform. Districts are real architectural planes,
                    not vibes. Use Tour Mode to walk the big flows.
                </p>
            </div>

            <div class="w-full xl:w-[32rem]">
                <label class="block text-xs font-semibold tracking-wide text-white/60">Search</label>
                <input class="mt-1 w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="Try: Gateway, RabbitMQ, BYO DB…"
                       @bind="Query"
                       @bind:event="oninput" @bind:after="OnQueryChanged" />
            </div>
        </div>

        <div class="mt-5 grid gap-4 lg:grid-cols-3">
            <div class="space-y-3 lg:col-span-2">
                <div class="flex flex-wrap items-center justify-between gap-2">
                    <div class="flex items-center gap-2">
                        <button class='@ViewClass("list")' @onclick='() => SetView("list")'>Tree</button>
                        <button class='@ViewClass("map")' @onclick='() => SetView("map")'>Map</button>
                    </div>

                    @if (_viewMode == "map")
                    {
                        <div class="flex flex-wrap gap-2 text-xs">
                            @foreach (var k in EdgeKinds)
                            {
                                var on = EnabledKinds.Contains(k);
                                <button class="rounded-full border border-white/10 px-3 py-1 @(on ? "bg-indigo-500 text-white" : "bg-white/5 text-white/80 hover:bg-white/10")"
                                        @onclick="() => ToggleKind(k)">
                                    @k
                                </button>
                            }
                        </div>

                        <div class="flex flex-wrap gap-2">
                            <button class="rounded-xl bg-white/10 px-3 py-2 text-xs hover:bg-white/15"
                                    @onclick="FitAsync">Fit</button>
                            <button class="rounded-xl bg-white/10 px-3 py-2 text-xs hover:bg-white/15"
                                    @onclick="ResetAsync">Reset</button>
                        </div>
                    }
                </div>

                @if (_viewMode == "map")
                {
                    <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
                        <div class="flex items-center justify-between gap-3 px-2 pb-2">
                            <div class="text-xs text-white/70">Explode districts</div>
                            <div class="text-xs text-white/60">@Explode%</div>
                        </div>
                        <input type="range" min="0" max="100" step="1" class="w-full accent-indigo-500"
                               value="@Explode" @oninput="OnExplodeChanged" />
                    </div>

                    <div class="@GraphPanelExtraClass rounded-2xl border border-white/10 bg-black/20 overflow-hidden h-[70vh] md:h-[72vh] lg:h-[75vh]"
                         @ref="_graphHost">
                    </div>
                }
                else
                {
                    <div class="rounded-2xl border border-white/10 bg-black/20 p-4 h-[70vh] md:h-[72vh] lg:h-[75vh] overflow-auto">
                        @if (_data is null)
                        {
                            <div class="text-sm text-white/70">Loading…</div>
                        }
                        else
                        {
                            @foreach (var group in TreeGroups)
                            {
                                <details class="mb-3 rounded-xl border border-white/10 bg-white/5 p-3">
                                    <summary class="cursor-pointer text-sm font-semibold text-white/80">
                                        @group.Name
                                        <span class="ml-2 text-xs text-white/50">(@group.Nodes.Count)</span>
                                    </summary>
                                    <div class="mt-3 space-y-2">
                                        @foreach (var node in group.Nodes)
                                        {
                                            <button class="w-full text-left rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white/85 hover:bg-white/10"
                                                    @onclick="() => SelectNode(node)">
                                                <div class="flex items-center gap-2">
                                                    <span>@node.Emoji</span>
                                                    <span class="font-semibold">@node.Name</span>
                                                </div>
                                                <div class="mt-1 text-xs text-white/60 line-clamp-2">@node.Description</div>
                                            </button>
                                        }
                                    </div>
                                </details>
                            }
                        }
                    </div>
                }
                

                <!-- Mobile tabs -->
                <div class="mt-3 flex md:hidden items-center gap-2 rounded-2xl border border-white/10 bg-white/5 p-1">
                    <button class='@TabClass("graph")' @onclick='() => SetMobileView("graph")'>Graph</button>
                    <button class='@TabClass("details")' @onclick='() => SetMobileView("details")'>Details</button>
                    <button class='@TabClass("tour")' @onclick='() => SetMobileView("tour")'>Tour</button>
                </div>
            </div>

            <div class="space-y-4 @DetailsPanelExtraClass">
                <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-sm font-semibold text-white/80">Selected node</div>
                        @if (_selected is not null)
                        {
                            <button class="rounded-xl bg-white/10 px-3 py-2 text-xs hover:bg-white/15"
                                    @onclick="ClearSelectionAsync">Clear</button>
                        }
                    </div>

                    @if (_selected is null)
                    {
                        <div class="mt-3 text-sm text-white/70">Tap a node to inspect responsibilities and endpoints.</div>
                    }
                    else
                    {
                        <div class="mt-4">
                            <div class="text-xl font-bold text-white flex items-center gap-2">
                                <span>@_selected.Emoji</span>
                                <span>@_selected.Name</span>
                            </div>
                            <div class="mt-2 text-sm text-white/70">@_selected.Description</div>

                            @if (_selected.Responsibilities.Count > 0)
                            {
                                <div class="mt-4">
                                    <div class="text-xs font-semibold text-white/60">Responsibilities</div>
                                    <ul class="mt-2 list-disc pl-5 text-sm text-white/75 space-y-1">
                                        @foreach (var r in _selected.Responsibilities)
                                        {
                                            <li>@r</li>
                                        }
                                    </ul>
                                </div>
                            }

                            @if (_selected.Ports.Count > 0)
                            {
                                <div class="mt-4">
                                    <div class="text-xs font-semibold text-white/60">Ports</div>
                                    <div class="mt-2 flex flex-wrap gap-2 text-xs">
                                        @foreach (var p in _selected.Ports)
                                        {
                                            <span class="rounded-full border border-white/10 bg-white/5 px-2 py-1 text-white/80">@p</span>
                                        }
                                    </div>
                                </div>
                            }

                            @if (_selected.Endpoints.Count > 0)
                            {
                                <div class="mt-4">
                                    <div class="text-xs font-semibold text-white/60">Endpoints</div>
                                    <ul class="mt-2 space-y-1 text-sm text-white/75">
                                        @foreach (var e in _selected.Endpoints)
                                        {
                                            <li><code class="rounded bg-black/30 px-1">@e</code></li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    }
                </div>

                <div class="rounded-2xl border border-white/10 bg-white/5 p-5 @TourPanelExtraClass">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-sm font-semibold text-white/80">Tour mode</div>
                        @if (_tourActive)
                        {
                            <button class="rounded-xl bg-white/10 px-3 py-2 text-xs hover:bg-white/15"
                                    @onclick="StopTourAsync">Stop</button>
                        }
                    </div>

                    @if (_data is null)
                    {
                        <div class="mt-3 text-sm text-white/70">Loading…</div>
                    }
                    else
                    {
                        <div class="mt-3">
                            <label class="block text-xs font-semibold tracking-wide text-white/60">Tour</label>
                            <select class="mt-1 w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white"
                                    @bind="_tourId" style="color-scheme: dark;">
                                @foreach (var t in _data.Tours)
                                {
                                    <option value="@t.Id">@t.Name</option>
                                }
                            </select>
                        </div>

                        <div class="mt-4 flex gap-2">
                            <button class="flex-1 rounded-xl bg-indigo-500 px-3 py-2 text-xs font-semibold text-white hover:bg-indigo-400"
                                    @onclick="StartTourAsync">
                                Start
                            </button>
                            <button class="rounded-xl bg-white/10 px-3 py-2 text-xs hover:bg-white/15"
                                    @onclick="PrevStepAsync"
                                    disabled="@(!_tourActive)">
                                ◀
                            </button>
                            <button class="rounded-xl bg-white/10 px-3 py-2 text-xs hover:bg-white/15"
                                    @onclick="NextStepAsync"
                                    disabled="@(!_tourActive)">
                                ▶
                            </button>
                        </div>

                        @if (_tourActive && _tourStep is not null)
                        {
                            <div class="mt-4 rounded-xl border border-white/10 bg-black/20 p-4">
                                <div class="text-sm font-bold text-white">@_tourStep.Title</div>
                                <div class="mt-2 text-sm text-white/70">@_tourStep.Body</div>
                                <div class="mt-3 text-xs text-white/60">Step @_tourIndex+1 of @_tourCount</div>
                            </div>
                        }
                    }
                </div>

                <div class="hidden lg:block rounded-2xl border border-white/10 bg-white/5 p-5">
                    <div class="text-sm font-semibold text-white/80">Legend</div>
                    <div class="mt-3 grid grid-cols-2 gap-2 text-xs text-white/75">
                        <div class="rounded-xl border border-white/10 bg-black/20 p-2">HTTP / gRPC</div>
                        <div class="rounded-xl border border-white/10 bg-black/20 p-2">WebSocket</div>
                        <div class="rounded-xl border border-white/10 bg-black/20 p-2">RabbitMQ (AMQP)</div>
                        <div class="rounded-xl border border-white/10 bg-black/20 p-2">Database</div>
                        <div class="rounded-xl border border-white/10 bg-black/20 p-2">DNS / Certs</div>
                        <div class="rounded-xl border border-white/10 bg-black/20 p-2">Other</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ElementReference _graphHost;
    private IReadOnlyList<string> EdgeKinds { get; } = new[] { "HTTP", "WSS", "AMQP", "DB", "DNS", "OTHER" };
    private HashSet<string> EnabledKinds { get; set; } = new(new[] { "HTTP", "WSS", "AMQP", "DB", "DNS", "OTHER" });

    private string Query { get; set; } = string.Empty;
    private int Explode { get; set; } = 35;

    private IJSObjectReference? _module;
    private DotNetObjectReference<ArchitectureExplorer>? _dotnetRef;
    private bool _initialized;
    private bool _pendingMapInit;
    private Dhadgar.Scope.Services.ArchitectureGraphData? _data;
    private Dhadgar.Scope.Services.ArchitectureNode? _selected;

    private string _mobileView = "graph";
    private string GraphPanelExtraClass => _mobileView == "graph" ? "" : "hidden md:block";
    private string DetailsPanelExtraClass => _mobileView == "details" ? "" : "hidden md:block";
    private string TourPanelExtraClass => _mobileView == "tour" ? "" : "hidden md:block";
    private string _viewMode = "list";

    private bool _tourActive;
    private string _tourId = "request_console";
    private int _tourIndex;
    private int _tourCount;
    private Dhadgar.Scope.Services.ArchitectureTourStep? _tourStep;

    protected override async Task OnInitializedAsync()
    {
        _data = await GraphService.GetAsync();
        _tourId = _data.Tours.FirstOrDefault()?.Id ?? "request_console";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_pendingMapInit || _viewMode != "map") return;
        if (_initialized) return;
        if (_data is null) return;

        _dotnetRef = DotNetObjectReference.Create(this);
        _module = await JS.InvokeAsync<IJSObjectReference>("import", "/js/architecturePark.module.js");
        await _module.InvokeVoidAsync("init", _graphHost, _data,
            new { mode = "full", selectable = true, dotNetRef = _dotnetRef });
        await _module.InvokeVoidAsync("fit", _graphHost);
        _initialized = true;
        _pendingMapInit = false;
        await ApplyStateAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await ApplyStateAsync();
    }

    private async Task OnQueryChanged()
    {
        await ApplyStateAsync();
    }

    private async Task OnExplodeChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var value))
        {
            Explode = value;
        }
        await ApplyStateAsync();
    }

    private async Task ApplyStateAsync()
    {
        if (_module is null) return;
        await _module.InvokeVoidAsync("setExplode", _graphHost, Explode);
        await _module.InvokeVoidAsync("setKinds", _graphHost, EnabledKinds.ToArray());
        await _module.InvokeVoidAsync("search", _graphHost, Query ?? string.Empty);
        if (_tourActive)
            await _module.InvokeVoidAsync("setTour", _graphHost, _tourId, _tourIndex);
    }

    private string TabClass(string v)
        => $"flex-1 rounded-xl px-3 py-2 text-xs font-semibold {( _mobileView == v ? "bg-indigo-500 text-white" : "bg-white/5 text-white/80 hover:bg-white/10" )}";

    private void SetMobileView(string v) => _mobileView = v;

    private string ViewClass(string v)
        => $"rounded-xl px-3 py-2 text-xs font-semibold {( _viewMode == v ? "bg-indigo-500 text-white" : "bg-white/5 text-white/80 hover:bg-white/10" )}";

    private void SetView(string v)
    {
        _viewMode = v;
        if (_viewMode == "map" && !_initialized)
        {
            _pendingMapInit = true;
        }
    }

    private async Task ToggleKind(string k)
    {
        if (EnabledKinds.Contains(k)) EnabledKinds.Remove(k);
        else EnabledKinds.Add(k);
        await ApplyStateAsync();
    }

    private async Task FitAsync()
    {
        if (_module is null) return;
        await _module.InvokeVoidAsync("fit", _graphHost);
    }

    private async Task ResetAsync()
    {
        Query = string.Empty;
        EnabledKinds = new HashSet<string>(EdgeKinds);
        Explode = 35;
        _tourActive = false;
        _tourIndex = 0;
        _tourStep = null;
        _selected = null;

        if (_module is not null)
            await _module.InvokeVoidAsync("reset", _graphHost);
        await ApplyStateAsync();
    }

    private async Task ClearSelectionAsync()
    {
        _selected = null;
        if (_module is not null)
            await _module.InvokeVoidAsync("clearSelection", _graphHost);
    }

    private async Task StartTourAsync()
    {
        if (_data is null) return;
        var tour = _data.Tours.FirstOrDefault(t => t.Id == _tourId) ?? _data.Tours.First();
        _tourActive = true;
        _tourIndex = 0;
        _tourCount = tour.Steps.Count;
        _tourStep = tour.Steps[_tourIndex];
        await ApplyStateAsync();
    }

    private async Task StopTourAsync()
    {
        _tourActive = false;
        _tourIndex = 0;
        _tourStep = null;
        if (_module is not null)
            await _module.InvokeVoidAsync("clearTour", _graphHost);
    }

    private async Task NextStepAsync()
    {
        if (!_tourActive || _data is null) return;
        var tour = _data.Tours.FirstOrDefault(t => t.Id == _tourId) ?? _data.Tours.First();
        _tourIndex = Math.Min(_tourIndex + 1, tour.Steps.Count - 1);
        _tourStep = tour.Steps[_tourIndex];
        await ApplyStateAsync();
    }

    private async Task PrevStepAsync()
    {
        if (!_tourActive || _data is null) return;
        var tour = _data.Tours.FirstOrDefault(t => t.Id == _tourId) ?? _data.Tours.First();
        _tourIndex = Math.Max(_tourIndex - 1, 0);
        _tourStep = tour.Steps[_tourIndex];
        await ApplyStateAsync();
    }

    private void SelectNode(Dhadgar.Scope.Services.ArchitectureNode node)
    {
        _selected = node;
        _mobileView = "details";
    }

    private string NormalizeSearch(string? value)
        => (value ?? string.Empty).Trim().ToLowerInvariant();

    private bool NodeMatches(Dhadgar.Scope.Services.ArchitectureNode node)
    {
        var query = NormalizeSearch(Query);
        if (string.IsNullOrWhiteSpace(query)) return true;

        if ((node.Name ?? string.Empty).ToLowerInvariant().Contains(query)) return true;
        if ((node.Description ?? string.Empty).ToLowerInvariant().Contains(query)) return true;
        if (node.Responsibilities.Any(r => NormalizeSearch(r).Contains(query))) return true;
        if (node.Endpoints.Any(e => NormalizeSearch(e).Contains(query))) return true;
        if (node.Ports.Any(p => NormalizeSearch(p.ToString()).Contains(query))) return true;
        if ((node.Kind ?? string.Empty).ToLowerInvariant().Contains(query)) return true;

        return false;
    }

    private IEnumerable<(string Name, List<Dhadgar.Scope.Services.ArchitectureNode> Nodes)> TreeGroups
    {
        get
        {
            if (_data is null) return Array.Empty<(string, List<Dhadgar.Scope.Services.ArchitectureNode>)>();

            var districtNames = _data.Districts.ToDictionary(d => d.Id, d => d.Name);
            var filtered = _data.Nodes
                .Where(NodeMatches)
                .GroupBy(n => n.District ?? string.Empty)
                .Select(g =>
                {
                    var name = districtNames.TryGetValue(g.Key, out var label) ? label : (string.IsNullOrWhiteSpace(g.Key) ? "Other" : g.Key);
                    return (Name: name, Nodes: g.OrderBy(n => n.Name).ToList());
                })
                .OrderBy(g => g.Name)
                .ToList();

            return filtered;
        }
    }

    [JSInvokable]
    public Task OnNodeSelected(string nodeId)
    {
        if (_data is null) return Task.CompletedTask;
        _selected = _data.Nodes.FirstOrDefault(n => n.Id == nodeId);
        _mobileView = "details";
        StateHasChanged();
        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_module is not null)
            {
                await _module.InvokeVoidAsync("dispose", _graphHost);
                await _module.DisposeAsync();
            }
        }
        catch { /* ignore */ }

        _dotnetRef?.Dispose();
    }
}
