<MudPaper Class="rounded-2xl border border-white/10 bg-white/5 p-6" Elevation="0">
    <MudText Typo="Typo.h4" Color="Color.Secondary" Class="font-bold mb-6 pb-2" Style="border-bottom: 1px solid rgba(192, 132, 252, 0.3);">
        13. RabbitMQ Topology
    </MudText>

    <MudPaper Class="rounded-xl p-4 mb-6" Style="background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.4);">
        <MudText Typo="Typo.body1" Style="color: rgba(59, 130, 246, 1);"><strong>üìã Message Bus Architecture</strong></MudText>
        <MudText Typo="Typo.body2" Class="mt-2" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">
            RabbitMQ serves as the central event backbone for asynchronous, event-driven communication between services. All queues, exchanges, and bindings are declared programmatically via .NET client libraries during service startup.
        </MudText>
    </MudPaper>

    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3">13.1 Exchange Strategy</MudText>
    <MudSimpleTable Dense="true" Hover="true" Class="mb-6 rounded-xl" Style="background: rgba(0,0,0,0.2);">
        <thead>
            <tr style="background: rgba(255,255,255,0.05);">
                <th style="color: white; padding: 12px;">Exchange Name</th>
                <th style="color: white; padding: 12px;">Type</th>
                <th style="color: white; padding: 12px;">Purpose</th>
                <th style="color: white; padding: 12px;">Routing Pattern</th>
            </tr>
        </thead>
        <tbody>
            <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">meridian.events</td><td class="font-mono" style="color: rgba(255,255,255,0.8); padding: 12px;">topic</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Platform-wide domain events</td><td class="font-mono" style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">{domain}.{entity}.{action}</td></tr>
            <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">meridian.commands</td><td class="font-mono" style="color: rgba(255,255,255,0.8); padding: 12px;">direct</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Command messages requiring single consumer</td><td class="font-mono" style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">{service}.{command}</td></tr>
            <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">meridian.notifications</td><td class="font-mono" style="color: rgba(255,255,255,0.8); padding: 12px;">fanout</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Broadcast notifications to all subscribers</td><td class="font-mono" style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">(no routing key)</td></tr>
            <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">meridian.dlx</td><td class="font-mono" style="color: rgba(255,255,255,0.8); padding: 12px;">topic</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Dead-letter exchange for failed messages</td><td class="font-mono" style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">{original.routing.key}</td></tr>
        </tbody>
    </MudSimpleTable>

    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3">12.2 Queue Naming Convention</MudText>
    <MudPaper Class="rounded-xl p-4 mb-6" Style="background: rgba(55, 65, 81, 1); border: 1px solid rgba(75, 85, 99, 1);">
        <MudText Typo="Typo.body2" Class="mb-3" Style="color: rgba(255,255,255,0.7);">All queues follow the pattern:</MudText>
        <MudPaper Class="rounded p-3 font-mono mb-3" Style="background: rgba(17, 24, 39, 1); color: rgba(74, 222, 128, 1); font-size: 0.875rem;" Elevation="0">
            {service-name}.{queue-purpose}[.{optional-discriminator}]
        </MudPaper>
        <MudText Typo="Typo.body2" Class="mb-2" Style="color: rgba(255,255,255,0.6); font-size: 0.875rem;"><strong style="color: white;">Examples:</strong></MudText>
        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">
            ‚Ä¢ <span class="font-mono" style="color: rgba(192, 132, 252, 1);">servers.state-sync</span> ‚Äî Server state change events<br/>
            ‚Ä¢ <span class="font-mono" style="color: rgba(192, 132, 252, 1);">billing.invoice-created</span> ‚Äî New invoice notifications<br/>
            ‚Ä¢ <span class="font-mono" style="color: rgba(192, 132, 252, 1);">tasks.backup-requested</span> ‚Äî Backup job commands<br/>
            ‚Ä¢ <span class="font-mono" style="color: rgba(192, 132, 252, 1);">notifications.email-outbound</span> ‚Äî Email delivery queue
        </MudText>
    </MudPaper>

    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3">12.3 Publishers & Consumers</MudText>
    <div style="overflow-x: auto;" class="mb-6">
        <MudSimpleTable Dense="true" Hover="true" Class="rounded-xl" Style="background: rgba(0,0,0,0.2);">
            <thead>
                <tr style="background: rgba(255,255,255,0.05);">
                    <th style="color: white; padding: 12px;">Queue Name</th>
                    <th style="color: white; padding: 12px;">Publisher(s)</th>
                    <th style="color: white; padding: 12px;">Consumer(s)</th>
                    <th style="color: white; padding: 12px;">Message Type</th>
                </tr>
            </thead>
            <tbody>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">servers.state-sync</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Servers, Nodes</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Console, Notifications</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">ServerStateChanged</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">billing.invoice-created</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Billing</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Notifications</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">InvoiceGenerated</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">billing.payment-received</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Billing</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Servers, Notifications</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">PaymentProcessed</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">identity.user-registered</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Identity</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Billing, Notifications</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">UserCreated</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">tasks.backup-requested</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Gateway, Servers</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Tasks</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">BackupCommand</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">tasks.restore-requested</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Gateway, Servers</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Tasks</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">RestoreCommand</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">tasks.update-requested</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Gateway, Servers</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Tasks</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">UpdateCommand</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">tasks.job-completed</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Tasks</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Servers, Notifications</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">JobFinished</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">files.upload-complete</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Files</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Mods, Servers</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">FileUploaded</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">mods.catalog-updated</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Mods</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Servers, Notifications</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">ModCatalogRefreshed</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">console.stream-events</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Nodes</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Console</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">ConsoleOutput</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">notifications.email-outbound</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Identity, Billing, Tasks</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Notifications</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">EmailRequest</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">notifications.webhook-outbound</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Servers, Billing, Tasks</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Notifications</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">WebhookDelivery</td></tr>
                <tr><td class="font-mono" style="color: rgba(192, 132, 252, 1); padding: 12px;">firewall.rule-sync</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Firewall</td><td style="color: rgba(255,255,255,0.8); padding: 12px;">Nodes</td><td style="color: rgba(255,255,255,0.8); padding: 12px; font-size: 0.875rem;">FirewallRuleUpdated</td></tr>
            </tbody>
        </MudSimpleTable>
    </div>

    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3">12.4 Dead Letter Queue (DLQ) Strategy</MudText>
    <MudPaper Class="rounded-xl p-4 mb-6" Style="background: rgba(234, 88, 12, 0.15); border: 1px solid rgba(234, 88, 12, 0.4);">
        <MudText Typo="Typo.body1" Style="color: rgba(251, 146, 60, 1);"><strong>‚ö†Ô∏è Failure Handling</strong></MudText>
        <MudText Typo="Typo.body2" Class="mt-3 mb-3" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">All application queues are configured with:</MudText>
        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">
            ‚Ä¢ <strong>x-message-ttl:</strong> 86400000 (24 hours)<br/>
            ‚Ä¢ <strong>x-dead-letter-exchange:</strong> meridian.dlx<br/>
            ‚Ä¢ <strong>x-dead-letter-routing-key:</strong> dlq.{original-queue-name}<br/>
            ‚Ä¢ <strong>Retry policy:</strong> 3 attempts with exponential backoff (1s, 5s, 15s)
        </MudText>
    </MudPaper>

    <MudPaper Class="rounded-xl p-4 mb-6" Style="background: rgba(55, 65, 81, 1); border: 1px solid rgba(75, 85, 99, 1);">
        <MudText Typo="Typo.body2" Class="mb-2" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;"><strong style="color: white;">DLQ Monitoring:</strong></MudText>
        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.6); font-size: 0.875rem;">Messages entering the DLX trigger alerts in Notifications service. Platform admins receive digest emails for DLQ depth > 10 messages.</MudText>
    </MudPaper>

    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3">12.5 Message Flow Examples</MudText>

    <MudText Typo="Typo.body1" Color="Color.Info" Class="mb-2">Example 1: Server Creation Flow</MudText>
    <MudPaper Class="rounded-xl p-4 mb-4 font-mono" Style="background: rgba(17, 24, 39, 1); color: rgba(255,255,255,0.7); font-size: 0.75rem; overflow-x: auto;" Elevation="0">
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">1.</span> User creates server via Gateway</div>
        <div class="mb-1 ml-4"><span style="color: rgba(74, 222, 128, 1);">‚Üí</span> Gateway ‚Üí Servers (HTTPS): POST /api/servers</div>
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">2.</span> Servers service creates DB record</div>
        <div class="mb-1 ml-4"><span style="color: rgba(74, 222, 128, 1);">‚Üí</span> Servers ‚Üí Platform DB (PostgreSQL): INSERT</div>
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">3.</span> Servers publishes event</div>
        <div class="mb-1 ml-4"><span style="color: rgba(192, 132, 252, 1);">‚Üí</span> Servers ‚Üí RabbitMQ: servers.state-sync (ServerCreated)</div>
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">4.</span> Multiple consumers react:</div>
        <div class="mb-1 ml-4"><span style="color: rgba(250, 204, 21, 1);">‚Üí</span> Console: Subscribe to live updates</div>
        <div class="mb-1 ml-4"><span style="color: rgba(250, 204, 21, 1);">‚Üí</span> Notifications: Send "Server Ready" email</div>
        <div class="mb-1 ml-4"><span style="color: rgba(250, 204, 21, 1);">‚Üí</span> Billing: Record billable resource creation</div>
    </MudPaper>

    <MudText Typo="Typo.body1" Color="Color.Info" Class="mb-2">Example 2: Backup Job Flow</MudText>
    <MudPaper Class="rounded-xl p-4 mb-4 font-mono" Style="background: rgba(17, 24, 39, 1); color: rgba(255,255,255,0.7); font-size: 0.75rem; overflow-x: auto;" Elevation="0">
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">1.</span> User requests backup via Gateway</div>
        <div class="mb-1 ml-4"><span style="color: rgba(74, 222, 128, 1);">‚Üí</span> Gateway ‚Üí Tasks (HTTPS): POST /api/tasks/backup</div>
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">2.</span> Gateway publishes command</div>
        <div class="mb-1 ml-4"><span style="color: rgba(192, 132, 252, 1);">‚Üí</span> Gateway ‚Üí RabbitMQ: tasks.backup-requested (BackupCommand)</div>
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">3.</span> Tasks consumer picks up work</div>
        <div class="mb-1 ml-4"><span style="color: rgba(250, 204, 21, 1);">‚Üí</span> Tasks: Dequeue message, execute backup logic</div>
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">4.</span> Tasks uploads backup file</div>
        <div class="mb-1 ml-4"><span style="color: rgba(74, 222, 128, 1);">‚Üí</span> Tasks ‚Üí Files (HTTPS): POST /api/files/upload</div>
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">5.</span> Tasks publishes completion event</div>
        <div class="mb-1 ml-4"><span style="color: rgba(192, 132, 252, 1);">‚Üí</span> Tasks ‚Üí RabbitMQ: tasks.job-completed (JobFinished)</div>
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">6.</span> Notifications sends confirmation email</div>
        <div class="mb-1 ml-4"><span style="color: rgba(250, 204, 21, 1);">‚Üí</span> Notifications: Dequeue, send email via SMTP</div>
    </MudPaper>

    <MudText Typo="Typo.body1" Color="Color.Info" Class="mb-2">Example 3: Payment Processing Flow</MudText>
    <MudPaper Class="rounded-xl p-4 mb-6 font-mono" Style="background: rgba(17, 24, 39, 1); color: rgba(255,255,255,0.7); font-size: 0.75rem; overflow-x: auto;" Elevation="0">
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">1.</span> Stripe webhook hits Gateway</div>
        <div class="mb-1 ml-4"><span style="color: rgba(74, 222, 128, 1);">‚Üí</span> Gateway ‚Üí Billing (HTTPS): POST /api/billing/webhook</div>
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">2.</span> Billing validates and records payment</div>
        <div class="mb-1 ml-4"><span style="color: rgba(74, 222, 128, 1);">‚Üí</span> Billing ‚Üí Platform DB (PostgreSQL): UPDATE invoices</div>
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">3.</span> Billing publishes event</div>
        <div class="mb-1 ml-4"><span style="color: rgba(192, 132, 252, 1);">‚Üí</span> Billing ‚Üí RabbitMQ: billing.payment-received (PaymentProcessed)</div>
        <div class="mb-1"><span style="color: rgba(96, 165, 250, 1);">4.</span> Multiple consumers react:</div>
        <div class="mb-1 ml-4"><span style="color: rgba(250, 204, 21, 1);">‚Üí</span> Servers: Resume suspended servers</div>
        <div class="mb-1 ml-4"><span style="color: rgba(250, 204, 21, 1);">‚Üí</span> Notifications: Send payment receipt email</div>
        <div class="mb-1 ml-4"><span style="color: rgba(250, 204, 21, 1);">‚Üí</span> Billing: Update credit balance</div>
    </MudPaper>

    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3">12.6 Configuration</MudText>
    <MudGrid Class="mb-6">
        <MudItem xs="12" md="6">
            <MudPaper Class="rounded-xl p-4" Style="background: rgba(55, 65, 81, 1); border: 1px solid rgba(75, 85, 99, 1);">
                <MudText Typo="Typo.body1" Class="mb-2" Style="color: white; font-weight: 600;">Connection Pooling</MudText>
                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">
                    ‚Ä¢ Max channels per connection: 50<br/>
                    ‚Ä¢ Connection timeout: 30s<br/>
                    ‚Ä¢ Heartbeat interval: 60s<br/>
                    ‚Ä¢ Auto-recovery enabled
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudPaper Class="rounded-xl p-4" Style="background: rgba(55, 65, 81, 1); border: 1px solid rgba(75, 85, 99, 1);">
                <MudText Typo="Typo.body1" Class="mb-2" Style="color: white; font-weight: 600;">Quality of Service</MudText>
                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">
                    ‚Ä¢ Prefetch count: 10<br/>
                    ‚Ä¢ Manual acknowledgments<br/>
                    ‚Ä¢ Persistent messages (delivery mode 2)<br/>
                    ‚Ä¢ Publisher confirms enabled
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Class="rounded-xl p-4" Style="background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.4);">
        <MudText Typo="Typo.body1" Style="color: rgba(16, 185, 129, 1);"><strong>‚úÖ Key Principles</strong></MudText>
        <MudText Typo="Typo.body2" Class="mt-2" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">
            ‚Ä¢ <strong>Idempotency:</strong> All message handlers are idempotent to handle duplicate delivery<br/>
            ‚Ä¢ <strong>Schema Versioning:</strong> Message types include version field for backward compatibility<br/>
            ‚Ä¢ <strong>Observability:</strong> All publishes/consumes logged with correlation IDs<br/>
            ‚Ä¢ <strong>Security:</strong> AMQP traffic encrypted via Cilium mTLS, vhost isolation per environment
        </MudText>
    </MudPaper>
</MudPaper>
