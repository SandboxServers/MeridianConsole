<section id="rabbitmq" class="bg-gray-800 rounded-xl p-6 border border-gray-700">
    <h2 class="text-2xl font-bold text-purple-400 mb-6 border-b border-purple-600 pb-2">
        12. RabbitMQ Topology
    </h2>
    
    <div class="bg-blue-900/30 border border-blue-700 rounded-lg p-4 mb-6">
        <p class="text-blue-400 font-semibold mb-2">üìã Message Bus Architecture</p>
        <p class="text-gray-300 text-sm">RabbitMQ serves as the central event backbone for asynchronous, event-driven communication between services. All queues, exchanges, and bindings are declared programmatically via .NET client libraries during service startup.</p>
    </div>

    <h3 class="text-xl font-semibold text-indigo-400 mb-3">12.1 Exchange Strategy</h3>
    <div class="overflow-x-auto mb-6">
        <table class="w-full text-sm border-collapse">
            <thead>
                <tr class="bg-gray-700 text-white">
                    <th class="border border-gray-600 p-2 text-left">Exchange Name</th>
                    <th class="border border-gray-600 p-2 text-left">Type</th>
                    <th class="border border-gray-600 p-2 text-left">Purpose</th>
                    <th class="border border-gray-600 p-2 text-left">Routing Pattern</th>
                </tr>
            </thead>
            <tbody class="text-gray-300">
                <tr class="bg-gray-800">
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">meridian.events</td>
                    <td class="border border-gray-600 p-2 font-mono">topic</td>
                    <td class="border border-gray-600 p-2">Platform-wide domain events</td>
                    <td class="border border-gray-600 p-2 font-mono text-sm">{domain}.{entity}.{action}</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">meridian.commands</td>
                    <td class="border border-gray-600 p-2 font-mono">direct</td>
                    <td class="border border-gray-600 p-2">Command messages requiring single consumer</td>
                    <td class="border border-gray-600 p-2 font-mono text-sm">{service}.{command}</td>
                </tr>
                <tr class="bg-gray-800">
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">meridian.notifications</td>
                    <td class="border border-gray-600 p-2 font-mono">fanout</td>
                    <td class="border border-gray-600 p-2">Broadcast notifications to all subscribers</td>
                    <td class="border border-gray-600 p-2 font-mono text-sm">(no routing key)</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">meridian.dlx</td>
                    <td class="border border-gray-600 p-2 font-mono">topic</td>
                    <td class="border border-gray-600 p-2">Dead-letter exchange for failed messages</td>
                    <td class="border border-gray-600 p-2 font-mono text-sm">{original.routing.key}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <h3 class="text-xl font-semibold text-indigo-400 mb-3">12.2 Queue Naming Convention</h3>
    <div class="bg-gray-700 rounded-lg p-4 mb-6">
        <p class="text-gray-300 mb-3">All queues follow the pattern:</p>
        <div class="bg-gray-900 rounded p-3 font-mono text-sm text-green-400 mb-3">
            {service-name}.{queue-purpose}[.{optional-discriminator}]
        </div>
        <p class="text-gray-400 text-sm mb-2"><strong class="text-white">Examples:</strong></p>
        <ul class="text-gray-300 text-sm space-y-1 list-disc list-inside">
            <li><span class="font-mono text-purple-400">servers.state-sync</span> ‚Äî Server state change events</li>
            <li><span class="font-mono text-purple-400">billing.invoice-created</span> ‚Äî New invoice notifications</li>
            <li><span class="font-mono text-purple-400">tasks.backup-requested</span> ‚Äî Backup job commands</li>
            <li><span class="font-mono text-purple-400">notifications.email-outbound</span> ‚Äî Email delivery queue</li>
        </ul>
    </div>

    <h3 class="text-xl font-semibold text-indigo-400 mb-3">12.3 Publishers & Consumers</h3>
    <div class="overflow-x-auto mb-6">
        <table class="w-full text-sm border-collapse">
            <thead>
                <tr class="bg-gray-700 text-white">
                    <th class="border border-gray-600 p-2 text-left">Queue Name</th>
                    <th class="border border-gray-600 p-2 text-left">Publisher(s)</th>
                    <th class="border border-gray-600 p-2 text-left">Consumer(s)</th>
                    <th class="border border-gray-600 p-2 text-left">Message Type</th>
                </tr>
            </thead>
            <tbody class="text-gray-300">
                <tr class="bg-gray-800">
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">servers.state-sync</td>
                    <td class="border border-gray-600 p-2">Servers, Nodes</td>
                    <td class="border border-gray-600 p-2">Console, Notifications</td>
                    <td class="border border-gray-600 p-2 text-sm">ServerStateChanged</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">billing.invoice-created</td>
                    <td class="border border-gray-600 p-2">Billing</td>
                    <td class="border border-gray-600 p-2">Notifications</td>
                    <td class="border border-gray-600 p-2 text-sm">InvoiceGenerated</td>
                </tr>
                <tr class="bg-gray-800">
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">billing.payment-received</td>
                    <td class="border border-gray-600 p-2">Billing</td>
                    <td class="border border-gray-600 p-2">Servers, Notifications</td>
                    <td class="border border-gray-600 p-2 text-sm">PaymentProcessed</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">identity.user-registered</td>
                    <td class="border border-gray-600 p-2">Identity</td>
                    <td class="border border-gray-600 p-2">Billing, Notifications</td>
                    <td class="border border-gray-600 p-2 text-sm">UserCreated</td>
                </tr>
                <tr class="bg-gray-800">
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">tasks.backup-requested</td>
                    <td class="border border-gray-600 p-2">Gateway, Servers</td>
                    <td class="border border-gray-600 p-2">Tasks</td>
                    <td class="border border-gray-600 p-2 text-sm">BackupCommand</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">tasks.restore-requested</td>
                    <td class="border border-gray-600 p-2">Gateway, Servers</td>
                    <td class="border border-gray-600 p-2">Tasks</td>
                    <td class="border border-gray-600 p-2 text-sm">RestoreCommand</td>
                </tr>
                <tr class="bg-gray-800">
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">tasks.update-requested</td>
                    <td class="border border-gray-600 p-2">Gateway, Servers</td>
                    <td class="border border-gray-600 p-2">Tasks</td>
                    <td class="border border-gray-600 p-2 text-sm">UpdateCommand</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">tasks.job-completed</td>
                    <td class="border border-gray-600 p-2">Tasks</td>
                    <td class="border border-gray-600 p-2">Servers, Notifications</td>
                    <td class="border border-gray-600 p-2 text-sm">JobFinished</td>
                </tr>
                <tr class="bg-gray-800">
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">files.upload-complete</td>
                    <td class="border border-gray-600 p-2">Files</td>
                    <td class="border border-gray-600 p-2">Mods, Servers</td>
                    <td class="border border-gray-600 p-2 text-sm">FileUploaded</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">mods.catalog-updated</td>
                    <td class="border border-gray-600 p-2">Mods</td>
                    <td class="border border-gray-600 p-2">Servers, Notifications</td>
                    <td class="border border-gray-600 p-2 text-sm">ModCatalogRefreshed</td>
                </tr>
                <tr class="bg-gray-800">
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">console.stream-events</td>
                    <td class="border border-gray-600 p-2">Nodes</td>
                    <td class="border border-gray-600 p-2">Console</td>
                    <td class="border border-gray-600 p-2 text-sm">ConsoleOutput</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">notifications.email-outbound</td>
                    <td class="border border-gray-600 p-2">Identity, Billing, Tasks</td>
                    <td class="border border-gray-600 p-2">Notifications</td>
                    <td class="border border-gray-600 p-2 text-sm">EmailRequest</td>
                </tr>
                <tr class="bg-gray-800">
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">notifications.webhook-outbound</td>
                    <td class="border border-gray-600 p-2">Servers, Billing, Tasks</td>
                    <td class="border border-gray-600 p-2">Notifications</td>
                    <td class="border border-gray-600 p-2 text-sm">WebhookDelivery</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 p-2 font-mono text-purple-400">firewall.rule-sync</td>
                    <td class="border border-gray-600 p-2">Firewall</td>
                    <td class="border border-gray-600 p-2">Nodes</td>
                    <td class="border border-gray-600 p-2 text-sm">FirewallRuleUpdated</td>
                </tr>
            </tbody>
        </table>
    </div>

    <h3 class="text-xl font-semibold text-indigo-400 mb-3">12.4 Dead Letter Queue (DLQ) Strategy</h3>
    <div class="bg-orange-900/30 border border-orange-700 rounded-lg p-4 mb-6">
        <p class="text-orange-400 font-semibold mb-2">‚ö†Ô∏è Failure Handling</p>
        <p class="text-gray-300 text-sm mb-3">All application queues are configured with:</p>
        <ul class="text-gray-300 text-sm space-y-1 list-disc list-inside">
            <li><strong>x-message-ttl:</strong> 86400000 (24 hours)</li>
            <li><strong>x-dead-letter-exchange:</strong> meridian.dlx</li>
            <li><strong>x-dead-letter-routing-key:</strong> dlq.{original-queue-name}</li>
            <li><strong>Retry policy:</strong> 3 attempts with exponential backoff (1s, 5s, 15s)</li>
        </ul>
    </div>

    <div class="bg-gray-700 rounded-lg p-4 mb-6">
        <p class="text-gray-300 text-sm mb-2"><strong class="text-white">DLQ Monitoring:</strong></p>
        <p class="text-gray-400 text-sm">Messages entering the DLX trigger alerts in Notifications service. Platform admins receive digest emails for DLQ depth > 10 messages.</p>
    </div>

    <h3 class="text-xl font-semibold text-indigo-400 mb-3">12.5 Message Flow Examples</h3>
    
    <h4 class="text-lg font-semibold text-indigo-300 mb-2">Example 1: Server Creation Flow</h4>
    <div class="bg-gray-900 rounded-lg p-4 mb-4 font-mono text-xs text-gray-300 overflow-x-auto">
        <div class="mb-1"><span class="text-blue-400">1.</span> User creates server via Gateway</div>
        <div class="mb-1 ml-4"><span class="text-green-400">‚Üí</span> Gateway ‚Üí Servers (HTTPS): POST /api/servers</div>
        <div class="mb-1"><span class="text-blue-400">2.</span> Servers service creates DB record</div>
        <div class="mb-1 ml-4"><span class="text-green-400">‚Üí</span> Servers ‚Üí Platform DB (PostgreSQL): INSERT</div>
        <div class="mb-1"><span class="text-blue-400">3.</span> Servers publishes event</div>
        <div class="mb-1 ml-4"><span class="text-purple-400">‚Üí</span> Servers ‚Üí RabbitMQ: servers.state-sync (ServerCreated)</div>
        <div class="mb-1"><span class="text-blue-400">4.</span> Multiple consumers react:</div>
        <div class="mb-1 ml-4"><span class="text-yellow-400">‚Üí</span> Console: Subscribe to live updates</div>
        <div class="mb-1 ml-4"><span class="text-yellow-400">‚Üí</span> Notifications: Send "Server Ready" email</div>
        <div class="mb-1 ml-4"><span class="text-yellow-400">‚Üí</span> Billing: Record billable resource creation</div>
    </div>

    <h4 class="text-lg font-semibold text-indigo-300 mb-2">Example 2: Backup Job Flow</h4>
    <div class="bg-gray-900 rounded-lg p-4 mb-4 font-mono text-xs text-gray-300 overflow-x-auto">
        <div class="mb-1"><span class="text-blue-400">1.</span> User requests backup via Gateway</div>
        <div class="mb-1 ml-4"><span class="text-green-400">‚Üí</span> Gateway ‚Üí Tasks (HTTPS): POST /api/tasks/backup</div>
        <div class="mb-1"><span class="text-blue-400">2.</span> Gateway publishes command</div>
        <div class="mb-1 ml-4"><span class="text-purple-400">‚Üí</span> Gateway ‚Üí RabbitMQ: tasks.backup-requested (BackupCommand)</div>
        <div class="mb-1"><span class="text-blue-400">3.</span> Tasks consumer picks up work</div>
        <div class="mb-1 ml-4"><span class="text-yellow-400">‚Üí</span> Tasks: Dequeue message, execute backup logic</div>
        <div class="mb-1"><span class="text-blue-400">4.</span> Tasks uploads backup file</div>
        <div class="mb-1 ml-4"><span class="text-green-400">‚Üí</span> Tasks ‚Üí Files (HTTPS): POST /api/files/upload</div>
        <div class="mb-1"><span class="text-blue-400">5.</span> Tasks publishes completion event</div>
        <div class="mb-1 ml-4"><span class="text-purple-400">‚Üí</span> Tasks ‚Üí RabbitMQ: tasks.job-completed (JobFinished)</div>
        <div class="mb-1"><span class="text-blue-400">6.</span> Notifications sends confirmation email</div>
        <div class="mb-1 ml-4"><span class="text-yellow-400">‚Üí</span> Notifications: Dequeue, send email via SMTP</div>
    </div>

    <h4 class="text-lg font-semibold text-indigo-300 mb-2">Example 3: Payment Processing Flow</h4>
    <div class="bg-gray-900 rounded-lg p-4 mb-6 font-mono text-xs text-gray-300 overflow-x-auto">
        <div class="mb-1"><span class="text-blue-400">1.</span> Stripe webhook hits Gateway</div>
        <div class="mb-1 ml-4"><span class="text-green-400">‚Üí</span> Gateway ‚Üí Billing (HTTPS): POST /api/billing/webhook</div>
        <div class="mb-1"><span class="text-blue-400">2.</span> Billing validates and records payment</div>
        <div class="mb-1 ml-4"><span class="text-green-400">‚Üí</span> Billing ‚Üí Platform DB (PostgreSQL): UPDATE invoices</div>
        <div class="mb-1"><span class="text-blue-400">3.</span> Billing publishes event</div>
        <div class="mb-1 ml-4"><span class="text-purple-400">‚Üí</span> Billing ‚Üí RabbitMQ: billing.payment-received (PaymentProcessed)</div>
        <div class="mb-1"><span class="text-blue-400">4.</span> Multiple consumers react:</div>
        <div class="mb-1 ml-4"><span class="text-yellow-400">‚Üí</span> Servers: Resume suspended servers</div>
        <div class="mb-1 ml-4"><span class="text-yellow-400">‚Üí</span> Notifications: Send payment receipt email</div>
        <div class="mb-1 ml-4"><span class="text-yellow-400">‚Üí</span> Billing: Update credit balance</div>
    </div>

    <h3 class="text-xl font-semibold text-indigo-400 mb-3">12.6 Configuration</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="bg-gray-700 rounded-lg p-4">
            <p class="text-white font-semibold mb-2">Connection Pooling</p>
            <ul class="text-gray-300 text-sm space-y-1">
                <li>‚Ä¢ Max channels per connection: 50</li>
                <li>‚Ä¢ Connection timeout: 30s</li>
                <li>‚Ä¢ Heartbeat interval: 60s</li>
                <li>‚Ä¢ Auto-recovery enabled</li>
            </ul>
        </div>
        <div class="bg-gray-700 rounded-lg p-4">
            <p class="text-white font-semibold mb-2">Quality of Service</p>
            <ul class="text-gray-300 text-sm space-y-1">
                <li>‚Ä¢ Prefetch count: 10</li>
                <li>‚Ä¢ Manual acknowledgments</li>
                <li>‚Ä¢ Persistent messages (delivery mode 2)</li>
                <li>‚Ä¢ Publisher confirms enabled</li>
            </ul>
        </div>
    </div>

    <div class="bg-green-900/30 border border-green-700 rounded-lg p-4">
        <p class="text-green-400 font-semibold mb-2">‚úÖ Key Principles</p>
        <ul class="text-gray-300 text-sm space-y-1 list-disc list-inside">
            <li><strong>Idempotency:</strong> All message handlers are idempotent to handle duplicate delivery</li>
            <li><strong>Schema Versioning:</strong> Message types include version field for backward compatibility</li>
            <li><strong>Observability:</strong> All publishes/consumes logged with correlation IDs</li>
            <li><strong>Security:</strong> AMQP traffic encrypted via Cilium mTLS, vhost isolation per environment</li>
        </ul>
    </div>
</section>