@inject Dhadgar.Scope.Services.CommMatrixService MatrixService

<section id="matrix" class="rounded-2xl border border-white/10 bg-white/5 p-6 md:p-8">
    <div class="flex flex-col gap-2 md:flex-row md:items-start md:justify-between">
        <div>
            <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight text-white">12. Service Communication Matrix</h2>
            <p class="mt-1 text-sm md:text-base text-white/70 max-w-3xl">
                A protocol-level view of the <span class="text-white/90 font-semibold">allowed</span> paths between major services.
                This isn‚Äôt the ‚Äúdependency map‚Äù ‚Äî it‚Äôs the comms reality: who‚Äôs permitted to talk to whom, and how.
            </p>
        </div>

        <div class="mt-3 md:mt-0 flex flex-wrap gap-2">
            <a class="rounded-full border border-white/10 bg-black/30 px-3 py-1.5 text-xs font-semibold text-white/80 hover:bg-white/10"
               href="/dependencies">
                ‚Üó Dependency Map
            </a>
            <a class="rounded-full border border-indigo-400/30 bg-indigo-500/10 px-3 py-1.5 text-xs font-semibold text-indigo-200 hover:bg-indigo-500/20"
               href="/#architecture">
                üèôÔ∏è Open Architecture
            </a>
            <a class="rounded-full border border-purple-400/30 bg-purple-500/10 px-3 py-1.5 text-xs font-semibold text-purple-200 hover:bg-purple-500/20"
               href="/#database-schemas">
                üóÑÔ∏è Open Database Schemas
            </a>
        </div>
    </div>

    <div class="mt-6 rounded-xl border border-blue-400/20 bg-blue-500/10 p-4">
        <div class="flex items-start gap-3">
            <div class="text-xl">üìã</div>
            <div>
                <div class="text-sm font-semibold text-blue-200">How to read this</div>
                <div class="mt-1 text-sm text-white/70">
                    The matrix uses a small set of protocol symbols. ‚Äú-‚Äù means <span class="font-semibold text-white/80">no direct comms</span> (deny-by-default).
                    Security details (authN/Z, mTLS, cert flows) live in <a class="underline decoration-white/20 hover:decoration-white/50" href="/s/security">Section 7</a>
                    and <a class="underline decoration-white/20 hover:decoration-white/50" href="/s/certificates">Section 8</a>.
                </div>
            </div>
        </div>
    </div>

    <!-- 12.1 -->
    <h3 class="mt-8 text-xl md:text-2xl font-bold text-indigo-200">12.1 Legend</h3>

    <div class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
        @LegendCard("HTTP", "HTTPS / HTTP", "REST/JSON and service-to-service calls (typically via gateway patterns).", "bg-indigo-500/10 border-indigo-400/20 text-indigo-200")
        @LegendCard("WSS", "WebSocket Secure", "Live console sessions, streaming logs, and real-time UX updates.", "bg-emerald-500/10 border-emerald-400/20 text-emerald-200")
        @LegendCard("AMQP", "RabbitMQ (AMQP)", "Async workflows, fan-out events, retries, and durable delivery.", "bg-amber-500/10 border-amber-400/20 text-amber-200")
        @LegendCard("DB", "Database", "PostgreSQL (and friends) within the appropriate plane/cluster.", "bg-purple-500/10 border-purple-400/20 text-purple-200")
    </div>

    <!-- 12.2 -->
    <h3 class="mt-10 text-xl md:text-2xl font-bold text-indigo-200">12.2 Matrix</h3>

    <div class="mt-3 text-sm text-white/70 max-w-4xl">
        This is intentionally ‚Äúcoarse-grained‚Äù (service-to-service). Internals like background workers and adapters
        still show up here because they represent real runtime boundaries.
    </div>

    <!-- Mobile (Option 2) -->
    <div class="mt-6">
        <CommMatrixMobile />
    </div>

    <!-- Desktop -->
    <div class="hidden md:block mt-6 rounded-2xl border border-white/10 bg-black/20 p-5">
        @if (_data is null)
        {
            <div class="text-sm text-white/70">Loading‚Ä¶</div>
        }
        else
        {
            <div class="flex items-center justify-between gap-4 flex-wrap">
                <div>
                    <div class="text-lg font-bold text-white">Desktop matrix</div>
                    <div class="text-sm text-white/70">Sticky headers + quick filters. Scroll to explore.</div>
                </div>

                <div class="flex items-center gap-2 flex-wrap">
                    <input class="w-64 max-w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white/90 placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-indigo-500/40"
                           placeholder="Search services‚Ä¶"
                           value="@_q"
                           @oninput="(e) => { _q = e.Value?.ToString() ?? string.Empty; }" />

                    <button class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white/80 hover:bg-white/10"
                            @onclick="ResetFilters">
                        Reset
                    </button>
                </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
                @foreach (var k in _kinds)
                {
                    var enabled = _enabled.Contains(k);
                    <button class="@($"rounded-full px-3 py-1.5 text-xs font-semibold border {(enabled ? "border-indigo-400/30 bg-indigo-500/20 text-indigo-100" : "border-white/10 bg-white/5 text-white/70 hover:bg-white/10")}")"
                            @onclick="() => Toggle(k)">
                        @k
                    </button>
                }
            </div>

            <div class="mt-4 overflow-auto rounded-xl border border-white/10 bg-black/25 max-h-[65vh]">
                <table class="min-w-[980px] w-full text-xs border-separate border-spacing-0">
                    <thead>
                        <tr class="bg-gray-900/60">
                            <th class="sticky top-0 left-0 z-30 text-left px-3 py-2 border-b border-white/10 bg-gray-900/80 text-white/90">
                                FROM \ TO
                            </th>

                            @foreach (var h in _data.Headers)
                            {
                                <th class="sticky top-0 z-20 text-center px-3 py-2 border-b border-white/10 bg-gray-900/60 text-white/80 whitespace-nowrap">
                                    @h
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in RowsFiltered())
                        {
                            <tr class="hover:bg-white/5">
                                <td class="sticky left-0 z-10 px-3 py-2 border-b border-white/10 bg-gray-950/60 text-white font-semibold whitespace-nowrap">
                                    @row.From
                                </td>

                                @foreach (var cell in CellsFiltered(row))
                                {
                                    <td class="px-2 py-2 border-b border-white/10 text-center">
                                        @CellBadge(cell.Value)
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="mt-4 rounded-xl border border-white/10 bg-white/5 p-4">
                <div class="text-sm font-semibold text-white">Key observations</div>
                <ul class="mt-2 space-y-1 text-sm text-white/70 list-disc pl-5">
                    <li>Most client traffic terminates at the <span class="font-semibold text-white/80">Gateway</span>.</li>
                    <li>Async work (tasks, fan-out events) should prefer <span class="font-semibold text-white/80">AMQP</span> to avoid tight coupling.</li>
                    <li>Database access is <span class="font-semibold text-white/80">plane-aware</span>: SaaS platform DBs live on platform nodes; user DBs can be BYO (SaaS + KiP) depending on deployment mode.</li>
                </ul>
            </div>
        }
    </div>
</section>

@code {
    private CommMatrixData? _data;
    private string _q = string.Empty;
    private readonly List<string> _kinds = new() { "HTTP", "WSS", "AMQP", "DB" };
    private readonly HashSet<string> _enabled = new() { "HTTP", "WSS", "AMQP", "DB" };

    protected override async Task OnInitializedAsync()
    {
        _data = await MatrixService.GetAsync();
    }

    private void Toggle(string kind)
    {
        if (_enabled.Contains(kind)) _enabled.Remove(kind);
        else _enabled.Add(kind);
    }

    private void ResetFilters()
    {
        _q = string.Empty;
        _enabled.Clear();
        foreach (var k in _kinds) _enabled.Add(k);
    }

    private IEnumerable<CommMatrixRow> RowsFiltered()
    {
        if (_data is null) yield break;

        var q = (_q ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(q))
        {
            foreach (var r in _data.Rows) yield return r;
            yield break;
        }

        q = q.ToLowerInvariant();
        foreach (var r in _data.Rows)
        {
            if (r.From.ToLowerInvariant().Contains(q))
            {
                yield return r;
                continue;
            }

            if (r.Cells.Any(c => c.To.ToLowerInvariant().Contains(q)))
                yield return r;
        }
    }

    private IEnumerable<CommMatrixCell> CellsFiltered(CommMatrixRow row)
    {
        if (_data is null) return Enumerable.Empty<CommMatrixCell>();

        var q = (_q ?? string.Empty).Trim().ToLowerInvariant();
        var headerSet = new HashSet<string>(_data.Headers, StringComparer.OrdinalIgnoreCase);

        // Ensure cells align to headers order
        var map = row.Cells.ToDictionary(c => c.To, c => c, StringComparer.OrdinalIgnoreCase);
        return _data.Headers.Select(h =>
        {
            if (!map.TryGetValue(h, out var cell)) return new CommMatrixCell { To = h, Value = "-" };
            return cell;
        });
    }

    private RenderFragment LegendCard(string symbol, string title, string desc, string colorClasses) => @<div class="@($"rounded-2xl border p-4 {colorClasses}")">
        <div class="flex items-start justify-between gap-3">
            <div>
                <div class="text-sm font-semibold text-white/90">@title</div>
                <div class="mt-1 text-sm text-white/70">@desc</div>
            </div>
            <div class="shrink-0 rounded-full bg-black/30 px-3 py-1 text-xs font-bold tracking-wider text-white/90">@symbol</div>
        </div>
    </div>;

    private RenderFragment CellBadge(string value) => value switch
    {
        "-" => @<span class="text-white/20">‚Äî</span>,
        var v when !_enabled.Contains(v) => @<span class="rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-[11px] text-white/35">@v</span>,
        "HTTP" => @<span class="rounded-full border border-indigo-400/30 bg-indigo-500/20 px-2 py-0.5 text-[11px] font-semibold text-indigo-100">HTTP</span>,
        "WSS" => @<span class="rounded-full border border-emerald-400/30 bg-emerald-500/20 px-2 py-0.5 text-[11px] font-semibold text-emerald-100">WSS</span>,
        "AMQP" => @<span class="rounded-full border border-amber-400/30 bg-amber-500/20 px-2 py-0.5 text-[11px] font-semibold text-amber-100">AMQP</span>,
        "DB" => @<span class="rounded-full border border-purple-400/30 bg-purple-500/20 px-2 py-0.5 text-[11px] font-semibold text-purple-100">DB</span>,
        var v => @<span class="rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-[11px] text-white/70">@v</span>
    };
}
