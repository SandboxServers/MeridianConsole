@inject Dhadgar.Scope.Services.CommMatrixService MatrixService

<MudPaper Class="rounded-2xl border border-white/10 bg-white/5 p-6 md:p-8" Elevation="0">
    <div class="d-flex flex-column flex-md-row align-start justify-space-between gap-2">
        <div>
            <MudText Typo="Typo.h4" Color="Color.Secondary" Class="font-bold">12. Service Communication Matrix</MudText>
            <MudText Typo="Typo.body2" Class="mt-1" Style="color: rgba(255,255,255,0.7); max-width: 48rem;">
                A protocol-level view of the <span style="color: rgba(255,255,255,0.9); font-weight: 600;">allowed</span> paths between major services.
                This isn't the "dependency map" ‚Äî it's the comms reality: who's permitted to talk to whom, and how.
            </MudText>
        </div>

        <div class="mt-3 mt-md-0 d-flex flex-wrap gap-2">
            <MudLink Href="/dependencies" Class="rounded-full border px-3 py-1.5 text-xs font-semibold" Style="border-color: rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: rgba(255,255,255,0.8); text-decoration: none;">
                ‚Üó Dependency Map
            </MudLink>
            <MudLink Href="/#architecture" Class="rounded-full border px-3 py-1.5 text-xs font-semibold" Style="border-color: rgba(99, 102, 241, 0.3); background: rgba(99, 102, 241, 0.1); color: rgba(199, 210, 254, 1); text-decoration: none;">
                üèôÔ∏è Open Architecture
            </MudLink>
            <MudLink Href="/#database-schemas" Class="rounded-full border px-3 py-1.5 text-xs font-semibold" Style="border-color: rgba(168, 85, 247, 0.3); background: rgba(168, 85, 247, 0.1); color: rgba(233, 213, 255, 1); text-decoration: none;">
                üóÑÔ∏è Open Database Schemas
            </MudLink>
        </div>
    </div>

    <MudAlert Severity="Severity.Info" Class="rounded-xl mt-6" Dense="true" Icon="@Icons.Material.Filled.Info">
        <MudText Typo="Typo.body2" Class="font-weight-bold" Style="color: rgba(147, 197, 253, 1);">How to read this</MudText>
        <MudText Typo="Typo.body2" Class="mt-1" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">
            The matrix uses a small set of protocol symbols. "-" means <span class="font-weight-bold" style="color: rgba(255,255,255,0.8);">no direct comms</span> (deny-by-default).
            Security details (authN/Z, mTLS, cert flows) live in <a class="text-decoration-underline" style="text-decoration-color: rgba(255,255,255,0.2);" href="/s/security">Section 7</a>
            and <a class="text-decoration-underline" style="text-decoration-color: rgba(255,255,255,0.2);" href="/s/certificates">Section 8</a>.
        </MudText>
    </MudAlert>

    <MudText Typo="Typo.h5" Color="Color.Info" Class="mt-8 font-bold">12.1 Legend</MudText>

    <MudGrid Class="mt-4">
        <MudItem xs="12" sm="6" lg="3">
            @LegendCard("HTTP", "HTTPS / HTTP", "REST/JSON and service-to-service calls (typically via gateway patterns).", "border-color: rgba(99, 102, 241, 0.2); background: rgba(99, 102, 241, 0.1); color: rgba(199, 210, 254, 1);")
        </MudItem>
        <MudItem xs="12" sm="6" lg="3">
            @LegendCard("WSS", "WebSocket Secure", "Live console sessions, streaming logs, and real-time UX updates.", "border-color: rgba(16, 185, 129, 0.2); background: rgba(16, 185, 129, 0.1); color: rgba(167, 243, 208, 1);")
        </MudItem>
        <MudItem xs="12" sm="6" lg="3">
            @LegendCard("AMQP", "RabbitMQ (AMQP)", "Async workflows, fan-out events, retries, and durable delivery.", "border-color: rgba(245, 158, 11, 0.2); background: rgba(245, 158, 11, 0.1); color: rgba(252, 211, 77, 1);")
        </MudItem>
        <MudItem xs="12" sm="6" lg="3">
            @LegendCard("DB", "Database", "PostgreSQL (and friends) within the appropriate plane/cluster.", "border-color: rgba(168, 85, 247, 0.2); background: rgba(168, 85, 247, 0.1); color: rgba(233, 213, 255, 1);")
        </MudItem>
    </MudGrid>

    <MudText Typo="Typo.h5" Color="Color.Info" Class="mt-10 font-bold">12.2 Matrix</MudText>

    <MudText Typo="Typo.body2" Class="mt-3" Style="color: rgba(255,255,255,0.7); max-width: 56rem; font-size: 0.875rem;">
        This is intentionally "coarse-grained" (service-to-service). Internals like background workers and adapters
        still show up here because they represent real runtime boundaries.
    </MudText>

    <!-- Mobile (Option 2) - CRITICAL: Preserve this component -->
    <div class="mt-6">
        <CommMatrixMobile />
    </div>

    <!-- Desktop -->
    <MudPaper Class="d-none d-md-block mt-6 rounded-2xl border border-white/10 bg-black/20 p-5" Elevation="0">
        @if (_data is null)
        {
            <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">Loading‚Ä¶</MudText>
        }
        else
        {
            <div class="d-flex align-center justify-space-between gap-4 flex-wrap">
                <div>
                    <MudText Typo="Typo.h6" Style="color: white;">Desktop matrix</MudText>
                    <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">Sticky headers + quick filters. Scroll to explore.</MudText>
                </div>

                <div class="d-flex align-center gap-2 flex-wrap">
                    <MudTextField T="string" Value="@_q" ValueChanged="@((string val) => _q = val)"
                                  Placeholder="Search services‚Ä¶" Variant="Variant.Outlined"
                                  Class="rounded-xl" Style="max-width: 16rem; background: rgba(255,255,255,0.05);"
                                  Margin="Margin.Dense" />

                    <MudButton Variant="Variant.Outlined" Class="rounded-xl" OnClick="ResetFilters"
                               Style="border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.8);">
                        Reset
                    </MudButton>
                </div>
            </div>

            <div class="mt-4 d-flex flex-wrap gap-2">
                @foreach (var k in _kinds)
                {
                    var enabled = _enabled.Contains(k);
                    <button class="rounded-full px-3 py-1.5 text-xs font-semibold border" @onclick="() => Toggle(k)"
                            style="@(enabled ? "border-color: rgba(99, 102, 241, 0.3); background: rgba(99, 102, 241, 0.2); color: rgba(224, 231, 255, 1);" : "border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7);")">
                        @k
                    </button>
                }
            </div>

            <div class="mt-4 overflow-auto rounded-xl border border-white/10 bg-black/25" style="max-height: 65vh;">
                <table class="w-full text-xs border-separate border-spacing-0" style="min-width: 980px;">
                    <thead>
                        <tr style="background: rgba(17, 24, 39, 0.6);">
                            <th class="sticky top-0 left-0 text-left px-3 py-2 border-b border-white/10"
                                style="z-index: 30; background: rgba(17, 24, 39, 0.8); color: rgba(255,255,255,0.9);">
                                FROM \ TO
                            </th>

                            @foreach (var h in _data.Headers)
                            {
                                <th class="sticky top-0 text-center px-3 py-2 border-b border-white/10 whitespace-nowrap"
                                    style="z-index: 20; background: rgba(17, 24, 39, 0.6); color: rgba(255,255,255,0.8);">
                                    @h
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in RowsFiltered())
                        {
                            <tr class="hover:bg-white/5">
                                <td class="sticky left-0 px-3 py-2 border-b border-white/10 font-semibold whitespace-nowrap"
                                    style="z-index: 10; background: rgba(3, 7, 18, 0.6); color: white;">
                                    @row.From
                                </td>

                                @foreach (var cell in CellsFiltered(row))
                                {
                                    <td class="px-2 py-2 border-b border-white/10 text-center">
                                        @CellBadge(cell.Value)
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <MudPaper Class="mt-4 rounded-xl border border-white/10 bg-white/5 p-4" Elevation="0">
                <MudText Typo="Typo.body2" Class="font-weight-bold" Style="color: white; font-size: 0.875rem;">Key observations</MudText>
                <MudText Typo="Typo.body2" Class="mt-2" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">
                    ‚Ä¢ Most client traffic terminates at the <span class="font-weight-bold" style="color: rgba(255,255,255,0.8);">Gateway</span>.<br/>
                    ‚Ä¢ Async work (tasks, fan-out events) should prefer <span class="font-weight-bold" style="color: rgba(255,255,255,0.8);">AMQP</span> to avoid tight coupling.<br/>
                    ‚Ä¢ Database access is <span class="font-weight-bold" style="color: rgba(255,255,255,0.8);">plane-aware</span>: SaaS platform DBs live on platform nodes; user DBs can be BYO (SaaS + KiP) depending on deployment mode.
                </MudText>
            </MudPaper>
        }
    </MudPaper>
</MudPaper>

@code {
    private CommMatrixData? _data;
    private string _q = string.Empty;
    private readonly List<string> _kinds = new() { "HTTP", "WSS", "AMQP", "DB" };
    private readonly HashSet<string> _enabled = new() { "HTTP", "WSS", "AMQP", "DB" };

    protected override async Task OnInitializedAsync()
    {
        _data = await MatrixService.GetAsync();
    }

    private void Toggle(string kind)
    {
        if (_enabled.Contains(kind)) _enabled.Remove(kind);
        else _enabled.Add(kind);
    }

    private void ResetFilters()
    {
        _q = string.Empty;
        _enabled.Clear();
        foreach (var k in _kinds) _enabled.Add(k);
    }

    private IEnumerable<CommMatrixRow> RowsFiltered()
    {
        if (_data is null) yield break;

        var q = (_q ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(q))
        {
            foreach (var r in _data.Rows) yield return r;
            yield break;
        }

        q = q.ToLowerInvariant();
        foreach (var r in _data.Rows)
        {
            if (r.From.ToLowerInvariant().Contains(q))
            {
                yield return r;
                continue;
            }

            if (r.Cells.Any(c => c.To.ToLowerInvariant().Contains(q)))
                yield return r;
        }
    }

    private IEnumerable<CommMatrixCell> CellsFiltered(CommMatrixRow row)
    {
        if (_data is null) return Enumerable.Empty<CommMatrixCell>();

        var q = (_q ?? string.Empty).Trim().ToLowerInvariant();
        var headerSet = new HashSet<string>(_data.Headers, StringComparer.OrdinalIgnoreCase);

        // Ensure cells align to headers order
        var map = row.Cells.ToDictionary(c => c.To, c => c, StringComparer.OrdinalIgnoreCase);
        return _data.Headers.Select(h =>
        {
            if (!map.TryGetValue(h, out var cell)) return new CommMatrixCell { To = h, Value = "-" };
            return cell;
        });
    }

    private RenderFragment LegendCard(string symbol, string title, string desc, string colorClasses) => @<MudPaper Class="rounded-2xl border p-4" Style="@colorClasses" Elevation="0">
        <div class="d-flex align-start justify-space-between gap-3">
            <div>
                <MudText Typo="Typo.body2" Class="font-weight-bold" Style="color: rgba(255,255,255,0.9); font-size: 0.875rem;">@title</MudText>
                <MudText Typo="Typo.body2" Class="mt-1" Style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">@desc</MudText>
            </div>
            <div class="shrink-0 rounded-full px-3 py-1 text-xs font-bold tracking-wider" style="background: rgba(0,0,0,0.3); color: rgba(255,255,255,0.9);">@symbol</div>
        </div>
    </MudPaper>;

    private RenderFragment CellBadge(string value) => value switch
    {
        "-" => @<span style="color: rgba(255,255,255,0.2);">‚Äî</span>,
        var v when !_enabled.Contains(v) => @<span class="rounded-full border px-2 py-0.5" style="border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.35); font-size: 11px;">@v</span>,
        "HTTP" => @<span class="rounded-full border px-2 py-0.5 font-semibold" style="border-color: rgba(99, 102, 241, 0.3); background: rgba(99, 102, 241, 0.2); color: rgba(224, 231, 255, 1); font-size: 11px;">HTTP</span>,
        "WSS" => @<span class="rounded-full border px-2 py-0.5 font-semibold" style="border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.2); color: rgba(167, 243, 208, 1); font-size: 11px;">WSS</span>,
        "AMQP" => @<span class="rounded-full border px-2 py-0.5 font-semibold" style="border-color: rgba(245, 158, 11, 0.3); background: rgba(245, 158, 11, 0.2); color: rgba(252, 211, 77, 1); font-size: 11px;">AMQP</span>,
        "DB" => @<span class="rounded-full border px-2 py-0.5 font-semibold" style="border-color: rgba(168, 85, 247, 0.3); background: rgba(168, 85, 247, 0.2); color: rgba(233, 213, 255, 1); font-size: 11px;">DB</span>,
        var v => @<span class="rounded-full border px-2 py-0.5" style="border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7); font-size: 11px;">@v</span>
    };
}
