<section id="agents" class="bg-gray-800 rounded-xl p-6 border border-gray-700">
    <h2 class="text-2xl font-bold text-white">15. Agent Architecture</h2>
    
    <!-- Prominent Callout: Customer-Hosted -->
    <div class="bg-blue-900/30 border-2 border-blue-500 rounded-lg p-6 mb-8">
        <h3 class="text-2xl font-bold text-blue-300 mb-3">ğŸ  Customer-Hosted Agents</h3>
        <p class="text-gray-300 text-lg mb-4">
            These agents run on <strong class="text-white">your hardware</strong>, not ours. You install them on your own servers, and they coordinate with our control plane to provision and manage your game servers.
        </p>
        <div class="grid md:grid-cols-3 gap-4 text-sm">
            <div class="bg-gray-900 rounded-lg p-3">
                <div class="text-blue-400 font-semibold mb-1">ğŸ“¥ Bootstrap</div>
                <div class="text-gray-400">Install agent â†’ Register with control plane â†’ Receive certificate</div>
            </div>
            <div class="bg-gray-900 rounded-lg p-3">
                <div class="text-green-400 font-semibold mb-1">ğŸ® Provision</div>
                <div class="text-gray-400">Control plane sends deployment commands â†’ Agent provisions game servers locally</div>
            </div>
            <div class="bg-gray-900 rounded-lg p-3">
                <div class="text-purple-400 font-semibold mb-1">ğŸ“Š Telemetry</div>
                <div class="text-gray-400">Agent ships metrics, logs, console output â†’ Displayed in Web UI</div>
            </div>
        </div>
    </div>

    <!-- Agent Platform Descriptions -->
    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <div class="bg-gray-900 rounded-lg p-5 border border-green-800">
            <h3 class="text-xl font-semibold text-green-400 mb-3">ğŸ§ Agent.Linux</h3>
            <p class="text-gray-400 mb-4">Runs as a systemd service on your Linux server. Manages game servers via Docker containers.</p>
            <ul class="text-sm text-gray-400 space-y-1 mb-4">
                <li>â€¢ <strong class="text-white">Deployment:</strong> Systemd service</li>
                <li>â€¢ <strong class="text-white">Isolation:</strong> One Docker container per game server</li>
                <li>â€¢ <strong class="text-white">Resources:</strong> cgroup limits (CPU, RAM, disk I/O)</li>
                <li>â€¢ <strong class="text-white">Storage:</strong> Volume mounts for persistent game data</li>
                <li>â€¢ <strong class="text-white">Encryption:</strong> LUKS full disk encryption (optional)</li>
            </ul>
        </div>
        
        <div class="bg-gray-900 rounded-lg p-5 border border-blue-800">
            <h3 class="text-xl font-semibold text-blue-400 mb-3">ğŸªŸ Agent.Windows</h3>
            <p class="text-gray-400 mb-4">Runs as a Windows Service on your Windows server. Manages game servers as child processes.</p>
            <ul class="text-sm text-gray-400 space-y-1 mb-4">
                <li>â€¢ <strong class="text-white">Deployment:</strong> Windows Service</li>
                <li>â€¢ <strong class="text-white">Isolation:</strong> Job Objects for resource limits</li>
                <li>â€¢ <strong class="text-white">Resources:</strong> CPU affinity, memory limits, priority</li>
                <li>â€¢ <strong class="text-white">Required for:</strong> ARK, Conan Exiles, some Unity games</li>
                <li>â€¢ <strong class="text-white">Encryption:</strong> BitLocker full disk encryption (optional)</li>
            </ul>
        </div>
    </div>

    <!-- Trust & Transparency -->
    <h3 class="text-2xl font-bold text-white mb-4 border-b border-gray-600 pb-2">ğŸ”’ Trust & Transparency</h3>
    <div class="bg-yellow-900/30 border-2 border-yellow-600 rounded-lg p-6 mb-6">
        <h4 class="text-yellow-300 font-bold text-lg mb-3">âš ï¸ Important: Your Hardware, Your Rules</h4>
        <p class="text-gray-300 mb-4">
            We <strong class="text-white">cannot and will not</strong> enforce encryption or security policies on your hardware. 
            That's <strong class="text-white">your responsibility</strong>. What we <em>can</em> do is prove that our agents have limited, 
            well-defined operations and cannot execute arbitrary code against your machines.
        </p>
    </div>

    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <!-- Trust Mechanism 1: Command Audit Logging -->
        <div class="bg-gray-900 rounded-lg p-5 border border-green-700">
            <div class="flex items-center gap-3 mb-3">
                <span class="text-3xl">ğŸ“</span>
                <h4 class="text-lg font-bold text-green-400">Command Audit Logging</h4>
            </div>
            <p class="text-sm text-gray-400 mb-3">
                Every command the control plane sends to the agent is logged <strong class="text-white">locally on your machine</strong>.
            </p>
            <div class="bg-gray-800 rounded p-3 mb-3">
                <p class="text-xs text-gray-500 mb-2">Log locations:</p>
                <div class="space-y-2">
                    <div>
                        <p class="text-xs text-gray-400 mb-1">ğŸ§ <strong class="text-white">Linux:</strong></p>
                        <code class="text-green-400 text-xs">/var/log/meridian-agent/commands.log</code>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 mb-1">ğŸªŸ <strong class="text-white">Windows Event Log:</strong></p>
                        <code class="text-blue-400 text-xs block mb-1">Applications and Services Logs â†’ Meridian Console â†’ Agent Commands</code>
                        <p class="text-xs text-gray-500 italic">Custom event source: <code class="text-blue-300">MeridianAgent</code></p>
                    </div>
                </div>
            </div>
            <p class="text-xs text-gray-400">
                <strong class="text-white">You can audit these logs</strong> anytime to see exactly what our control plane requested your agent to do.
            </p>
        </div>

        <!-- Trust Mechanism 2: No Arbitrary Code Execution -->
        <div class="bg-gray-900 rounded-lg p-5 border border-red-700">
            <div class="flex items-center gap-3 mb-3">
                <span class="text-3xl">ğŸš«</span>
                <h4 class="text-lg font-bold text-red-400">No Arbitrary Code Execution</h4>
            </div>
            <p class="text-sm text-gray-400 mb-3">
                The agent <strong class="text-white">only executes predefined operations</strong> from a whitelist. We cannot send arbitrary shell commands.
            </p>
            <div class="bg-gray-800 rounded p-3 mb-3">
                <p class="text-xs text-gray-500 mb-1">Allowed operations:</p>
                <ul class="text-xs text-gray-400 space-y-1">
                    <li>â€¢ <code class="text-blue-300">install_game_server</code></li>
                    <li>â€¢ <code class="text-blue-300">start_server</code> / <code class="text-blue-300">stop_server</code></li>
                    <li>â€¢ <code class="text-blue-300">collect_metrics</code></li>
                    <li>â€¢ <code class="text-blue-300">stream_console_output</code></li>
                    <li>â€¢ <code class="text-blue-300">upload_file</code> / <code class="text-blue-300">download_file</code></li>
                </ul>
            </div>
            <p class="text-xs text-gray-400">
                Anything outside this whitelist is <strong class="text-white">rejected</strong> by the agent.
            </p>
        </div>

        <!-- Trust Mechanism 3: Declarative Operations Manifest -->
        <div class="bg-gray-900 rounded-lg p-5 border border-purple-700">
            <div class="flex items-center gap-3 mb-3">
                <span class="text-3xl">ğŸ“‹</span>
                <h4 class="text-lg font-bold text-purple-400">Declarative Operations Manifest</h4>
            </div>
            <p class="text-sm text-gray-400 mb-3">
                The agent ships with a <strong class="text-white">manifest file</strong> listing every operation it can perform and what privileges each requires.
            </p>
            <div class="bg-gray-800 rounded p-3 mb-3">
                <p class="text-xs text-gray-500 mb-1">Example manifest entry:</p>
                <pre class="text-xs text-purple-300">install_game_server:
  privileges: [file_write, process_spawn]
  scope: /opt/gameservers/*
  description: "Downloads and installs game server binaries"</pre>
            </div>
            <p class="text-xs text-gray-400">
                <strong class="text-white">You can review this manifest</strong> before installing the agent to understand exactly what it's capable of.
            </p>
        </div>

        <!-- Trust Mechanism 4: Permission Scoping -->
        <div class="bg-gray-900 rounded-lg p-5 border border-blue-700">
            <div class="flex items-center gap-3 mb-3">
                <span class="text-3xl">ğŸ”</span>
                <h4 class="text-lg font-bold text-blue-400">Principle of Least Privilege</h4>
            </div>
            <p class="text-sm text-gray-400 mb-3">
                The agent runs with <strong class="text-white">minimum required permissions</strong> and can only access specific directories.
            </p>
            <div class="bg-gray-800 rounded p-3 mb-3">
                <p class="text-xs text-gray-500 mb-1">Linux example:</p>
                <ul class="text-xs text-gray-400 space-y-1">
                    <li>â€¢ <strong class="text-white">User:</strong> <code class="text-cyan-300">meridian-agent</code> (dedicated user)</li>
                    <li>â€¢ <strong class="text-white">Write access:</strong> <code class="text-cyan-300">/opt/gameservers/</code> only</li>
                    <li>â€¢ <strong class="text-white">No root:</strong> Agent does not run as root</li>
                </ul>
                <p class="text-xs text-gray-500 mt-2 mb-1">Windows example:</p>
                <ul class="text-xs text-gray-400 space-y-1">
                    <li>â€¢ <strong class="text-white">Service Account:</strong> Restricted permissions</li>
                    <li>â€¢ <strong class="text-white">ACLs:</strong> Explicit folder/process permissions</li>
                </ul>
            </div>
            <p class="text-xs text-gray-400">
                <strong class="text-white">You control the user</strong> the agent runs as and can further restrict permissions via your OS.
            </p>
        </div>

        <!-- Trust Mechanism 5: Signed Binaries (NEW - MOVED FROM FUTURE) -->
        <div class="bg-gray-900 rounded-lg p-5 border border-orange-700">
            <div class="flex items-center gap-3 mb-3">
                <span class="text-3xl">ğŸ”</span>
                <h4 class="text-lg font-bold text-orange-400">Signed Binaries</h4>
            </div>
            <p class="text-sm text-gray-400 mb-3">
                All agent releases are <strong class="text-white">cryptographically signed</strong> via Azure Trusted Signing so you can verify authenticity.
            </p>
            <div class="bg-gray-800 rounded p-3 mb-3">
                <p class="text-xs text-gray-500 mb-1">Benefits:</p>
                <ul class="text-xs text-gray-400 space-y-1">
                    <li>â€¢ âœ… No "Unknown Publisher" warnings on Windows</li>
                    <li>â€¢ âœ… Verify it's really from Meridian Console</li>
                    <li>â€¢ âœ… Detect tampering before installation</li>
                    <li>â€¢ âœ… Integrated with Azure DevOps pipeline</li>
                </ul>
            </div>
            <div class="bg-green-900/30 border border-green-700 rounded p-2">
                <p class="text-xs text-green-300">
                    <strong>Implementation:</strong> Azure Trusted Signing (Basic tier, $10/month, 5,000 ops/month)
                </p>
            </div>
        </div>
    </div>

    <!-- Future Enhancements -->
    <h3 class="text-2xl font-bold text-white mb-4 border-b border-gray-600 pb-2">ğŸ”® Future Trust Enhancements</h3>
    <div class="grid md:grid-cols-2 gap-4 mb-8">
        <div class="bg-gray-900 rounded-lg p-4 border border-gray-600">
            <div class="text-green-400 font-semibold mb-2">ğŸ“‚ Open Source Agents</div>
            <p class="text-xs text-gray-400 mb-2">Publish agent source code on GitHub for full auditability ("Don't trust, verify").</p>
            <p class="text-xs text-gray-500 italic">Planned post-SaaS launch</p>
        </div>
        <div class="bg-gray-900 rounded-lg p-4 border border-gray-600">
            <div class="text-purple-400 font-semibold mb-2">ğŸ›¡ï¸ Third-Party Audit</div>
            <p class="text-xs text-gray-400 mb-2">Pay security firm to audit and certify agent code (or rely on nerds to audit for free ğŸ˜„).</p>
            <p class="text-xs text-gray-500 italic">When budget allows ($10k-50k)</p>
        </div>
    </div>

    <!-- Agent Security & Certificates -->
    <h3 class="text-2xl font-bold text-white mb-4 border-b border-gray-600 pb-2">ğŸ” Agent Security & Certificates</h3>
    <div class="bg-gray-900 rounded-lg p-5 border border-gray-600 mb-6">
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <h4 class="text-purple-400 font-medium mb-3">ğŸ“ Registration Flow</h4>
                <ol class="text-sm text-gray-400 space-y-2">
                    <li><strong class="text-white">1.</strong> Admin generates one-time registration code (15-minute expiry) via Web UI</li>
                    <li><strong class="text-white">2.</strong> Customer runs agent installer with code on their hardware</li>
                    <li><strong class="text-white">3.</strong> Agent registers with Nodes Service using code</li>
                    <li><strong class="text-white">4.</strong> Nodes Service creates DNS entry: <code class="text-cyan-300">agent-{id}.nodes.meridianconsole.com</code></li>
                    <li><strong class="text-white">5.</strong> Nodes Service requests certificate from Let's Encrypt (DNS-01 via Cloudflare)</li>
                    <li><strong class="text-white">6.</strong> Certificate pushed to agent over secure bootstrap channel</li>
                    <li><strong class="text-white">7.</strong> Agent installs certificate and establishes <strong class="text-cyan-400">mTLS connection</strong></li>
                </ol>
            </div>
            <div>
                <h4 class="text-purple-400 font-medium mb-3">ğŸ”„ Certificate Lifecycle</h4>
                <table class="w-full text-sm">
                    <tbody class="text-gray-400">
                        <tr><td class="py-1"><strong class="text-white">CA:</strong></td><td>Let's Encrypt</td></tr>
                        <tr><td class="py-1"><strong class="text-white">DNS:</strong></td><td class="font-mono text-xs">agent-{id}.nodes.meridianconsole.com</td></tr>
                        <tr><td class="py-1"><strong class="text-white">Validity:</strong></td><td>90 days</td></tr>
                        <tr><td class="py-1"><strong class="text-white">Renewal:</strong></td><td>45 days before expiry (automatic)</td></tr>
                        <tr><td class="py-1"><strong class="text-white">Handler:</strong></td><td>Nodes Service (not agent)</td></tr>
                        <tr><td class="py-1"><strong class="text-white">Distribution:</strong></td><td>Push over existing mTLS connection</td></tr>
                    </tbody>
                </table>
                <div class="mt-4 bg-green-900/30 border border-green-700 rounded p-3">
                    <p class="text-xs text-green-300 font-semibold mb-1">âœ… Zero Touch Renewal</p>
                    <p class="text-xs text-gray-400">Agents never directly request certs. Nodes Service handles all ACME interactions and pushes renewed certs automatically.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Communication -->
    <h3 class="text-2xl font-bold text-white mb-4 border-b border-gray-600 pb-2">ğŸ“¡ Agent Communication</h3>
    <div class="bg-gray-900 rounded-lg p-4 border border-gray-600 mb-6">
        <h4 class="text-cyan-400 font-medium mb-3">Agent Boot Sequence</h4>
        <pre class="diagram text-green-400 text-xs">1. Agent loads mTLS certificate from local storage
   â””â”€ Linux: /etc/meridianconsole/certs/
   â””â”€ Windows: C:\ProgramData\MeridianConsole\certs\

2. Establish WSS connection to Nodes Service
   â””â”€ wss://nodes.meridianconsole.com/ws
   â””â”€ mTLS mutual authentication

3. Send HELLO message with metadata
   â””â”€ OS version, CPU cores, RAM, disk space
   â””â”€ Agent version, capabilities

4. Receive ACK + assigned server list
   â””â”€ Control plane tells agent what servers should be running

5. Reconcile local state
   â””â”€ Start servers that should be running
   â””â”€ Stop servers that shouldn't be running
   â””â”€ Report any discrepancies

6. Enter command loop
   â””â”€ Heartbeat every 30 seconds
   â””â”€ Listen for control plane commands
   â””â”€ Stream console output, metrics, logs</pre>
    </div>

    <div class="bg-gray-900 rounded-lg p-4 border border-gray-600">
        <h4 class="text-cyan-400 font-medium mb-3">Certificate Renewal (Automatic)</h4>
        <pre class="diagram text-yellow-400 text-xs">1. Nodes Service detects certificate expiring in &lt; 45 days
   â””â”€ Scheduled job runs daily checking all agent certs

2. Nodes Service requests new certificate from Let's Encrypt
   â””â”€ DNS-01 challenge via Cloudflare API
   â””â”€ Creates TXT record: _acme-challenge.agent-{id}.nodes.meridianconsole.com

3. Let's Encrypt validates and issues new certificate

4. Nodes Service pushes new certificate to agent
   â””â”€ Sent over existing mTLS connection
   â””â”€ Agent receives cert + private key

5. Agent installs new certificate
   â””â”€ Writes to local storage (replaces old cert)
   â””â”€ Reloads TLS context (no restart required)

6. Agent confirms installation
   â””â”€ Sends confirmation message to Nodes Service
   â””â”€ Nodes Service marks renewal as complete</pre>
    </div>

    <!-- Key Points Summary -->
    <div class="mt-8 bg-blue-900/30 border-2 border-blue-600 rounded-lg p-6">
        <h3 class="text-xl font-bold text-blue-300 mb-4">ğŸ¯ Key Takeaways</h3>
        <div class="grid md:grid-cols-2 gap-4 text-sm">
            <div>
                <h4 class="text-white font-semibold mb-2">âœ… What We Do</h4>
                <ul class="text-gray-300 space-y-1">
                    <li>â€¢ Prove limited scope of operations</li>
                    <li>â€¢ Provide audit logs on your machine</li>
                    <li>â€¢ Run with least privilege</li>
                    <li>â€¢ Whitelist allowed operations</li>
                    <li>â€¢ Publish operations manifest</li>
                    <li>â€¢ Sign all binaries cryptographically</li>
                </ul>
            </div>
            <div>
                <h4 class="text-white font-semibold mb-2">âŒ What We Don't Do</h4>
                <ul class="text-gray-300 space-y-1">
                    <li>â€¢ Enforce encryption (your choice)</li>
                    <li>â€¢ Execute arbitrary code</li>
                    <li>â€¢ Access files outside designated paths</li>
                    <li>â€¢ Run with elevated privileges by default</li>
                    <li>â€¢ Hide what the agent is doing</li>
                </ul>
            </div>
        </div>
    </div>
</section>