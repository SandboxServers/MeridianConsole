@inject Dhadgar.Scope.Services.ArchitectureGraphService GraphService

<div class="grid gap-4 lg:grid-cols-3">
    <div class="lg:col-span-2 space-y-3">
        <div>
            <label class="block text-xs font-semibold tracking-wide text-white/60">Search</label>
            <input class="mt-1 w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   placeholder="Try: Gateway, RabbitMQ, BYO DB…"
                   @bind="Query"
                   @bind:event="oninput" />
        </div>

        <div class="rounded-2xl border border-white/10 bg-black/20 p-4 h-[60vh] md:h-[64vh] lg:h-[66vh] overflow-auto">
            @if (_data is null)
            {
                <div class="text-sm text-white/70">Loading…</div>
            }
            else
            {
                @foreach (var group in TreeGroups)
                {
                    <details class="mb-3 rounded-xl border border-white/10 bg-white/5 p-3">
                        <summary class="cursor-pointer text-sm font-semibold text-white/80">
                            @group.Name
                            <span class="ml-2 text-xs text-white/50">(@group.Nodes.Count)</span>
                        </summary>
                        <div class="mt-3 space-y-2">
                            @foreach (var node in group.Nodes)
                            {
                                <button class="w-full text-left rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white/85 hover:bg-white/10"
                                        @onclick="() => SelectNode(node)">
                                    <div class="flex items-center gap-2">
                                        <span>@node.Emoji</span>
                                        <span class="font-semibold">@node.Name</span>
                                    </div>
                                    <div class="mt-1 text-xs text-white/60 line-clamp-2">@node.Description</div>
                                </button>
                            }
                        </div>
                    </details>
                }
            }
        </div>
    </div>

    <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
        <div class="flex items-center justify-between gap-2">
            <div class="text-sm font-semibold text-white/80">Selected node</div>
            @if (_selected is not null)
            {
                <button class="rounded-xl bg-white/10 px-3 py-2 text-xs hover:bg-white/15"
                        @onclick="ClearSelection">Clear</button>
            }
        </div>

        @if (_selected is null)
        {
            <div class="mt-3 text-sm text-white/70">Select a node to inspect responsibilities and endpoints.</div>
        }
        else
        {
            <div class="mt-4">
                <div class="text-xl font-bold text-white flex items-center gap-2">
                    <span>@_selected.Emoji</span>
                    <span>@_selected.Name</span>
                </div>
                <div class="mt-2 text-sm text-white/70">@_selected.Description</div>

                @if (_selected.Responsibilities.Count > 0)
                {
                    <div class="mt-4">
                        <div class="text-xs font-semibold text-white/60">Responsibilities</div>
                        <ul class="mt-2 list-disc pl-5 text-sm text-white/75 space-y-1">
                            @foreach (var r in _selected.Responsibilities)
                            {
                                <li>@r</li>
                            }
                        </ul>
                    </div>
                }

                @if (_selected.Ports.Count > 0)
                {
                    <div class="mt-4">
                        <div class="text-xs font-semibold text-white/60">Ports</div>
                        <div class="mt-2 flex flex-wrap gap-2 text-xs">
                            @foreach (var p in _selected.Ports)
                            {
                                <span class="rounded-full border border-white/10 bg-white/5 px-2 py-1 text-white/80">@p</span>
                            }
                        </div>
                    </div>
                }

                @if (_selected.Endpoints.Count > 0)
                {
                    <div class="mt-4">
                        <div class="text-xs font-semibold text-white/60">Endpoints</div>
                        <ul class="mt-2 space-y-1 text-sm text-white/75">
                            @foreach (var e in _selected.Endpoints)
                            {
                                <li><code class="rounded bg-black/30 px-1">@e</code></li>
                            }
                        </ul>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private Dhadgar.Scope.Services.ArchitectureGraphData? _data;
    private Dhadgar.Scope.Services.ArchitectureNode? _selected;

    private string Query { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _data = await GraphService.GetAsync();
    }

    private void SelectNode(Dhadgar.Scope.Services.ArchitectureNode node)
    {
        _selected = node;
    }

    private void ClearSelection()
    {
        _selected = null;
    }

    private string NormalizeSearch(string? value)
        => (value ?? string.Empty).Trim().ToLowerInvariant();

    private bool NodeMatches(Dhadgar.Scope.Services.ArchitectureNode node)
    {
        var query = NormalizeSearch(Query);
        if (string.IsNullOrWhiteSpace(query)) return true;

        if ((node.Name ?? string.Empty).ToLowerInvariant().Contains(query)) return true;
        if ((node.Description ?? string.Empty).ToLowerInvariant().Contains(query)) return true;
        if (node.Responsibilities.Any(r => NormalizeSearch(r).Contains(query))) return true;
        if (node.Endpoints.Any(e => NormalizeSearch(e).Contains(query))) return true;
        if (node.Ports.Any(p => NormalizeSearch(p.ToString()).Contains(query))) return true;
        if ((node.Kind ?? string.Empty).ToLowerInvariant().Contains(query)) return true;

        return false;
    }

    private IEnumerable<(string Name, List<Dhadgar.Scope.Services.ArchitectureNode> Nodes)> TreeGroups
    {
        get
        {
            if (_data is null) return Array.Empty<(string, List<Dhadgar.Scope.Services.ArchitectureNode>)>();

            var districtNames = _data.Districts.ToDictionary(d => d.Id, d => d.Name);
            var filtered = _data.Nodes
                .Where(NodeMatches)
                .GroupBy(n => n.District ?? string.Empty)
                .Select(g =>
                {
                    var name = districtNames.TryGetValue(g.Key, out var label) ? label : (string.IsNullOrWhiteSpace(g.Key) ? "Other" : g.Key);
                    return (Name: name, Nodes: g.OrderBy(n => n.Name).ToList());
                })
                .OrderBy(g => g.Name)
                .ToList();

            return filtered;
        }
    }
}
