@inject Dhadgar.Scope.Services.ArchitectureGraphService GraphService

<div class="grid gap-4 lg:grid-cols-3">
    <div class="lg:col-span-2 space-y-3">
        <MudTextField @bind-Value="Query"
                      Label="Search"
                      Placeholder="Try: Gateway, RabbitMQ, BYO DB..."
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      Immediate="true"
                      Clearable="true"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      AdornmentColor="Color.Primary"
                      Class="rounded-xl"
                      Style="border-radius: 0.75rem; background: rgba(0,0,0,0.3);" />

        <MudPaper Class="rounded-2xl border border-white/10 bg-black/20 p-4 h-[60vh] md:h-[64vh] lg:h-[66vh] overflow-auto" Elevation="0">
            @if (_data is null)
            {
                <div class="space-y-2">
                    @for (int i = 0; i < 5; i++)
                    {
                        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="48px" Class="rounded-xl" Animation="Animation.Wave" />
                    }
                </div>
            }
            else
            {
                @foreach (var group in TreeGroups)
                {
                    <MudExpansionPanels Class="mb-3">
                        <MudExpansionPanel Style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem;">
                            <TitleContent>
                                <div class="flex items-center gap-2">
                                    <MudText Typo="Typo.body2" Class="font-semibold" Style="color: rgba(255,255,255,0.8);">@group.Name</MudText>
                                    <MudChip T="string" Size="Size.Small" Style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5);">@group.Nodes.Count</MudChip>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                <div class="space-y-2">
                                    @foreach (var node in group.Nodes)
                                    {
                                        <MudButton OnClick="() => SelectNode(node)"
                                                   FullWidth="true"
                                                   Class="rounded-xl text-left justify-start"
                                                   Style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); text-transform: none; padding: 0.5rem 0.75rem;">
                                            <div class="w-full">
                                                <div class="flex items-center gap-2">
                                                    <span>@node.Emoji</span>
                                                    <MudText Typo="Typo.body2" Class="font-semibold">@node.Name</MudText>
                                                </div>
                                                <MudText Typo="Typo.caption" Class="mt-1 line-clamp-2" Style="color: rgba(255,255,255,0.6);">@node.Description</MudText>
                                            </div>
                                        </MudButton>
                                    }
                                </div>
                            </ChildContent>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                }
            }
        </MudPaper>
    </div>

    <MudPaper Class="rounded-2xl border border-white/10 bg-white/5 p-5" Elevation="0">
        <div class="flex items-center justify-between gap-2">
            <MudText Typo="Typo.body2" Class="font-semibold" Style="color: rgba(255,255,255,0.8);">Selected node</MudText>
            @if (_selected is not null)
            {
                <MudButton OnClick="ClearSelection"
                           Variant="Variant.Filled"
                           Size="Size.Small"
                           Class="rounded-xl"
                           Style="background: rgba(255,255,255,0.1); text-transform: none;">
                    Clear
                </MudButton>
            }
        </div>

        @if (_selected is null)
        {
            <MudText Typo="Typo.body2" Class="mt-3" Style="color: rgba(255,255,255,0.7);">Select a node to inspect responsibilities and endpoints.</MudText>
        }
        else
        {
            <div class="mt-4">
                <div class="flex items-center gap-2">
                    <span class="text-xl">@_selected.Emoji</span>
                    <MudText Typo="Typo.h5" Class="font-bold">@_selected.Name</MudText>
                </div>
                <MudText Typo="Typo.body2" Class="mt-2" Style="color: rgba(255,255,255,0.7);">@_selected.Description</MudText>

                @if (_selected.Responsibilities.Count > 0)
                {
                    <div class="mt-4">
                        <MudText Typo="Typo.caption" Class="font-semibold" Style="color: rgba(255,255,255,0.6);">Responsibilities</MudText>
                        <MudList T="string" Dense="true" Class="mt-2" Style="padding: 0;">
                            @foreach (var r in _selected.Responsibilities)
                            {
                                <MudListItem T="string" Dense="true" Style="padding-left: 0; min-height: auto;">
                                    <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.75);">- @r</MudText>
                                </MudListItem>
                            }
                        </MudList>
                    </div>
                }

                @if (_selected.Ports.Count > 0)
                {
                    <div class="mt-4">
                        <MudText Typo="Typo.caption" Class="font-semibold" Style="color: rgba(255,255,255,0.6);">Ports</MudText>
                        <div class="mt-2 flex flex-wrap gap-2">
                            @foreach (var p in _selected.Ports)
                            {
                                <MudChip T="string" Size="Size.Small" Style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.8);">@p</MudChip>
                            }
                        </div>
                    </div>
                }

                @if (_selected.Endpoints.Count > 0)
                {
                    <div class="mt-4">
                        <MudText Typo="Typo.caption" Class="font-semibold" Style="color: rgba(255,255,255,0.6);">Endpoints</MudText>
                        <div class="mt-2 space-y-1">
                            @foreach (var e in _selected.Endpoints)
                            {
                                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.75);">
                                    <code class="rounded bg-black/30 px-1">@e</code>
                                </MudText>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </MudPaper>
</div>

@code {
    private Dhadgar.Scope.Services.ArchitectureGraphData? _data;
    private Dhadgar.Scope.Services.ArchitectureNode? _selected;

    private string Query { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _data = await GraphService.GetAsync();
    }

    private void SelectNode(Dhadgar.Scope.Services.ArchitectureNode node)
    {
        _selected = node;
    }

    private void ClearSelection()
    {
        _selected = null;
    }

    private string NormalizeSearch(string? value)
        => (value ?? string.Empty).Trim().ToLowerInvariant();

    private bool NodeMatches(Dhadgar.Scope.Services.ArchitectureNode node)
    {
        var query = NormalizeSearch(Query);
        if (string.IsNullOrWhiteSpace(query)) return true;

        if ((node.Name ?? string.Empty).ToLowerInvariant().Contains(query)) return true;
        if ((node.Description ?? string.Empty).ToLowerInvariant().Contains(query)) return true;
        if (node.Responsibilities.Any(r => NormalizeSearch(r).Contains(query))) return true;
        if (node.Endpoints.Any(e => NormalizeSearch(e).Contains(query))) return true;
        if (node.Ports.Any(p => NormalizeSearch(p.ToString()).Contains(query))) return true;
        if ((node.Kind ?? string.Empty).ToLowerInvariant().Contains(query)) return true;

        return false;
    }

    private IEnumerable<(string Name, List<Dhadgar.Scope.Services.ArchitectureNode> Nodes)> TreeGroups
    {
        get
        {
            if (_data is null) return Array.Empty<(string, List<Dhadgar.Scope.Services.ArchitectureNode>)>();

            var districtNames = _data.Districts.ToDictionary(d => d.Id, d => d.Name);
            var filtered = _data.Nodes
                .Where(NodeMatches)
                .GroupBy(n => n.District ?? string.Empty)
                .Select(g =>
                {
                    var name = districtNames.TryGetValue(g.Key, out var label) ? label : (string.IsNullOrWhiteSpace(g.Key) ? "Other" : g.Key);
                    return (Name: name, Nodes: g.OrderBy(n => n.Name).ToList());
                })
                .OrderBy(g => g.Name)
                .ToList();

            return filtered;
        }
    }
}
