@using System.Linq
@inject Dhadgar.Scope.Services.CommMatrixService MatrixService

<MudPaper Class="md:hidden rounded-2xl border border-white/10 bg-white/5 p-4 mb-6" Elevation="0">
    <div class="flex items-center justify-between gap-2">
        <div>
            <MudText Typo="Typo.h6" Class="font-bold">Mobile matrix</MudText>
            <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.7);">Pick a source service to see outbound links.</MudText>
        </div>
        <MudChip T="string" Size="Size.Small" Style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.6);">Option 2</MudChip>
    </div>

    @if (_data is null)
    {
        <div class="mt-4 space-y-2">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="40px" Class="rounded-xl" Animation="Animation.Wave" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="32px" Class="rounded-xl" Animation="Animation.Wave" />
        </div>
    }
    else
    {
        <div class="mt-4">
            <MudSelect T="string"
                       @bind-Value="_selectedFrom"
                       Label="From"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Class="rounded-xl"
                       Style="border-radius: 0.75rem; background: rgba(0,0,0,0.3);">
                @foreach (var r in _data.Rows)
                {
                    <MudSelectItem Value="@r.From">@r.From</MudSelectItem>
                }
            </MudSelect>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
            @foreach (var k in _kinds)
            {
                var enabled = _enabled.Contains(k);
                <MudButton OnClick="() => Toggle(k)"
                           Variant="@(enabled ? Variant.Filled : Variant.Outlined)"
                           Color="@(enabled ? Color.Primary : Color.Default)"
                           Size="Size.Small"
                           Class="rounded-full"
                           Style="@GetFilterButtonStyle(enabled)">
                    @k
                </MudButton>
            }
        </div>

        <div class="mt-4 space-y-3">
            @foreach (var cell in Outbound().Where(c => c.Value != "-" && _enabled.Contains(c.Value)).OrderBy(c => c.To))
            {
                <MudPaper Class="rounded-2xl border border-white/10 bg-black/20 p-4" Elevation="0">
                    <div class="flex items-center justify-between gap-3">
                        <MudText Typo="Typo.body1" Class="font-bold">@cell.To</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Style="background: rgba(99,102,241,0.2); color: #c7d2fe;">@cell.Value</MudChip>
                    </div>
                    <MudText Typo="Typo.body2" Class="mt-2" Style="color: rgba(255,255,255,0.7);">@Explain(cell.Value)</MudText>
                </MudPaper>
            }

            @if (!Outbound().Any(c => c.Value != "-" && _enabled.Contains(c.Value)))
            {
                <MudPaper Class="rounded-xl border border-white/10 bg-black/20 p-3" Elevation="0">
                    <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.7);">No outbound links match your filters.</MudText>
                </MudPaper>
            }
        </div>
    }
</MudPaper>

@code {
    private Dhadgar.Scope.Services.CommMatrixData? _data;
    private string _selectedFrom = "Client";

    private readonly List<string> _kinds = new() { "HTTP", "WSS", "AMQP", "DB", "DNS", "OTHER" };
    private HashSet<string> _enabled = new(new[] { "HTTP", "WSS", "AMQP", "DB", "DNS", "OTHER" });

    protected override async Task OnInitializedAsync()
    {
        _data = await MatrixService.GetAsync();
        _selectedFrom = _data.Rows.FirstOrDefault()?.From ?? "Client";
    }

    private IEnumerable<Dhadgar.Scope.Services.CommMatrixCell> Outbound()
    {
        var row = _data?.Rows.FirstOrDefault(r => r.From == _selectedFrom);
        return (IEnumerable<Dhadgar.Scope.Services.CommMatrixCell>?)row?.Cells ?? Enumerable.Empty<Dhadgar.Scope.Services.CommMatrixCell>();
    }

    private void Toggle(string kind)
    {
        if (_enabled.Contains(kind)) _enabled.Remove(kind);
        else _enabled.Add(kind);
    }

    private static string GetFilterButtonStyle(bool enabled)
        => enabled
            ? "text-transform: none;"
            : "border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); text-transform: none;";

    private static string Explain(string kind) => kind switch
    {
        "HTTP" => "REST/JSON over HTTPS (gateway calls and service-to-service).",
        "WSS" => "WebSocket over TLS for streaming console sessions and real-time UX.",
        "AMQP" => "RabbitMQ message bus for async jobs and fan-out events.",
        "DB" => "Database traffic (Postgres/Redis/etc.) within the appropriate plane.",
        "DNS" => "DNS + certificate automation workflows (Cloudflare + ACME).",
        _ => "Other protocols (S3, UDP game traffic, etc.)."
    };
}
