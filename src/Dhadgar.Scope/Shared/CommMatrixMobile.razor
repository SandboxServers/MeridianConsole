@using System.Linq
@inject Dhadgar.Scope.Services.CommMatrixService MatrixService

<div class="md:hidden rounded-2xl border border-white/10 bg-white/5 p-4 mb-6">
    <div class="flex items-center justify-between gap-2">
        <div>
            <div class="text-lg font-bold text-white">Mobile matrix</div>
            <div class="text-sm text-white/70">Pick a source service to see outbound links.</div>
        </div>
        <div class="text-xs text-white/60 rounded-full bg-white/5 px-3 py-1">Option 2</div>
    </div>

    @if (_data is null)
    {
        <div class="mt-4 text-sm text-white/70">Loadingâ€¦</div>
    }
    else
    {
        <div class="mt-4">
            <label class="text-xs font-semibold text-white/60">From</label>
            <select class="mt-1 w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white"
                    @bind="_selectedFrom" style="color-scheme: dark;">
                @foreach (var r in _data.Rows)
                {
                    <option value="@r.From">@r.From</option>
                }
            </select>
        </div>

        <div class="mt-4 flex flex-wrap gap-2 text-xs">
            @foreach (var k in _kinds)
            {
                var enabled = _enabled.Contains(k);
                <button class="rounded-full px-3 py-1 border border-white/10 @(enabled ? "bg-indigo-500 text-white" : "bg-white/5 text-white/80 hover:bg-white/10")"
                        @onclick="() => Toggle(k)">
                    @k
                </button>
            }
        </div>

        <div class="mt-4 space-y-3">
            @foreach (var cell in Outbound().Where(c => c.Value != "-" && _enabled.Contains(c.Value)).OrderBy(c => c.To))
            {
                <div class="rounded-2xl border border-white/10 bg-black/20 p-4">
                    <div class="flex items-center justify-between gap-3">
                        <div class="text-base font-bold text-white">@cell.To</div>
                        <div class="rounded-full bg-indigo-500/20 px-3 py-1 text-xs font-semibold text-indigo-200">@cell.Value</div>
                    </div>
                    <div class="mt-2 text-sm text-white/70">@Explain(cell.Value)</div>
                </div>
            }

            @if (!Outbound().Any(c => c.Value != "-" && _enabled.Contains(c.Value)))
            {
                <div class="rounded-xl border border-white/10 bg-black/20 p-3 text-sm text-white/70">
                    No outbound links match your filters.
                </div>
            }
        </div>
    }
</div>

@code {
    private Dhadgar.Scope.Services.CommMatrixData? _data;
    private string _selectedFrom = "Client";

    private readonly List<string> _kinds = new() { "HTTP", "WSS", "AMQP", "DB", "DNS", "OTHER" };
    private HashSet<string> _enabled = new(new[] { "HTTP", "WSS", "AMQP", "DB", "DNS", "OTHER" });

    protected override async Task OnInitializedAsync()
    {
        _data = await MatrixService.GetAsync();
        _selectedFrom = _data.Rows.FirstOrDefault()?.From ?? "Client";
    }

    private IEnumerable<Dhadgar.Scope.Services.CommMatrixCell> Outbound()
    {
        var row = _data?.Rows.FirstOrDefault(r => r.From == _selectedFrom);
        return (IEnumerable<Dhadgar.Scope.Services.CommMatrixCell>?)row?.Cells ?? Enumerable.Empty<Dhadgar.Scope.Services.CommMatrixCell>();
    }

    private void Toggle(string kind)
    {
        if (_enabled.Contains(kind)) _enabled.Remove(kind);
        else _enabled.Add(kind);
    }

    private static string Explain(string kind) => kind switch
    {
        "HTTP" => "REST/JSON over HTTPS (gateway calls and service-to-service).",
        "WSS" => "WebSocket over TLS for streaming console sessions and real-time UX.",
        "AMQP" => "RabbitMQ message bus for async jobs and fan-out events.",
        "DB" => "Database traffic (Postgres/Redis/etc.) within the appropriate plane.",
        "DNS" => "DNS + certificate automation workflows (Cloudflare + ACME).",
        _ => "Other protocols (S3, UDP game traffic, etc.)."
    };
}
