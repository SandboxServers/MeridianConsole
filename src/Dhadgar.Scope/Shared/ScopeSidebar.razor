@using Dhadgar.Scope.Services
@inject ScopeContentService Scope

<div class="space-y-4">
    <MudPaper Class="rounded-2xl border border-white/10 bg-white/5 p-4" Elevation="0">
        <MudLink Href="/" Underline="Underline.None" Color="Color.Inherit" OnClick="HandleNavigate">
            <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.6);">Meridian Console</MudText>
            <MudText Typo="Typo.h6" Class="font-bold tracking-tight">Scope</MudText>
        </MudLink>

        <div class="mt-4 space-y-2">
            <MudButton Href="/dependencies"
                       Variant="Variant.Outlined"
                       FullWidth="true"
                       StartIcon="ðŸ•¸ï¸"
                       Style="border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); text-transform: none; justify-content: flex-start;"
                       Class="rounded-xl text-sm"
                       OnClick="HandleNavigate">
                Dependency Map
            </MudButton>

            <MudTextField @bind-Value="_filter"
                          Placeholder="Search sectionsâ€¦"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Class="rounded-xl text-sm text-white"
                          Immediate="true"
                          Style="border-radius: 0.75rem; background: rgba(0,0,0,0.3);" />
        </div>
    </MudPaper>

    <MudPaper Class="rounded-2xl border border-white/10 bg-white/5 p-2" Elevation="0">
        @if (_sections is null)
        {
            <div class="p-3 text-sm text-white/60">Loadingâ€¦</div>
        }
        else
        {
            <MudNavMenu Class="max-h-[70vh] overflow-auto">
                @foreach (var s in FilteredSections())
                {
                    <MudNavLink Href="@($"/s/{s.Slug}")"
                                OnClick="HandleNavigate"
                                Class="rounded-xl text-sm">
                        <span class="text-white/60">@(s.Number).</span>
                        <span class="ml-2">@s.Title</span>
                    </MudNavLink>
                }
            </MudNavMenu>
        }
    </MudPaper>

    <MudPaper Class="rounded-2xl border border-white/10 bg-white/5 p-4" Elevation="0">
        <MudText Typo="Typo.caption" Class="font-semibold" Style="color: rgba(255,255,255,0.7);">Hosting note</MudText>
        <MudText Typo="Typo.caption" Class="mt-2" Style="color: rgba(255,255,255,0.6);">
            This site publishes as static files (Blazor WebAssembly) and is designed to deploy cleanly to Azure Static Web Apps (Free tier).
        </MudText>
    </MudPaper>
</div>

@code {
    [Parameter] public EventCallback OnNavigate { get; set; }

    private IReadOnlyList<ScopeSectionInfo>? _sections;
    private string _filter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _sections = await Scope.GetSectionsAsync();
    }

    private IEnumerable<ScopeSectionInfo> FilteredSections()
    {
        if (_sections is null) return Array.Empty<ScopeSectionInfo>();

        var f = (_filter ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(f)) return _sections;

        return _sections.Where(s =>
            s.Title.Contains(f, StringComparison.OrdinalIgnoreCase) ||
            s.Slug.Contains(f, StringComparison.OrdinalIgnoreCase));
    }

    private Task HandleNavigate()
        => OnNavigate.HasDelegate ? OnNavigate.InvokeAsync() : Task.CompletedTask;
}
