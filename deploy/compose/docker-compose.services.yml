x-service-env: &service-env
  ASPNETCORE_ENVIRONMENT: Development
  ConnectionStrings__Postgres: Host=postgres;Port=5432;Database=dhadgar_platform;Username=dhadgar;Password=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
  ConnectionStrings__RabbitMqHost: rabbitmq
  RabbitMq__Username: dhadgar
  RabbitMq__Password: dhadgar

x-service-depends: &service-depends
  postgres:
    condition: service_healthy
  rabbitmq:
    condition: service_started

x-service-depends-redis: &service-depends-redis
  postgres:
    condition: service_healthy
  rabbitmq:
    condition: service_started
  redis:
    condition: service_started

services:
  gateway:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Gateway/Dockerfile
    environment:
      <<: *service-env
      ASPNETCORE_ENVIRONMENT: Development
      Auth__Issuer: https://dev.meridianconsole.com/api/v1/identity
      Auth__Audience: meridian-api
      ASPNETCORE_URLS: https://+:443;http://+:8080
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/dev.meridianconsole.com.pem
      ASPNETCORE_Kestrel__Certificates__Default__KeyPath: /https/dev.meridianconsole.com.key
      OpenIddict__DevClient__ClientId: dev-client
      OpenIddict__DevClient__ClientSecret: dev-secret
      OpenTelemetry__OtlpEndpoint: http://otel-collector:4317
      ReverseProxy__Clusters__betterauth__Destinations__d1__Address: http://betterauth:8080/
      ReverseProxy__Clusters__identity__Destinations__d1__Address: http://identity:8080/
      ReverseProxy__Clusters__billing__Destinations__d1__Address: http://billing:8080/
      ReverseProxy__Clusters__servers__Destinations__d1__Address: http://servers:8080/
      ReverseProxy__Clusters__nodes__Destinations__d1__Address: http://nodes:8080/
      ReverseProxy__Clusters__tasks__Destinations__d1__Address: http://tasks:8080/
      ReverseProxy__Clusters__files__Destinations__d1__Address: http://files:8080/
      ReverseProxy__Clusters__console__Destinations__d1__Address: http://console:8080/
      ReverseProxy__Clusters__mods__Destinations__d1__Address: http://mods:8080/
      ReverseProxy__Clusters__notifications__Destinations__d1__Address: http://notifications:8080/
      ReverseProxy__Clusters__firewall__Destinations__d1__Address: http://firewall:8080/
      ReverseProxy__Clusters__secrets__Destinations__d1__Address: http://secrets:8080/
      ReverseProxy__Clusters__discord__Destinations__d1__Address: http://discord:8080/
    ports:
      - "443:443"
      - "5000:8080"
    volumes:
      - ../certs:/https:ro
    depends_on: *service-depends
    restart: unless-stopped

  identity:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Identity/Dockerfile
    environment:
      <<: *service-env
      Auth__Issuer: https://dev.meridianconsole.com/api/v1/identity
      Auth__Audience: meridian-api
      Redis__ConnectionString: redis:6379,password=dhadgar
      Auth__UseDevelopmentCertificates: ${AUTH_USE_DEV_CERTS:-true}
      Auth__KeyVault__VaultUri: ${AUTH_KEYVAULT_URI:-}
      Auth__KeyVault__SigningCertName: ${AUTH_KEYVAULT_SIGNING_CERT_NAME:-}
      Auth__KeyVault__EncryptionCertName: ${AUTH_KEYVAULT_ENCRYPTION_CERT_NAME:-}
      AZURE_TENANT_ID: ${AZURE_TENANT_ID:-}
      AZURE_CLIENT_ID: ${AZURE_CLIENT_ID:-}
      AZURE_CLIENT_SECRET: ${AZURE_CLIENT_SECRET:-}
      SecretsService__Url: http://secrets:8080
      OpenIddict__DevClient__ClientId: dev-client
      OpenIddict__DevClient__ClientSecret: dev-secret
      OpenIddict__Wif__Audience: ${OPENIDDICT_WIF_AUDIENCE:-api://AzureADTokenExchange}
      OpenTelemetry__OtlpEndpoint: http://otel-collector:4317
      Database__AutoMigrate: "true"
      # Exchange token validation (for BetterAuth token exchange)
      Auth__Exchange__Issuer: https://dev.meridianconsole.com/api/v1/betterauth
      Auth__Exchange__Audience: https://dev.meridianconsole.com/api/v1/identity/exchange
      Auth__Exchange__PublicKeyPem: ${BETTERAUTH_EXCHANGE_PUBLIC_KEY:-}
    ports:
      - "5010:8080"
    depends_on: *service-depends-redis
    restart: unless-stopped

  billing:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Billing/Dockerfile
    environment: *service-env
    ports:
      - "5020:8080"
    depends_on: *service-depends
    restart: unless-stopped

  servers:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Servers/Dockerfile
    environment: *service-env
    ports:
      - "5030:8080"
    depends_on: *service-depends
    restart: unless-stopped

  nodes:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Nodes/Dockerfile
    environment: *service-env
    ports:
      - "5040:8080"
    depends_on: *service-depends
    restart: unless-stopped

  tasks:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Tasks/Dockerfile
    environment: *service-env
    ports:
      - "5050:8080"
    depends_on: *service-depends
    restart: unless-stopped

  files:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Files/Dockerfile
    environment: *service-env
    ports:
      - "5060:8080"
    depends_on: *service-depends
    restart: unless-stopped

  console:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Console/Dockerfile
    environment: *service-env
    ports:
      - "5070:8080"
    depends_on: *service-depends
    restart: unless-stopped

  mods:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Mods/Dockerfile
    environment: *service-env
    ports:
      - "5080:8080"
    depends_on: *service-depends
    restart: unless-stopped

  notifications:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Notifications/Dockerfile
    environment: *service-env
    ports:
      - "5090:8080"
    depends_on: *service-depends
    restart: unless-stopped

  firewall:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Firewall/Dockerfile
    environment: *service-env
    ports:
      - "5100:8080"
    depends_on: *service-depends
    restart: unless-stopped

  secrets:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Secrets/Dockerfile
    environment:
      <<: *service-env
      ASPNETCORE_ENVIRONMENT: Development
      Auth__Issuer: https://dev.meridianconsole.com/api/v1/identity/
      Auth__Audience: meridian-api
      Auth__MetadataAddress: http://identity:8080/.well-known/openid-configuration
      Auth__InternalBaseUrl: http://identity:8080
      # Azure credentials for Key Vault access
      AZURE_TENANT_ID: ${AZURE_TENANT_ID:-}
      AZURE_CLIENT_ID: ${AZURE_CLIENT_ID:-}
      AZURE_CLIENT_SECRET: ${AZURE_CLIENT_SECRET:-}
      # Set to "false" to use Key Vault instead of development secrets
      Secrets__UseDevelopmentProvider: ${SECRETS_USE_DEV_PROVIDER:-false}
      Secrets__KeyVaultUri: ${SECRETS_KEYVAULT_URI:-https://mc-oauth.vault.azure.net/}
      # WIF configuration for Key Vault access (no client secret needed!)
      # The Secrets service app registration in Azure AD must have a federated credential
      # configured to trust tokens from the Identity service issuer with:
      #   - Issuer: https://dev.meridianconsole.com/api/v1/identity
      #   - Subject: secrets-service (the client_id)
      #   - Audience: The configured WIF audience
      Secrets__Wif__TenantId: ${SECRETS_WIF_TENANT_ID:-57eb34d8-1e4d-43d5-8d05-7292e5212ac2}
      Secrets__Wif__ClientId: ${SECRETS_WIF_CLIENT_ID:-af1cc0af-c6d0-4f1c-b4cd-cddbc24c8100}
      Secrets__Wif__IdentityTokenEndpoint: http://identity:8080/connect/token
      # Dedicated service account for Secrets service (seeded by Identity)
      Secrets__Wif__ServiceClientId: secrets-service
      Secrets__Wif__ServiceClientSecret: ${SECRETS_SERVICE_CLIENT_SECRET:-secrets-service-dev-secret-change-in-prod}
      # Development secrets for local testing (only used when UseDevelopmentProvider=true)
      Secrets__Development__Secrets__betterauth-secret: ${BETTERAUTH_SECRET:-dev-betterauth-secret-change-in-prod-32chars!}
      Secrets__Development__Secrets__betterauth-exchange-private-key: ${BETTERAUTH_EXCHANGE_PRIVATE_KEY:-}
      Secrets__Development__Secrets__postgres-password: dhadgar
      Secrets__Development__Secrets__oauth-discord-client-id: ${OAUTH_DISCORD_CLIENT_ID:-}
      Secrets__Development__Secrets__oauth-discord-client-secret: ${OAUTH_DISCORD_CLIENT_SECRET:-}
      OpenTelemetry__OtlpEndpoint: http://otel-collector:4317
    ports:
      - "5110:8080"
    depends_on: *service-depends
    restart: unless-stopped

  discord:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Discord/Dockerfile
    environment: *service-env
    ports:
      - "5120:8080"
    depends_on: *service-depends
    restart: unless-stopped

  betterauth:
    build:
      context: ../..
      dockerfile: src/Dhadgar.BetterAuth/Dockerfile
    environment:
      NODE_ENV: production
      PORT: 8080
      SECRETS_SERVICE_URL: http://secrets:8080
      IDENTITY_SERVICE_URL: http://identity:8080
      # Dedicated service account for BetterAuth (seeded by Identity)
      SERVICE_CLIENT_ID: betterauth-service
      SERVICE_CLIENT_SECRET: ${BETTERAUTH_SERVICE_CLIENT_SECRET:-betterauth-service-dev-secret-change-in-prod}
      BETTER_AUTH_URL: https://dev.meridianconsole.com/api/v1/betterauth
      BETTER_AUTH_TRUSTED_ORIGINS: https://dev.meridianconsole.com,https://cart.meridianconsole.com,https://panel.meridianconsole.com,http://localhost:4321,http://localhost:4322
      BETTER_AUTH_CLIENT_APPS: panel,shop
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: dhadgar_platform
      POSTGRES_USERNAME: dhadgar
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      EXCHANGE_TOKEN_AUDIENCE: https://dev.meridianconsole.com/api/v1/identity/exchange
      EXCHANGE_TOKEN_ISSUER: https://dev.meridianconsole.com/api/v1/betterauth
      EXCHANGE_TOKEN_KID: betterauth-exchange-v1
    ports:
      - "5130:8080"
    depends_on:
      postgres:
        condition: service_healthy
      identity:
        condition: service_healthy
      secrets:
        condition: service_started
    restart: unless-stopped

  panel:
    build:
      context: ../..
      dockerfile: src/Dhadgar.Panel/Dockerfile
      args:
        PUBLIC_GATEWAY_URL: https://dev.meridianconsole.com
        PUBLIC_BETTER_AUTH_URL: https://dev.meridianconsole.com/api/v1/betterauth
    environment:
      NODE_ENV: production
      HOST: 0.0.0.0
      PORT: 8080
    ports:
      - "4321:8080"
    depends_on:
      - gateway
    restart: unless-stopped

  shoppingcart:
    build:
      context: ../..
      dockerfile: src/Dhadgar.ShoppingCart/Dockerfile
      args:
        PUBLIC_GATEWAY_URL: https://dev.meridianconsole.com
        PUBLIC_BETTER_AUTH_URL: https://dev.meridianconsole.com/api/v1/betterauth
    ports:
      - "4322:8080"
    depends_on:
      - gateway
    restart: unless-stopped
