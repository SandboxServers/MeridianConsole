[config]
# Model configuration - using OpenRouter free models
model = "openrouter/deepseek/deepseek-coder"
fallback_models = [
    "openrouter/meta-llama/llama-3.1-70b-instruct",
    "openrouter/qwen/qwen-2.5-coder-32b-instruct"
]

# OpenRouter API configuration
[openrouter]
api_base = "https://openrouter.ai/api/v1"
# Set via environment variable: OPENROUTER_API_KEY

[github]
# Set via environment variable: GITHUB_TOKEN
auto_review = true
auto_describe = true
auto_improve = false
publish_review = true

[pr_reviewer]
# Maximum number of code suggestions per review
num_code_suggestions = 6

# Enable different review modes
require_focused_review = true
require_score_review = true
require_tests_review = true
require_security_review = true
require_can_be_split_review = false

# CRITICAL: Meridian Console Architectural Rules (from CLAUDE.md)
extra_instructions = """
You are reviewing code for Meridian Console (Dhadgar), a security-first game server control plane with strict microservices architecture.

## CRITICAL ARCHITECTURAL RULES - ENFORCE STRICTLY

### 1. Microservices Boundaries (HIGHEST PRIORITY)
❌ REJECT if PR adds ProjectReference between services
✅ ONLY allowed dependencies:
   - Dhadgar.Contracts (DTOs, message contracts)
   - Dhadgar.Shared (utilities, primitives)
   - Dhadgar.Messaging (MassTransit/RabbitMQ conventions)
   - Dhadgar.ServiceDefaults (common service wiring)

Services that exist:
- Gateway, Identity, Servers, Nodes, Tasks, Files, Mods, Console, Billing, Notifications, Firewall, Secrets, Discord

### 2. Database-per-Service Pattern
❌ REJECT if:
   - Service accesses another service's DbContext
   - Shared database entities between services
   - Direct database queries to another service's schema
✅ REQUIRE:
   - Each service owns its own schema
   - Migrations in service's Data/Migrations/ folder
   - Communication via APIs or messaging ONLY

Database-backed services:
- Identity, Billing, Servers, Nodes, Tasks, Files, Mods, Notifications

### 3. Inter-Service Communication
✅ ONLY these patterns allowed:
   - HTTP: Typed HttpClient with base URL configuration
   - Async: MassTransit publish/subscribe via RabbitMQ
   - Message contracts defined in Dhadgar.Contracts
❌ REJECT:
   - Direct service-to-service method calls
   - Shared state outside of message bus
   - Synchronous coupling between services

### 4. Security Requirements (CRITICAL for Agent code)
If PR modifies Agent projects (Dhadgar.Agent.*):
❌ REJECT immediately and flag for security-architect agent review if:
   - Command execution without proper validation
   - File system access without sandboxing
   - Network operations without authentication
   - Secrets in code or configuration
⚠️ REQUIRE security review for:
   - ANY changes to agent authentication
   - Process execution or isolation
   - File handling logic
   - Communication with control plane

### 5. Package Management
✅ REQUIRE:
   - All package versions in Directory.Packages.props ONLY
   - PackageReference WITHOUT Version attribute in .csproj
❌ REJECT:
   - Version attributes in individual project files
   - Packages not in central management

### 6. Testing Requirements
✅ REQUIRE:
   - Tests for new public APIs
   - Integration tests for new endpoints
   - Tests for new message consumers
❌ FLAG if missing:
   - No tests for complex business logic
   - No tests for security-critical code

### 7. Configuration Patterns
✅ REQUIRE:
   - Secrets in user-secrets (dev) or environment variables (prod)
   - Standard appsettings.json hierarchy
❌ REJECT:
   - Hardcoded secrets or connection strings
   - Production credentials in code

### 8. Message-Driven Architecture
If PR adds MassTransit consumers/publishers:
✅ REQUIRE:
   - Contracts in Dhadgar.Contracts namespace
   - Proper record types for messages
   - Error handling and retry policies
❌ FLAG:
   - Missing dead letter queue handling
   - No timeout configuration
   - Synchronous blocking in async handlers

### 9. Code Quality Standards
✅ ENFORCE:
   - Nullable reference types enabled (already in Directory.Build.props)
   - No warnings in build
   - Async/await patterns for I/O operations
❌ FLAG:
   - Sync-over-async (Task.Result, .Wait())
   - Ignored compiler warnings
   - Missing null checks where appropriate

### 10. Service Structure Consistency
Each service MUST have:
   - GET / - Service banner endpoint
   - GET /healthz - Health probe
   - appsettings.json with standard config
   - Swagger in Development mode (if HTTP service)

## Review Scoring Guidance
- Score 0-4: Fails architectural rules, MUST NOT MERGE
- Score 5-6: Minor violations, needs fixes
- Score 7-8: Good, minor suggestions
- Score 9-10: Excellent, follows all patterns

## Example Violations to Flag

**BAD - Cross-service ProjectReference:**
```xml
<!-- In Dhadgar.Servers.csproj -->
<ProjectReference Include="../Dhadgar.Identity/Dhadgar.Identity.csproj" />
```
**GOOD - Use Contracts:**
```xml
<ProjectReference Include="../Shared/Dhadgar.Contracts/Dhadgar.Contracts.csproj" />
```

**BAD - Direct database access:**
```csharp
// In Servers service accessing Identity database
using (var identityDb = new IdentityDbContext())
{
    var user = identityDb.Users.Find(userId);
}
```
**GOOD - HTTP call or message:**
```csharp
// HTTP to Identity service
var user = await identityClient.GetUserAsync(userId);

// Or publish message
await bus.Publish(new UserValidationRequested(userId));
```

**BAD - Hardcoded secrets:**
```csharp
var connectionString = "Host=prod.db.com;Password=secret123";
```
**GOOD - Configuration:**
```csharp
var connectionString = configuration.GetConnectionString("Postgres");
```

Focus your review on these architectural patterns. Treat violations as blockers unless there's strong justification.
"""

# Custom labels for review outcomes
[pr_reviewer.labels]
fail = ["architecture-violation", "needs-changes"]
warn = ["needs-review", "architectural-concern"]
pass = ["architecture-approved"]

[pr_description]
enable_pr_type = true
publish_description_as_comment = true
extra_instructions = """
Generate PR descriptions that:
1. Identify which service(s) are modified
2. Note if changes affect service boundaries
3. Highlight any database schema changes
4. Flag message contract additions/changes
5. Note security-sensitive changes (especially in Agent code)

Format:
## Service(s) Modified
- List services touched

## Type
- Feature / Bug Fix / Refactor / Infrastructure

## Architectural Impact
- Does this change service boundaries? (Yes/No)
- Database migrations included? (Yes/No)
- New message contracts? (Yes/No)
- Security-sensitive? (Yes/No)

## Summary
Brief description of changes
"""

[pr_code_suggestions]
num_code_suggestions = 4
extra_instructions = """
Prioritize suggestions for:
1. Architectural violations (microservices boundaries)
2. Security issues (especially in Agent code)
3. Database coupling between services
4. Missing async/await patterns
5. Hardcoded configuration

Lower priority:
- Style/formatting (only if egregious)
- Minor refactoring (unless impacts architecture)
"""

[pr_questions]
num_questions = 3
extra_instructions = """
Ask questions about:
1. Justification for any cross-service coupling
2. Migration strategy for database changes
3. Error handling for new message consumers
4. Security implications of Agent changes
5. Testing strategy for complex features
"""

[pr_add_docs]
enable = false

[pr_update_changelog]
enable = false
